datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
  url      = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model School {
  id                     String                  @id @default(uuid()) @db.Uuid
  name                   String
  domain                 String                  @unique
  schoolCode             String                  @unique
  profilePicture         String
  location               String
  contactNumber          String
  websiteConfig          Json?
  SubscriptionType       String
  Language               String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  deletedAt              DateTime?
  AcademicYear           AcademicYear[]
  admins                 Admin[]
  classes                Class[]
  attendanceDelegations  AttendanceDelegation[]
  exams                  Exam[]
  examHalls              ExamHall[]
  FeePayment             FeePayment[]
  FeeStructure           FeeStructure[]
  galleries              Gallery[]
  InventoryItem          InventoryItem[]
  libraryBooks           LibraryBook[]
  libraryBookRequests    LibraryBookRequest[]
  MasterAdmin            MasterAdmin?
  NonTeachingStaff       NonTeachingStaff[]
  Notice                 Notice[]
  Student                Student[]
  StudentFeeStructure    StudentFeeStructure[]
  Syllabus               Syllabus[]
  TeachingStaff          TeachingStaff[]
  // Transport           Transport[]
  users                  User[]
  Vehicle                Vehicle[]
  Route                  Route[]
  Assignment             Assignment[]
  Form                   Form[]
  Application            Application[]
  Stage                  Stage[]
  Upload                 Upload[]
  CertificateTemplate    CertificateTemplate[]
  CertificateGenerated   CertificateGenerated[]
  DigitalIdCard          DigitalIdCard[]
  AdmitCard              AdmitCard[]
  QrVerificationSettings QrVerificationSettings?
  PdfExportSettings      PdfExportSettings?
  Signature              Signature[]
  Stamp                  Stamp[]
  DocumentTemplate       DocumentTemplate[]
  globalFeeStructures    GlobalFeeStructure[]
  studentFees            StudentFee[]
  parents                Parent[]
  calendarEvents         CalendarEvent[]

  attendance              Attendance[]
  attendanceConfig        AttendanceConfig?
  schoolCalendar          SchoolCalendar[]
  leaveRequests           LeaveRequest[]
  leaveBalances           LeaveBalance[]
  attendanceStats         AttendanceStats[]
  bulkAttendance          BulkAttendance[]
  attendanceNotifications AttendanceNotification[]
  homework                Homework[]
  partnerSchools          PartnerSchool[]
  timeSlots               TimeSlot[]
  timetableEntries        TimetableEntry[]
  timetableTemplates      TimetableTemplate[]
  mediaLibraries          MediaLibrary[]
  teacherShifts           TeacherShift[]
  alumni                  Alumni[]
  inventoryCategories     InventoryCategory[]
  inventorySales          InventorySale[]

  @@index([name])
}

// ============================================
// CHANNEL PARTNER PROGRAM SYSTEM
// ============================================

// Partner Roles
enum PartnerRole {
  AFFILIATE
  RESELLER
  ENTERPRISE
}

// Partner Levels
enum PartnerLevel {
  SILVER
  GOLD
  PLATINUM
}

// Partner Status
enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

// Lead Status
enum LeadStatus {
  NEW
  IN_PROGRESS
  DEMO_SCHEDULED
  CONVERTED
  REJECTED
}

// Payout Status
enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Commission Type
enum CommissionType {
  ONBOARDING
  RENEWAL
  UPGRADE
  BONUS
}

// Main Partner Model
model Partner {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Partner Details
  role   PartnerRole   @default(AFFILIATE)
  level  PartnerLevel  @default(SILVER)
  status PartnerStatus @default(PENDING)

  // Business Information
  companyName  String?
  businessType String?
  gstin        String? @unique
  panNumber    String? @unique

  // Contact Information
  contactPerson  String
  contactEmail   String  @unique
  contactPhone   String
  alternatePhone String?
  address        String
  city           String
  state          String
  country        String  @default("India")
  postalCode     String

  // Commission Configuration
  commissionRate Float @default(10) // Percentage
  renewalRate    Float @default(5) // Percentage

  // Referral Information
  referralCode String  @unique
  referralLink String
  qrCodeUrl    String?

  // Account Manager
  accountManagerId String? @db.Uuid
  accountManager   User?   @relation("PartnerAccountManager", fields: [accountManagerId], references: [id])

  // KYC & Banking
  kycStatus     String  @default("PENDING") // PENDING, VERIFIED, REJECTED
  kycDocuments  Json? // Array of document URLs
  bankName      String?
  accountNumber String?
  ifscCode      String?
  accountHolder String?
  upiId         String?

  // Statistics
  totalLeads      Int   @default(0)
  convertedLeads  Int   @default(0)
  totalRevenue    Float @default(0)
  totalCommission Float @default(0)

  // Approval Details
  approvedBy     String?   @db.Uuid
  approvedAt     DateTime?
  rejectedReason String?

  // System Fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  leads       PartnerLead[]
  schools     PartnerSchool[]
  commissions PartnerCommission[]
  payouts     PartnerPayout[]
  activities  PartnerActivity[]

  @@index([userId])
  @@index([status])
  @@index([level])
  @@index([referralCode])
  @@index([contactEmail])
}

// Partner Leads Management
model PartnerLead {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Lead Information
  schoolName     String
  contactPerson  String
  contactPhone   String
  contactEmail   String
  alternatePhone String?
  address        String?
  city           String?
  state          String?
  postalCode     String?

  // Lead Details
  estimatedStudents Int?
  currentSystem     String?
  notes             String? @db.Text

  // Status & Assignment
  status       LeadStatus @default(NEW)
  assignedToId String?    @db.Uuid
  assignedTo   User?      @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  // Conversion Details
  convertedAt       DateTime?
  convertedSchoolId String?   @db.Uuid
  rejectedReason    String?

  // Follow-up
  lastFollowUp    DateTime?
  nextFollowUp    DateTime?
  demoScheduledAt DateTime?

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activities LeadActivity[]

  @@index([partnerId])
  @@index([status])
  @@index([contactEmail])
  @@index([assignedToId])
}

// Lead Activity Log
model LeadActivity {
  id     String      @id @default(uuid()) @db.Uuid
  leadId String      @db.Uuid
  lead   PartnerLead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  activityType String // STATUS_CHANGE, FOLLOW_UP, DEMO, NOTES
  description  String  @db.Text
  oldStatus    String?
  newStatus    String?
  performedBy  String? @db.Uuid

  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
}

// Partner-School Relationship
model PartnerSchool {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  schoolId  String  @db.Uuid
  school    School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Onboarding Details
  onboardedAt      DateTime @default(now())
  subscriptionPlan String
  planStartDate    DateTime
  planEndDate      DateTime
  renewalDate      DateTime

  // Revenue & Commission
  subscriptionAmount Float
  commissionRate     Float
  commissionAmount   Float

  // Status
  isActive     Boolean @default(true)
  renewalCount Int     @default(0)

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, schoolId])
  @@index([partnerId])
  @@index([schoolId])
  @@index([renewalDate])
}

// Commission Management
model PartnerCommission {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Commission Details
  type       CommissionType @default(ONBOARDING)
  schoolId   String?        @db.Uuid
  schoolName String

  // Amounts
  revenueAmount    Float
  commissionRate   Float
  commissionAmount Float

  // Status
  isPaid   Boolean        @default(false)
  paidAt   DateTime?
  payoutId String?        @db.Uuid
  payout   PartnerPayout? @relation(fields: [payoutId], references: [id])

  // Period
  periodMonth Int
  periodYear  Int

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([partnerId])
  @@index([isPaid])
  @@index([periodMonth, periodYear])
}

// Payout Management
model PartnerPayout {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Payout Details
  amount        Float
  commissionIds String[] // Array of commission IDs

  // Payment Information
  paymentMethod   String // BANK_TRANSFER, UPI, CHEQUE
  transactionId   String?
  referenceNumber String?
  utrNumber       String?

  // Status
  status       PayoutStatus @default(PENDING)
  requestedAt  DateTime     @default(now())
  processedAt  DateTime?
  completedAt  DateTime?
  failedReason String?

  // Processed By
  processedBy String? @db.Uuid

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  commissions PartnerCommission[]

  @@index([partnerId])
  @@index([status])
  @@index([requestedAt])
}

// Marketing Assets
model MarketingAsset {
  id String @id @default(uuid()) @db.Uuid

  // Asset Details
  title       String
  description String? @db.Text
  type        String // PITCH_DECK, BROCHURE, PRICING, VIDEO, IMAGE
  category    String? // SALES, MARKETING, TRAINING

  // File Information
  fileUrl      String
  fileName     String
  fileSize     Int?
  mimeType     String?
  thumbnailUrl String?

  // Access Control
  isActive      Boolean  @default(true)
  partnerLevels String[] // ["SILVER", "GOLD", "PLATINUM"]

  // Metadata
  downloadCount Int     @default(0)
  version       String? @default("1.0")

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([isActive])
}

// Partner Activity Log
model PartnerActivity {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  activityType String // LOGIN, LEAD_ADDED, PAYOUT_REQUEST, PROFILE_UPDATE
  description  String  @db.Text
  metadata     Json?
  ipAddress    String?

  createdAt DateTime @default(now())

  @@index([partnerId])
  @@index([createdAt])
}

// Commission Slabs Configuration
model CommissionSlab {
  id String @id @default(uuid()) @db.Uuid

  // Slab Details
  name       String
  level      PartnerLevel
  minRevenue Float        @default(0)
  maxRevenue Float?

  // Rates
  onboardingRate Float // Percentage
  renewalRate    Float // Percentage
  upgradeRate    Float // Percentage

  // Conditions
  minSchools Int     @default(0)
  isActive   Boolean @default(true)

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([level])
  @@index([isActive])
}

// Global Form Builder
enum FormCategory {
  ADMISSION
  SURVEY
  FEEDBACK
  GENERAL
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Form {
  id          String       @id @default(uuid()) @db.Uuid
  schoolId    String       @db.Uuid
  title       String
  description String?
  slug        String?      @unique
  category    FormCategory @default(GENERAL)
  status      FormStatus   @default(DRAFT)
  settings    Json? // { isPublic: boolean, allowMultiple: boolean, notifications: [] }
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  fields       FormField[]
  applications Application[] // Submissions

  @@index([schoolId])
  @@index([slug])
  @@index([category])
}

model FormField {
  id       String  @id @default(uuid()) @db.Uuid
  formId   String  @db.Uuid
  name     String
  type     String // e.g., "text", "email", "file", "select"
  required Boolean @default(false)
  options  Json? // for select fields
  order    Int

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
}

model Application {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  formId         String   @db.Uuid
  applicantName  String
  applicantEmail String
  data           Json
  submittedAt    DateTime @default(now())
  currentStageId String?  @db.Uuid // Optional for non-admission forms
  createdById    String?  @db.Uuid

  school       School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  form         Form                  @relation(fields: [formId], references: [id], onDelete: Cascade)
  currentStage Stage?                @relation("CurrentStage", fields: [currentStageId], references: [id])
  createdBy    User?                 @relation(fields: [createdById], references: [id])
  documents    ApplicationDocument[]
  stageHistory StageHistory[]
  payments     Payment[]

  @@unique([schoolId, formId, applicantEmail])
}

model ApplicationDocument {
  id            String      @id @default(uuid()) @db.Uuid
  applicationId String      @db.Uuid
  fileUrl       String
  fileName      String
  mimeType      String
  size          Int
  uploadedAt    DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model Stage {
  id                String  @id @default(uuid()) @db.Uuid
  schoolId          String  @db.Uuid // Made required
  name              String // Changed from Enum to String
  type              String  @default("CUSTOM") // SYSTEM or CUSTOM
  order             Int
  requiresTest      Boolean @default(false)
  requiresInterview Boolean @default(false)
  feeRequired       Boolean @default(false)

  currentApplications Application[]  @relation("CurrentStage")
  stageHistory        StageHistory[]
  School              School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@unique([schoolId, order])
  @@index([schoolId])
}

model StageHistory {
  id            String   @id @default(uuid()) @db.Uuid
  applicationId String   @db.Uuid
  stageId       String   @db.Uuid
  movedById     String?  @db.Uuid
  movedAt       DateTime @default(now())
  notes         String?

  // Stage-specific fields
  testPassed    Boolean?
  testScore     Float?
  testDate      DateTime?
  interviewDate DateTime?
  testStartTime DateTime?
  testEndTime   DateTime?
  testVenue     String?

  interviewNotes String?

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stage       Stage       @relation(fields: [stageId], references: [id])
  movedBy     User?       @relation(fields: [movedById], references: [id])

  @@index([applicationId])
  @@index([movedAt])
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  applicationId String?       @db.Uuid
  amount        Float
  status        PaymentStatus @default(PENDING)
  transactionId String?
  paidAt        DateTime?
  application   Application?  @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
}

// Note: Use PostgreSQL provider as in current schema.
// Transport Models
model Vehicle {
  id             String            @id @default(uuid()) @db.Uuid
  schoolId       String            @db.Uuid
  licensePlate   String            @unique
  model          String
  capacity       Int
  maintenanceDue DateTime?
  status         String // e.g., "active", "maintenance", "inactive"
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id])
  routes         Route[]
  locations      VehicleLocation[]

  @@index([schoolId])
  @@index([licensePlate])
}

model Route {
  id                 String                   @id @default(uuid()) @db.Uuid
  schoolId           String                   @db.Uuid
  name               String
  stops              Json // Array of {name: string, lat: float, lng: float}
  assignedVehicleId  String?                  @db.Uuid
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  school             School                   @relation(fields: [schoolId], references: [id])
  vehicle            Vehicle?                 @relation(fields: [assignedVehicleId], references: [id])
  studentAssignments StudentRouteAssignment[]

  @@index([schoolId])
  @@index([name])
}

model StudentRouteAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @db.Uuid
  routeId    String   @db.Uuid
  schoolId   String   @db.Uuid
  assignedAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [userId])
  route      Route    @relation(fields: [routeId], references: [id])

  @@index([studentId])
  @@index([routeId])
}

model VehicleLocation {
  id        String   @id @default(uuid()) @db.Uuid
  vehicleId String   @db.Uuid
  latitude  Float
  longitude Float
  timestamp DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([timestamp])
}

model Assignment {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  classId     Int
  title       String
  description String?
  dueDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  school      School   @relation(fields: [schoolId], references: [id])
  class       Class    @relation(fields: [classId], references: [id])

  @@index([schoolId])
  @@index([classId])
  @@index([dueDate])
}

model InventoryItem {
  id              String   @id @default(uuid())
  name            String
  category        String? // Optional for backward compatibility, prefer categoryId
  categoryId      String?  @db.Uuid
  schoolId        String   @db.Uuid
  description     String?
  quantity        Int
  minimumQuantity Int
  maximumQuantity Int
  unit            String
  purchaseDate    DateTime
  costPerUnit     Float
  sellingPrice    Float?   @default(0)
  isSellable      Boolean  @default(false)
  vendorName      String
  vendorContact   String
  warrantyPeriod  String?
  location        String
  status          String
  barcode         String?
  notes           String?

  School            School                 @relation(fields: [schoolId], references: [id])
  InventoryCategory InventoryCategory?     @relation(fields: [categoryId], references: [id])
  transactions      InventoryTransaction[]
  purchaseOrders    PurchaseOrderItem[]
  saleItems         InventorySaleItem[]
}

model InventoryCategory {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items  InventoryItem[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model InventorySale {
  id            String   @id @default(uuid()) @db.Uuid
  schoolId      String   @db.Uuid
  buyerName     String
  buyerId       String?  @db.Uuid // Optional link to User/Student
  buyerType     String? // STUDENT, STAFF, EXTERNAL
  totalAmount   Float
  paymentMethod String // CASH, ONLINE, ETC
  status        String // COMPLETED, REFUNDED
  saleDate      DateTime @default(now())

  school School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items  InventorySaleItem[]

  @@index([schoolId])
  @@index([saleDate])
}

model InventorySaleItem {
  id         String @id @default(uuid()) @db.Uuid
  saleId     String @db.Uuid
  itemId     String
  quantity   Int
  unitPrice  Float
  totalPrice Float

  sale InventorySale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  item InventoryItem @relation(fields: [itemId], references: [id])
}

model Syllabus {
  id             String        @id @default(uuid())
  academicYearId String?       @db.Uuid
  filename       String
  fileUrl        String
  uploadedAt     DateTime      @default(now())
  schoolId       String        @db.Uuid
  classId        Int?
  AcademicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  Class          Class?        @relation(fields: [classId], references: [id])
  School         School        @relation(fields: [schoolId], references: [id])
}

model InventoryTransaction {
  id              String        @id @default(uuid())
  itemId          String
  transactionType String
  quantity        Int
  date            DateTime
  issuedToId      String?
  issuedToName    String?
  handledById     String
  handledByName   String
  remarks         String?
  status          String
  item            InventoryItem @relation(fields: [itemId], references: [id])
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  orderDate        DateTime
  expectedDelivery DateTime
  vendorName       String
  vendorContact    String
  approvedById     String
  approvedByName   String
  status           String
  items            PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  itemId          String
  name            String
  quantity        Int
  costPerUnit     Float
  item            InventoryItem @relation(fields: [itemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
}

model Notice {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Basic Info
  title       String
  description String  @db.Text // Changed to Text for long content
  subtitle    String? // NEW: For preview text

  // File Management
  fileUrl     String?
  attachments Json? // NEW: Array of multiple attachments

  // Categorization
  category NoticeCategory // NEW: Enum instead of String
  audience Audience       @default(ALL)
  priority Priority       @default(NORMAL)
  status   Status         @default(DRAFT)

  // Author Info
  createdById String? @db.Uuid
  issuedBy    String? // NEW: Display name
  issuerRole  String? // NEW: "Science Department Head"

  // Dates & Times
  publishedAt DateTime?
  expiryDate  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt

  // Important Dates (for trips, deadlines, etc.)
  importantDates Json? // NEW: [{label: string, value: string}]

  // Read Status Tracking
  viewCount Int @default(0) // NEW: Track views

  // Relations
  Author       User?          @relation(fields: [createdById], references: [id])
  School       School         @relation(fields: [schoolId], references: [id])
  NoticeTarget NoticeTarget[]
  NoticeReads  NoticeRead[] // NEW: Track who read it

  @@index([schoolId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([publishedAt])
  @@index([expiryDate])
}

model NoticeTarget {
  id       String @id @default(uuid()) @db.Uuid
  noticeId String @db.Uuid

  // Targeting Options
  classId   Int?
  sectionId Int?
  roleId    Int? // NEW: Target specific roles
  userId    String? @db.Uuid // NEW: Target specific users

  Class   Class?   @relation(fields: [classId], references: [id])
  Notice  Notice   @relation(fields: [noticeId], references: [id])
  Section Section? @relation(fields: [sectionId], references: [id])
  Role    Role?    @relation(fields: [roleId], references: [id]) // NEW
  User    User?    @relation("NoticeTargetUser", fields: [userId], references: [id]) // NEW

  @@index([noticeId])
  @@index([classId])
  @@index([sectionId])
  @@index([roleId])
  @@index([userId])
}

// NEW: Track read status for each user
model NoticeRead {
  id       String   @id @default(uuid()) @db.Uuid
  noticeId String   @db.Uuid
  userId   String   @db.Uuid
  readAt   DateTime @default(now())

  Notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  User   User   @relation("NoticeReads", fields: [userId], references: [id])

  @@unique([noticeId, userId])
  @@index([noticeId])
  @@index([userId])
  @@index([readAt])
}

// Enhanced Enums
enum NoticeCategory {
  GENERAL
  ACADEMIC
  EXAM
  EMERGENCY
  EVENT
  SPORTS
  HOLIDAY
  FEE
  TRANSPORT
  LIBRARY
  ANNOUNCEMENT
}

enum Audience {
  ALL
  STUDENTS
  TEACHERS
  PARENTS
  STAFF // Added
  TEACHING_STAFF // Added
  NON_TEACHING_STAFF // Added
  ADMINS // Added
  CLASS
  SECTION
  CUSTOM // Added for specific users
}

enum Priority {
  NORMAL
  IMPORTANT
  URGENT
  CRITICAL // Added
}

enum Status {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED // Added for future publishing
  EXPIRED // Added for auto-expiry
}

model Role {
  id                   Int                   @id @default(autoincrement())
  name                 String                @unique
  users                User[]
  noticeTargets        NoticeTarget[]
  calendarEventTargets CalendarEventTarget[]
}

model User {
  id             String     @id @db.Uuid
  schoolId       String?    @db.Uuid
  roleId         Int
  email          String     @unique
  password       String
  name           String?
  gender         String     @default("Unknown")
  profilePicture String     @default("default.png")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  deletedAt      DateTime?
  status         UserStatus @default(ACTIVE)
  Admin          Admin?
  fcmToken       String?

  AuditLog              AuditLog[]
  Document              Document[]
  MasterAdmin           MasterAdmin?
  nonTeachingStaff      NonTeachingStaff?
  Notice                Notice[]
  receivedNotifications Notification[]         @relation("NotificationReceiver")
  sentNotifications     Notification[]         @relation("NotificationSender")
  student               Student?
  teacher               TeachingStaff?
  role                  Role                   @relation(fields: [roleId], references: [id])
  school                School?                @relation(fields: [schoolId], references: [id])
  Application           Application[]
  StageHistory          StageHistory[]
  GmailAccount          GmailAccount[]
  CertificateTemplate   CertificateTemplate[]
  CertificateGenerated  CertificateGenerated[]
  DocumentTemplate      DocumentTemplate[]
  NoticeReads           NoticeRead[]           @relation("NoticeReads")
  NoticeTargets         NoticeTarget[]         @relation("NoticeTargetUser")
  approvedDiscounts     FeeDiscount[]          @relation("ApprovedDiscounts")
  collectedPayments     FeePayment[]           @relation("CollectedPayments")
  parent                Parent?
  calendarEvents        CalendarEvent[]
  calendarEventTargets  CalendarEventTarget[]
  createdDelegations    AttendanceDelegation[] @relation("DelegationCreator")

  attendance              Attendance[]
  markedAttendance        Attendance[]             @relation("MarkedBy")
  promotionsInitiated     PromotionHistory[]
  approvedAttendance      Attendance[]             @relation("ApprovedBy")
  leaveRequests           LeaveRequest[]
  reviewedLeaves          LeaveRequest[]           @relation("LeaveReviewer")
  leaveBalances           LeaveBalance[]
  attendanceStats         AttendanceStats[]
  bulkAttendanceRecords   BulkAttendance[]
  attendanceNotifications AttendanceNotification[] @relation("AttendanceNotifications")
  partner                 Partner?
  managedPartners         Partner[]                @relation("PartnerAccountManager")
  assignedLeads           PartnerLead[]            @relation("LeadAssignedTo")
  uploadedMedia           MediaLibrary[]

  // Session Management
  sessions       UserSession[]
  securityEvents SecurityEvent[]

  @@index([schoolId])
  @@index([roleId])
}

// model GmailAccount {
//   id           String   @id @default(uuid())
//   userId       String   @db.Uuid
//   email        String
//   accessToken  String
//   refreshToken String
//   createdAt    DateTime @default(now())
//   updatedAt    DateTime @updatedAt

//   user User @relation(fields: [userId], references: [id])

//   @@unique([userId, email]) // A user canâ€™t have duplicate Gmail accounts
// }
model GmailAccount {
  id           String   @id @default(uuid())
  userId       String   @db.Uuid
  email        String
  accessToken  String
  refreshToken String
  name         String? // Optional: for display name
  avatar       String? // Optional: for avatar URL
  lastUsedAt   DateTime @default(now()) // NEW: Track last usage
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, email])
}

model Admin {
  userId   String @id @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])
  User     User   @relation(fields: [userId], references: [id])
}

model MasterAdmin {
  userId   String @id @unique @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])
  User     User   @relation(fields: [userId], references: [id])
}

model Student {
  userId             String  @id @db.Uuid
  classId            Int
  parentId           String? @db.Uuid
  name               String
  email              String
  dob                String
  gender             String
  admissionDate      String
  sectionId          Int
  bloodGroup         String
  rollNumber         String
  PreviousSchoolName String?

  DateOfLeaving    String?
  contactNumber    String
  Address          String
  city             String
  state            String
  country          String
  postalCode       String
  FatherName       String
  MotherName       String
  FatherNumber     String?
  MotherNumber     String?
  GuardianName     String?
  GuardianRelation String?
  House            String?
  admissionNo      String  @unique
  schoolId         String  @db.Uuid
  academicYearId   String? @db.Uuid

  // Alumni Tracking
  isAlumni          Boolean   @default(false)
  alumniConvertedAt DateTime?

  ExamIssue              ExamIssue[]
  examResults            ExamResult[]
  FeePayment             FeePayment[]
  FeeStructure           FeeStructure[]
  HomeworkSubmission     HomeworkSubmission[]
  AcademicYear           AcademicYear?            @relation(fields: [academicYearId], references: [id])
  class                  Class                    @relation(fields: [classId], references: [id])
  school                 School                   @relation(fields: [schoolId], references: [id])
  section                Section                  @relation(fields: [sectionId], references: [id])
  user                   User                     @relation(fields: [userId], references: [id])
  StudentFeeStructure    StudentFeeStructure[]
  StudentRouteAssignment StudentRouteAssignment[]
  CertificateGenerated   CertificateGenerated[]
  DigitalIdCard          DigitalIdCard[]
  AdmitCard              AdmitCard[]
  studentFees            StudentFee[]
  feeReminders           FeeReminder[]
  studentParentLinks     StudentParentLink[]
  seatAllocations        SeatAllocation[]
  studentExamAttempts    StudentExamAttempt[]
  hallAttendances        HallAttendance[]
  promotionHistories     PromotionHistory[]

  @@index([classId])
  @@index([sectionId])
  @@index([parentId])
}

// ============================================
// PARENT-STUDENT LINKING SYSTEM
// ============================================

// Parent Model
model Parent {
  id              String  @id @default(uuid()) @db.Uuid
  userId          String  @unique @db.Uuid
  schoolId        String  @db.Uuid
  // Personal Information
  name            String
  email           String  @unique
  contactNumber   String  @unique
  alternateNumber String?
  // gender          String
  // Address Information
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?

  // Additional Details
  occupation    String?
  qualification String?
  annualIncome  String?
  bloodGroup    String?

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactNumber   String?
  emergencyContactRelation String?

  // System Fields
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
  status    UserStatus @default(ACTIVE)

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentLinks StudentParentLink[]

  @@index([schoolId])
  @@index([contactNumber])
  @@index([email])
  @@index([userId])
}

// Bridge/Junction Model for Many-to-Many Relationship
model StudentParentLink {
  id        String @id @default(uuid()) @db.Uuid
  studentId String @db.Uuid
  parentId  String @db.Uuid

  // Relation Type
  relation ParentRelationType @default(GUARDIAN)

  // Primary Contact (one parent can be marked as primary)
  isPrimary Boolean @default(false)

  // Permissions
  canPickup      Boolean @default(true)
  canViewReports Boolean @default(true)
  canViewFees    Boolean @default(true)

  // System Fields
  linkedAt   DateTime  @default(now())
  linkedBy   String?   @db.Uuid // Admin/Staff who created the link
  verifiedAt DateTime? // When parent verified the link
  isActive   Boolean   @default(true)

  // Relations
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId]) // Prevent duplicate links
  @@index([studentId])
  @@index([parentId])
  @@index([relation])
}

// Enum for Parent Relation Types
enum ParentRelationType {
  FATHER
  MOTHER
  GUARDIAN
  GRANDFATHER
  GRANDMOTHER
  UNCLE
  AUNT
  SIBLING
  OTHER
}

model ExamSeries {
  id     Int    @id @default(autoincrement())
  examId String @db.Uuid
  score  Float
  exam   Exam   @relation(fields: [examId], references: [id])
}

model ExamIssue {
  id        Int      @id @default(autoincrement())
  studentId String   @db.Uuid
  issueDate DateTime
  student   Student  @relation(fields: [studentId], references: [userId])
}

model HomeworkSubmission {
  id         String @id @default(uuid()) @db.Uuid
  homeworkId String @db.Uuid
  studentId  String @db.Uuid

  // Submission Details
  submittedAt DateTime?
  fileUrl     String?
  fileName    String?
  remarks     String?   @db.Text

  // Status
  status   SubmissionStatus @default(PENDING)
  grade    String?
  feedback String?          @db.Text

  // Evaluation
  evaluatedBy String?   @db.Uuid
  evaluatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homework Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [userId])

  @@unique([homeworkId, studentId])
  @@index([homeworkId])
  @@index([studentId])
  @@index([status])
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  LATE
  EVALUATED
  MISSING
}

model TeachingStaff {
  userId           String    @id @db.Uuid
  departmentId     Int?
  employeeId       String
  name             String
  designation      String
  gender           String
  sectionsAssigned Section[] @relation("Section_Teacher")
  age              String
  bloodGroup       String

  contactNumber         String
  dob                   String
  email                 String
  address               String
  City                  String
  district              String?
  state                 String?
  country               String?
  PostalCode            String?
  subjectId             Int?
  schoolId              String                  @db.Uuid
  academicYearId        String                  @db.Uuid
  Class                 Class[]
  homework              Homework[]
  SectionSubjectTeacher SectionSubjectTeacher[]
  AcademicYear          AcademicYear            @relation(fields: [academicYearId], references: [id])
  department            Department?             @relation(fields: [departmentId], references: [id])
  school                School                  @relation(fields: [schoolId], references: [id])
  originalDelegations   AttendanceDelegation[]  @relation("OriginalTeacher")
  substituteDelegations AttendanceDelegation[]  @relation("SubstituteTeacher")
  user                  User                    @relation(fields: [userId], references: [id])
  subjects              Subject[]               @relation("SubjectToTeachingStaff")
  timetableEntries      TimetableEntry[]
  examHallInvigilators  ExamHallInvigilator[]
  teacherShifts         TeacherShift[]

  @@index([departmentId])
}

model NonTeachingStaff {
  userId         String       @id @db.Uuid
  departmentId   Int?
  employeeId     String
  name           String
  designation    String
  gender         String
  dob            String
  age            String
  bloodGroup     String
  contactNumber  String
  email          String
  address        String
  City           String
  district       String?
  state          String?
  country        String?
  PostalCode     String?
  schoolId       String       @db.Uuid
  academicYearId String       @db.Uuid
  AcademicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  department     Department?  @relation(fields: [departmentId], references: [id])
  school         School       @relation(fields: [schoolId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([departmentId])
}

model Class {
  id                     Int                    @id @default(autoincrement())
  schoolId               String                 @db.Uuid
  className              String
  capacity               Int?
  teachingStaffUserId    String?                @db.Uuid
  academicYearId         String?                @db.Uuid
  AcademicYear           AcademicYear?          @relation(fields: [academicYearId], references: [id])
  school                 School                 @relation(fields: [schoolId], references: [id])
  TeachingStaff          TeachingStaff?         @relation(fields: [teachingStaffUserId], references: [userId])
  FeeStructure           FeeStructure[]
  homework               Homework[]
  NoticeTarget           NoticeTarget[]
  sections               Section[]
  attendanceDelegations  AttendanceDelegation[]
  students               Student[]
  subjects               Subject[]
  Syllabi                Syllabus[]
  Assignment             Assignment[]
  globalFeeStructures    GlobalFeeStructure[]
  calendarEventTargets   CalendarEventTarget[]
  bulkAttendance         BulkAttendance[]
  exam                   Exam?                  @relation(fields: [examId], references: [id])
  examId                 String?                @db.Uuid
  timetableEntries       TimetableEntry[]
  promotionHistoriesFrom PromotionHistory[]     @relation("PromotionFromClass")
  promotionHistoriesTo   PromotionHistory[]     @relation("PromotionToClass")
  teacherShifts          TeacherShift[]
  alumni                 Alumni[]

  @@unique([id, schoolId])
  @@index([schoolId])
}

// model Section {
//   id                   Int                     @id @default(autoincrement())
//   name                 String
//   classId              Int
//   schoolId             String                  @db.Uuid
//   teachingStaffUserId  String?                 @db.Uuid
//   NoticeTarget         NoticeTarget[]
//   class                Class                   @relation(fields: [classId], references: [id])
//   supervisor           TeachingStaff?          @relation(fields: [teachingStaffUserId], references: [userId])
//   subjectTeachers      SectionSubjectTeacher[]
//   students             Student[]
//   timetables           Timetable[]
//   calendarEventTargets CalendarEventTarget[]
//   bulkAttendance       BulkAttendance[]

//   @@unique([classId, name])
//   @@index([classId])
// }
model Section {
  id                  Int     @id @default(autoincrement())
  name                String
  classId             Int
  schoolId            String  @db.Uuid
  teachingStaffUserId String? @db.Uuid

  // Relations
  class                 Class                   @relation(fields: [classId], references: [id])
  teachingStaff         TeachingStaff?          @relation("Section_Teacher", fields: [teachingStaffUserId], references: [userId])
  NoticeTarget          NoticeTarget[]
  subjectTeachers       SectionSubjectTeacher[]
  students              Student[]
  timetables            Timetable[]
  calendarEventTargets  CalendarEventTarget[]
  bulkAttendance        BulkAttendance[]
  attendanceDelegations AttendanceDelegation[]
  homework              Homework[]
  timetableEntries      TimetableEntry[]
  teacherShifts         TeacherShift[]
  alumni                Alumni[]

  @@unique([classId, name])
  @@index([classId])
}

model SectionSubjectTeacher {
  id                  Int           @id @default(autoincrement())
  sectionId           Int
  subjectId           Int
  teachingStaffUserId String        @db.Uuid
  section             Section       @relation(fields: [sectionId], references: [id])
  subject             Subject       @relation(fields: [subjectId], references: [id])
  teacher             TeachingStaff @relation(fields: [teachingStaffUserId], references: [userId])

  @@unique([sectionId, subjectId])
}

// Time Slot Configuration (e.g., Period 1: 09:00-09:40)
model TimeSlot {
  id        String   @id @default(uuid()) @db.Uuid
  schoolId  String   @db.Uuid
  label     String // "Period 1", "Period 2", "Lunch Break"
  startTime String // "09:00"
  endTime   String // "09:40"
  isBreak   Boolean  @default(false)
  sequence  Int // Order: 1, 2, 3...
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school        School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  entries       TimetableEntry[]
  teacherShifts TeacherShift[]

  @@index([schoolId])
  @@index([schoolId, sequence])
}

// Individual Timetable Entry (Class X, Period 1, Monday = Math with Mr. Sharma)
model TimetableEntry {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Linking
  classId    Int
  sectionId  Int?
  subjectId  Int
  teacherId  String @db.Uuid
  timeSlotId String @db.Uuid

  // Schedule
  dayOfWeek  Int // 1=Monday, 2=Tuesday, ..., 6=Saturday
  roomNumber String?

  // Metadata
  isActive  Boolean  @default(true)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school   School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class    Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  section  Section?      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject  Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher  TeachingStaff @relation(fields: [teacherId], references: [userId], onDelete: Cascade)
  timeSlot TimeSlot      @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)

  @@unique([classId, sectionId, timeSlotId, dayOfWeek])
  @@index([schoolId])
  @@index([teacherId, dayOfWeek])
  @@index([classId, sectionId, dayOfWeek])
  @@index([timeSlotId, dayOfWeek])
}

// Date-specific Teacher Shift (Timetable)
model TeacherShift {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Linking
  classId    Int
  sectionId  Int
  subjectId  Int
  teacherId  String @db.Uuid
  timeSlotId String @db.Uuid

  // Schedule
  date       DateTime @db.Date // Specific date for this shift
  roomNumber String?

  // Metadata
  status    String   @default("ASSIGNED") // ASSIGNED, CANCELLED, COMPLETED
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school   School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class    Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  section  Section       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject  Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher  TeachingStaff @relation(fields: [teacherId], references: [userId], onDelete: Cascade)
  timeSlot TimeSlot      @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)

  @@unique([teacherId, date, timeSlotId]) // One teacher can't be in two places at same time
  @@index([schoolId])
  @@index([teacherId, date])
  @@index([classId, sectionId, date])
  @@index([date])
}

// Template for reusing timetable configurations
model TimetableTemplate {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  name           String // "Standard Week", "Exam Week"
  academicYearId String   @db.Uuid
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([academicYearId])
}

// Legacy model - kept for backward compatibility, will be deprecated
model Timetable {
  id        String   @id @default(uuid()) @db.Uuid
  sectionId Int
  day       String
  period    Int
  subject   String
  teacher   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  section   Section  @relation(fields: [sectionId], references: [id])
}

model Document {
  id          Int          @id @default(autoincrement())
  userId      String       @db.Uuid
  title       String
  description String?
  fileUrl     String
  type        DocumentType @default(OTHER)
  isPublic    Boolean      @default(false)
  uploadedAt  DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

model Subject {
  id                    Int                     @id @default(autoincrement())
  subjectName           String
  subjectCode           String?
  classId               Int
  departmentId          Int
  examResults           ExamResult[]
  homework              Homework[]
  SectionSubjectTeacher SectionSubjectTeacher[]
  class                 Class                   @relation(fields: [classId], references: [id])
  department            Department              @relation(fields: [departmentId], references: [id])
  Teacher               TeachingStaff[]         @relation("SubjectToTeachingStaff")
  examSubjects          ExamSubject[]
  timetableEntries      TimetableEntry[]
  teacherShifts         TeacherShift[]

  @@index([classId])
  @@index([departmentId])
}

model Department {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  NonTeachingStaff NonTeachingStaff[]
  subjects         Subject[]
  teachers         TeachingStaff[]
}

// Enhanced Homework Model
model Homework {
  id        String @id @default(uuid()) @db.Uuid
  schoolId  String @db.Uuid
  classId   Int
  sectionId Int?
  subjectId Int?
  teacherId String @db.Uuid

  // Homework Details
  title       String
  description String  @db.Text
  fileUrl     String? // Optional PDF/document
  fileName    String?

  // Dates
  assignedDate DateTime @default(now())
  dueDate      DateTime

  // Status
  isActive Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school  School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class   Class         @relation(fields: [classId], references: [id])
  section Section?      @relation(fields: [sectionId], references: [id])
  subject Subject?      @relation(fields: [subjectId], references: [id])
  teacher TeachingStaff @relation(fields: [teacherId], references: [userId])

  submissions HomeworkSubmission[]

  @@index([schoolId])
  @@index([classId])
  @@index([sectionId])
  @@index([teacherId])
  @@index([dueDate])
  @@index([isActive])
}

model Exam {
  id             String     @id @default(uuid()) @db.Uuid
  schoolId       String     @db.Uuid
  title          String
  type           ExamType   @default(OFFLINE)
  startDate      DateTime?
  endDate        DateTime?
  status         ExamStatus @default(DRAFT)
  academicYearId String?    @db.Uuid
  isFinalExam    Boolean    @default(false)
  description    String?    @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  school       School        @relation(fields: [schoolId], references: [id])
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id])

  classes Class[]

  results         ExamResult[]
  examSeries      ExamSeries[]
  AdmitCard       AdmitCard[]
  subjects        ExamSubject[]
  seatAllocations SeatAllocation[]

  securitySettings Json? // Security settings for online exams (lockScreen, tabMonitoring)
  duration         Int? // Exam duration in minutes
  enableTimer      Boolean               @default(false) // Whether to enable timer for this exam[]
  questions        OnlineExamQuestion[]
  attempts         StudentExamAttempt[]
  invigilators     ExamHallInvigilator[]
  attendance       HallAttendance[]

  @@index([schoolId])
}

model ExamSubject {
  id           String    @id @default(uuid()) @db.Uuid
  examId       String    @db.Uuid
  subjectId    Int
  date         DateTime?
  startTime    String?
  endTime      String?
  duration     Int?
  maxMarks     Float     @default(100)
  passingMarks Float     @default(33)

  exam    Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([examId, subjectId])
  @@index([examId])
  @@index([subjectId])
}

model ExamResult {
  id        Int    @id @default(autoincrement())
  examId    String @db.Uuid
  studentId String @db.Uuid
  subjectId Int

  marksObtained Float?
  grade         String?
  remarks       String?
  isAbsent      Boolean @default(false)

  exam    Exam    @relation(fields: [examId], references: [id])
  student Student @relation(fields: [studentId], references: [userId])
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([examId, studentId, subjectId])
  @@index([examId])
  @@index([studentId])
  @@index([subjectId])
}

model ExamHall {
  id         String  @id @default(uuid()) @db.Uuid
  schoolId   String  @db.Uuid
  name       String
  roomNumber String?
  capacity   Int

  allocations SeatAllocation[]
  school      School           @relation(fields: [schoolId], references: [id])

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  examHallInvigilators ExamHallInvigilator[]
  hallAttendances      HallAttendance[]

  @@index([schoolId])
}

model SeatAllocation {
  id         String @id @default(uuid()) @db.Uuid
  examId     String @db.Uuid
  studentId  String @db.Uuid
  examHallId String @db.Uuid
  seatNumber String

  exam    Exam     @relation(fields: [examId], references: [id])
  student Student  @relation(fields: [studentId], references: [userId])
  hall    ExamHall @relation(fields: [examHallId], references: [id])

  @@unique([examId, studentId])
  @@index([examId])
  @@index([examHallId])
}

enum ExamType {
  OFFLINE
  ONLINE
}

enum ExamStatus {
  DRAFT
  SCHEDULED
  COMPLETED
  PUBLISHED
}

model AcademicYear {
  id                     String               @id @default(uuid()) @db.Uuid
  name                   String
  startDate              DateTime
  endDate                DateTime
  isActive               Boolean              @default(false)
  createdAt              DateTime             @default(now())
  schoolId               String               @db.Uuid
  school                 School               @relation(fields: [schoolId], references: [id])
  classes                Class[]
  FeePayments            FeePayment[]
  FeeStructures          FeeStructure[]
  NonTeachingStaff       NonTeachingStaff[]
  students               Student[]
  Syllabus               Syllabus[]
  TeachingStaff          TeachingStaff[]
  DigitalIdCard          DigitalIdCard[]
  globalFeeStructures    GlobalFeeStructure[]
  studentFees            StudentFee[]
  leaveBalances          LeaveBalance[]
  attendanceStats        AttendanceStats[]
  exams                  Exam[]
  timetableTemplates     TimetableTemplate[]
  promotionHistoriesFrom PromotionHistory[]   @relation("PromotionFromYear")
  promotionHistoriesTo   PromotionHistory[]   @relation("PromotionToYear")

  @@unique([schoolId, name])
  @@index([schoolId])
}

model FeeStructure {
  id                  String                @id @default(uuid()) @db.Uuid
  schoolId            String?               @db.Uuid
  academicYearId      String                @db.Uuid
  issueDate           DateTime              @default(now())
  name                String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  studentUserId       String?               @db.Uuid
  classId             Int?
  mode                FeeMode               @default(MONTHLY)
  isInstallment       Boolean               @default(false)
  feeParticulars      FeeParticular[]
  FeePayments         FeePayment[]
  AcademicYear        AcademicYear          @relation(fields: [academicYearId], references: [id])
  Class               Class?                @relation(fields: [classId], references: [id])
  School              School?               @relation(fields: [schoolId], references: [id])
  Student             Student?              @relation(fields: [studentUserId], references: [userId])
  StudentFeeStructure StudentFeeStructure[]
}

model FeeParticular {
  id                   String                 @id @default(uuid()) @db.Uuid
  feeStructureId       String                 @db.Uuid
  name                 String
  defaultAmount        Float
  feeStructure         FeeStructure           @relation(fields: [feeStructureId], references: [id])
  StudentFeeParticular StudentFeeParticular[]
}

model StudentFeeStructure {
  id             String                 @id @default(uuid()) @db.Uuid
  studentId      String                 @db.Uuid
  academicYearId String                 @db.Uuid
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @default(now()) @updatedAt
  schoolId       String?                @db.Uuid
  studentUserId  String?                @db.Uuid
  feeStructureId String                 @db.Uuid
  status         String                 @default("UNPAID")
  FeePayments    FeePayment[]
  feeParticulars StudentFeeParticular[]
  feeStructure   FeeStructure           @relation(fields: [feeStructureId], references: [id])
  School         School?                @relation(fields: [schoolId], references: [id])
  Student        Student?               @relation(fields: [studentUserId], references: [userId])
}

// Link installments to specific particulars
model InstallmentParticular {
  id            String @id @default(uuid()) @db.Uuid
  installmentId String @db.Uuid
  particularId  String @db.Uuid

  // How much of this particular is in this installment
  amount     Float
  paidAmount Float @default(0)

  // Relations
  installment StudentFeeInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)
  particular  StudentFeeParticular  @relation(fields: [particularId], references: [id], onDelete: Cascade)

  @@unique([installmentId, particularId])
  @@index([installmentId])
  @@index([particularId])
}

// Attendance Record - Main attendance tracking
model Attendance {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  schoolId     String   @db.Uuid
  date         DateTime @db.Date
  delegationId String?  @db.Uuid // Track if marked via delegation

  // Status & Timing
  status       AttendanceStatus
  checkInTime  DateTime?
  checkOutTime DateTime?
  workingHours Float?           @default(0) // Calculated hours

  // Location & Device Info
  checkInLocation  Json? // {latitude, longitude, address}
  checkOutLocation Json?
  deviceInfo       Json? // {deviceId, platform, appVersion}

  // Metadata
  markedBy      String?  @db.Uuid // Who marked (for students)
  markedAt      DateTime @default(now())
  isLateCheckIn Boolean  @default(false)
  lateByMinutes Int?
  remarks       String?

  // Approval System
  requiresApproval Boolean        @default(false)
  approvalStatus   ApprovalStatus @default(PENDING)
  approvedBy       String?        @db.Uuid
  approvedAt       DateTime?
  approvalRemarks  String?

  // Relations
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  school         School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  marker         User?                @relation("MarkedBy", fields: [markedBy], references: [id])
  approver       User?                @relation("ApprovedBy", fields: [approvedBy], references: [id])
  leaveRequest   LeaveRequest?        @relation("AttendanceLeave", fields: [leaveRequestId], references: [id])
  documents      AttendanceDocument[]
  leaveRequestId String?              @db.Uuid

  @@unique([userId, schoolId, date])
  @@index([userId, date])
  @@index([schoolId, date])
  @@index([status])
  @@index([approvalStatus])
  @@index([markedBy])
}

// model AttendanceDelegation {
//   id                  String @id @default(uuid()) @db.Uuid
//   schoolId            String @db.Uuid
//   originalTeacherId   String @db.Uuid
//   substituteTeacherId String @db.Uuid
//   classId             Int
//   sectionId           Int?

//   // Delegation Period
//   startDate DateTime @db.Date
//   endDate   DateTime @db.Date

//   // Status & Metadata
//   status      DelegationStatus @default(ACTIVE)
//   reason      String?          @db.Text
//   createdById String           @db.Uuid
//   createdAt   DateTime         @default(now())
//   updatedAt   DateTime         @updatedAt

//   // Relations
//   school            School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   originalTeacher   TeachingStaff @relation("OriginalTeacher", fields: [originalTeacherId], references: [userId])
//   substituteTeacher TeachingStaff @relation("SubstituteTeacher", fields: [substituteTeacherId], references: [userId])
//   class             Class         @relation(fields: [classId], references: [id])
//   section           Section?      @relation(fields: [sectionId], references: [id])
//   createdBy         User          @relation("DelegationCreator", fields: [createdById], references: [id])

//   @@unique([schoolId, classId, sectionId, startDate, endDate, substituteTeacherId])
//   @@index([schoolId, startDate, endDate])
//   @@index([substituteTeacherId, startDate, endDate])
//   @@index([originalTeacherId, startDate, endDate])
//   @@index([status])
// }
model AttendanceDelegation {
  id                  String @id @default(uuid()) @db.Uuid
  schoolId            String @db.Uuid
  originalTeacherId   String @db.Uuid
  substituteTeacherId String @db.Uuid
  classId             Int
  sectionId           Int?

  // Delegation Period
  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  // Status & Metadata
  status DelegationStatus @default(ACTIVE)
  reason String?          @db.Text

  acknowledgedAt DateTime? // Tracks when substitute teacher acknowledged the delegation
  createdById    String    @db.Uuid
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  school            School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  originalTeacher   TeachingStaff @relation("OriginalTeacher", fields: [originalTeacherId], references: [userId])
  substituteTeacher TeachingStaff @relation("SubstituteTeacher", fields: [substituteTeacherId], references: [userId])
  class             Class         @relation(fields: [classId], references: [id])
  section           Section?      @relation(fields: [sectionId], references: [id])
  createdBy         User          @relation("DelegationCreator", fields: [createdById], references: [id])

  // âœ… New Rules
  @@unique([schoolId, originalTeacherId, startDate, endDate])
  @@unique([schoolId, classId, sectionId, startDate, endDate])
  // Existing helpful indexes
  @@index([schoolId, startDate, endDate])
  @@index([substituteTeacherId, startDate, endDate])
  @@index([originalTeacherId, startDate, endDate])
  @@index([status])
}

enum DelegationStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// School Calendar - Define working days, holidays
model SchoolCalendar {
  id       String   @id @default(uuid()) @db.Uuid
  schoolId String   @db.Uuid
  date     DateTime @db.Date

  // Day Configuration
  dayType     DayType @default(WORKING_DAY)
  isHoliday   Boolean @default(false)
  holidayName String?

  // Working Hours
  startTime String? // "09:00"
  endTime   String? // "17:00"

  // Metadata
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, date])
  @@index([schoolId, date])
  @@index([dayType])
}

// Attendance Configuration - School-specific settings
model AttendanceConfig {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid

  // Working Hours
  defaultStartTime   String @default("09:00")
  defaultEndTime     String @default("17:00")
  gracePeriodMinutes Int    @default(15) // Late after this
  halfDayHours       Float  @default(4)
  fullDayHours       Float  @default(8)

  // Geo-fencing
  enableGeoFencing    Boolean @default(false)
  schoolLatitude      Float?
  schoolLongitude     Float?
  allowedRadiusMeters Int?    @default(500)

  // Auto-marking Rules
  autoMarkAbsent Boolean @default(true)
  autoMarkTime   String  @default("10:00") // Mark absent if not checked in by this time

  // Approval Rules
  requireApprovalDays Int     @default(3) // Past attendance needs approval after X days
  autoApproveLeaves   Boolean @default(false)

  // Notifications
  sendDailyReminders Boolean @default(true)
  reminderTime       String  @default("08:30")
  notifyParents      Boolean @default(true)

  // Stats Calculation
  calculateOnWeekends  Boolean @default(false)
  minAttendancePercent Float   @default(75)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

// Leave Management
model LeaveRequest {
  id       String @id @default(uuid()) @db.Uuid
  userId   String @db.Uuid
  schoolId String @db.Uuid

  // Leave Details
  leaveType LeaveType
  startDate DateTime  @db.Date
  endDate   DateTime  @db.Date
  totalDays Int
  reason    String    @db.Text

  // Status
  status        LeaveStatus @default(PENDING)
  submittedAt   DateTime    @default(now())
  reviewedBy    String?     @db.Uuid
  reviewedAt    DateTime?
  reviewRemarks String?

  // Emergency Contact
  emergencyContact      String?
  emergencyContactPhone String?

  // Relations
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  school     School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  reviewer   User?           @relation("LeaveReviewer", fields: [reviewedBy], references: [id])
  attendance Attendance[]    @relation("AttendanceLeave")
  documents  LeaveDocument[]

  @@index([userId, status])
  @@index([schoolId, status])
  @@index([startDate, endDate])
}

// Leave Balance Tracking
model LeaveBalance {
  id             String @id @default(uuid()) @db.Uuid
  userId         String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid

  // Balance by Type
  casualLeaveTotal   Int @default(12)
  casualLeaveUsed    Int @default(0)
  casualLeaveBalance Int @default(12)

  sickLeaveTotal   Int @default(10)
  sickLeaveUsed    Int @default(0)
  sickLeaveBalance Int @default(10)

  earnedLeaveTotal   Int @default(15)
  earnedLeaveUsed    Int @default(0)
  earnedLeaveBalance Int @default(15)

  maternityLeaveTotal   Int @default(180)
  maternityLeaveUsed    Int @default(0)
  maternityLeaveBalance Int @default(180)

  // Metadata
  lastResetDate DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([userId, academicYearId])
  @@index([userId, schoolId])
}

// Attendance Stats - Pre-calculated for performance
model AttendanceStats {
  id             String @id @default(uuid()) @db.Uuid
  userId         String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid
  month          Int // 1-12
  year           Int

  // Stats
  totalWorkingDays Int @default(0)
  totalPresent     Int @default(0)
  totalAbsent      Int @default(0)
  totalHalfDay     Int @default(0)
  totalLate        Int @default(0)
  totalLeaves      Int @default(0)
  totalHolidays    Int @default(0)

  attendancePercentage Float @default(0)
  avgWorkingHours      Float @default(0)

  // Calculated
  lastCalculated DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([userId, academicYearId, month, year])
  @@index([userId, schoolId])
  @@index([academicYearId, month, year])
  @@index([attendancePercentage])
}

// Bulk Attendance - For efficient batch marking
model BulkAttendance {
  id        String   @id @default(uuid()) @db.Uuid
  schoolId  String   @db.Uuid
  classId   Int?
  sectionId Int?
  date      DateTime @db.Date
  markedBy  String   @db.Uuid
  markedAt  DateTime @default(now())

  // Summary
  totalStudents Int
  presentCount  Int
  absentCount   Int
  lateCount     Int
  halfDayCount  Int

  // Metadata
  remarks String?

  school  School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class   Class?   @relation(fields: [classId], references: [id])
  section Section? @relation(fields: [sectionId], references: [id])
  marker  User     @relation(fields: [markedBy], references: [id])

  @@index([schoolId, date])
  @@index([classId, date])
  @@index([markedBy])
}

// Attendance Documents (Medical certificates, etc.)
model AttendanceDocument {
  id           String   @id @default(uuid()) @db.Uuid
  attendanceId String   @db.Uuid
  documentType String // "MEDICAL_CERTIFICATE", "LEAVE_LETTER", etc.
  fileUrl      String
  fileName     String
  uploadedAt   DateTime @default(now())

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
}

// Leave Documents
model LeaveDocument {
  id             String   @id @default(uuid()) @db.Uuid
  leaveRequestId String   @db.Uuid
  documentType   String
  fileUrl        String
  fileName       String
  uploadedAt     DateTime @default(now())

  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  @@index([leaveRequestId])
}

// Attendance Notifications Queue
model AttendanceNotification {
  id               String           @id @default(uuid()) @db.Uuid
  schoolId         String           @db.Uuid
  userId           String           @db.Uuid
  notificationType NotificationType

  // Notification Details
  title        String
  message      String             @db.Text
  scheduledFor DateTime
  sentAt       DateTime?
  status       NotificationStatus @default(PENDING)

  // Metadata
  metadata  Json? // Additional data
  createdAt DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User   @relation("AttendanceNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([userId, status])
}

// ============================================
// ENUMS
// ============================================

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

enum DayType {
  WORKING_DAY
  WEEKEND
  HOLIDAY
  EXAM_DAY
  VACATION
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  NOT_REQUIRED
}

enum LeaveType {
  CASUAL
  SICK
  EARNED
  MATERNITY
  PATERNITY
  EMERGENCY
  UNPAID
  COMPENSATORY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Notification Enums
enum NotificationType {
  DAILY_REMINDER
  ABSENT_ALERT
  LEAVE_APPROVED
  LEAVE_REJECTED
  LOW_ATTENDANCE
  APPROVAL_REQUIRED
  GENERAL
  SYLLABUS
  ASSIGNMENT
  FEE
  EXAM
  ATTENDANCE
  NOTICE
  LEAVE
  TRANSPORT
  LIBRARY
  ADMISSION
  EVENT
  RESULT
  TIMETABLE
  BIRTHDAY
  ANNIVERSARY
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model Notification {
  id         String  @id @default(uuid()) @db.Uuid
  senderId   String? @db.Uuid
  receiverId String  @db.Uuid
  schoolId   String  @db.Uuid

  // Content
  title    String
  message  String               @db.Text
  type     NotificationType     @default(GENERAL)
  priority NotificationPriority @default(NORMAL)
  icon     String               @default("ðŸ“¢")

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Action & Metadata
  actionUrl String? // Deep link or action URL
  metadata  Json? // Additional data

  // Timestamps
  createdAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiry date

  // Relations
  receiver User  @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender   User? @relation("NotificationSender", fields: [senderId], references: [id])

  @@index([receiverId, isRead])
  @@index([receiverId, createdAt])
  @@index([schoolId])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
}

model LibraryBook {
  id          String  @id @default(uuid()) @db.Uuid
  schoolId    String  @db.Uuid
  title       String
  author      String
  ISBN        String
  category    String
  publisher   String
  edition     String?
  description String?
  coverImage  String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school   School               @relation(fields: [schoolId], references: [id])
  copies   LibraryBookCopy[]
  requests LibraryBookRequest[]

  @@index([schoolId])
  @@index([ISBN])
  @@index([title])
  @@index([author])
}

model LibraryBookCopy {
  id              String  @id @default(uuid()) @db.Uuid
  bookId          String  @db.Uuid
  accessionNumber String // Unique ID for the physical copy
  status          String  @default("AVAILABLE") // AVAILABLE, ISSUED, LOST, DAMAGED, RESERVED
  condition       String  @default("GOOD") // NEW, GOOD, FAIR, POOR
  location        String? // Shelf number etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  book         LibraryBook          @relation(fields: [bookId], references: [id], onDelete: Cascade)
  transactions LibraryTransaction[]

  @@unique([bookId, accessionNumber])
  @@index([status])
}

model LibraryTransaction {
  id       String @id @default(uuid()) @db.Uuid
  copyId   String @db.Uuid
  userId   String @db.Uuid // Student or Staff ID
  userType String // STUDENT, TEACHER, STAFF

  issueDate  DateTime  @default(now())
  dueDate    DateTime
  returnDate DateTime?

  status String @default("ISSUED") // ISSUED, RETURNED, OVERDUE, LOST

  fineAmount Float   @default(0)
  finePaid   Boolean @default(false)
  remarks    String?

  copy LibraryBookCopy @relation(fields: [copyId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model LibrarySettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid

  maxBooksStudent Int @default(3)
  maxBooksTeacher Int @default(5)

  issueDaysStudent Int @default(14)
  issueDaysTeacher Int @default(30)

  finePerDay Float  @default(5)
  currency   String @default("INR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LibraryBookRequest {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  bookId   String @db.Uuid
  userId   String @db.Uuid
  userType String // STUDENT, TEACHER, STAFF

  // Request Details
  status      RequestStatus @default(PENDING)
  requestDate DateTime      @default(now())

  // Approval Details
  approvedBy   String?   @db.Uuid
  approvedDate DateTime?
  pickupDate   DateTime? // Date by which book must be collected

  // Collection Details
  collectedDate DateTime?
  collectedBy   String?   @db.Uuid // Staff who handed over the book

  // Rejection/Cancellation
  rejectedBy      String?   @db.Uuid
  rejectedDate    DateTime?
  rejectionReason String?

  remarks String?

  // Relations
  school School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  book   LibraryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([userId])
  @@index([status])
  @@index([pickupDate])
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  COLLECTED
  EXPIRED
  CANCELLED
}

model Upload {
  id        String   @id @default(uuid())
  userId    String?
  fileUrl   String
  fileName  String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())
  School    School?  @relation(fields: [schoolId], references: [id])
  schoolId  String?  @db.Uuid
}

model Gallery {
  id       Int    @id @default(autoincrement())
  schoolId String @db.Uuid
  title    String
  school   School @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
}

// certificates generation models

// Add to your existing schema.prisma

model Signature {
  id                 String              @id @default(uuid()) @db.Uuid
  schoolId           String              @db.Uuid
  name               String
  designation        String?
  imageUrl           String
  isDefault          Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  templateSignatures TemplateSignature[]

  @@index([schoolId])
}

model Stamp {
  id             String          @id @default(uuid()) @db.Uuid
  schoolId       String          @db.Uuid
  name           String
  imageUrl       String
  position       Json? // { x: number, y: number }
  forDocument    String? // e.g., 'certificate', 'idcard'
  isDefault      Boolean         @default(false)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  templateStamps TemplateStamp[]

  @@index([schoolId])
}

model TemplateSignature {
  id           String              @id @default(uuid()) @db.Uuid
  templateId   String              @db.Uuid
  signatureId  String              @db.Uuid
  x            Float
  y            Float
  scale        Float               @default(1.0)
  rotation     Float               @default(0.0)
  templateType String // e.g., 'certificate', 'idcard'
  createdAt    DateTime            @default(now())
  template     CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade) // Assume CertificateTemplate; adjust for other templates
  signature    Signature           @relation(fields: [signatureId], references: [id], onDelete: Cascade)
}

model TemplateStamp {
  id           String              @id @default(uuid()) @db.Uuid
  templateId   String              @db.Uuid
  stampId      String              @db.Uuid
  x            Float
  y            Float
  scale        Float               @default(1.0)
  rotation     Float               @default(0.0)
  templateType String // e.g., 'certificate', 'idcard'
  createdAt    DateTime            @default(now())
  template     CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade) // Adjust for other
  stamp        Stamp               @relation(fields: [stampId], references: [id], onDelete: Cascade)
}

model QrVerificationSettings {
  id       String @id @default(cuid())
  schoolId String @db.Uuid // CRITICAL: @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  // Enablement
  enabledForCertificates Boolean @default(true)
  enabledForIdCards      Boolean @default(true)
  enabledForAdmitCards   Boolean @default(false)

  // Data Encoding
  encodeStudentId       Boolean @default(true)
  encodeCertificateId   Boolean @default(true)
  encodeIssueDate       Boolean @default(true)
  encodeSchoolId        Boolean @default(true)
  encodeVerificationUrl Boolean @default(true)
  customFields          Json?

  // Placement
  qrPlacementX Float @default(500)
  qrPlacementY Float @default(720)
  qrSize       Float @default(120)

  // Design
  qrColor              String  @default("#000000")
  qrBackground         String  @default("#FFFFFF")
  errorCorrectionLevel String  @default("M")
  logoOverlayUrl       String?

  // Verification Portal
  verificationBaseUrl String  @default("https://your-school.com/verify")
  portalTitle         String  @default("Verify Certificate")
  portalLogoUrl       String?
  portalPrimaryColor  String  @default("#1e40af")

  // Security
  useHashEncryption Boolean @default(true)
  hashAlgorithm     String  @default("SHA256")
  qrValidityDays    Int?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([schoolId])
}

model PdfExportSettings {
  id       String @id @default(cuid())
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  // Page Layout
  paperSize    String @default("A4") // A4, A5, Letter, Custom
  customWidth  Float? // mm
  customHeight Float? // mm
  orientation  String @default("portrait") // portrait, landscape
  marginTop    Float  @default(20) // mm
  marginBottom Float  @default(20) // mm
  marginLeft   Float  @default(20) // mm
  marginRight  Float  @default(20) // mm

  // Output Quality
  resolution  String  @default("standard") // standard, high, ultra
  compression String  @default("medium") // low, medium, high
  embedFonts  Boolean @default(true)

  // Branding & Header/Footer
  headerImageUrl    String?
  footerImageUrl    String?
  schoolLogoUrl     String?
  watermarkType     String  @default("none") // none, text, image
  watermarkText     String?
  watermarkImageUrl String?
  footerText        String?
  pageNumbering     Boolean @default(true)

  // Security & Protection
  passwordProtect    Boolean @default(false)
  password           String? // Encrypted in production
  disablePrint       Boolean @default(false)
  disableCopy        Boolean @default(false)
  digitalSignature   Boolean @default(false)
  saveAsDefault      Boolean @default(false)
  // File Handling
  fileNameFormat     String  @default("{student_name}_{document_type}.pdf")
  autoSaveLocation   String  @default("cloud") // cloud, local
  bulkExportBehavior String  @default("separate") // combine, separate

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([schoolId])
}

// model CertificateTemplate {
//   id                String                 @id @default(uuid()) @db.Uuid
//   name              String
//   description       String?
//   type              String // character, bonafide, transfer, etc.
//   schoolId          String                 @db.Uuid
//   school            School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   layoutConfig      Json // Stores ALL design settings
//   createdById       String?                @db.Uuid
//   createdBy         User?                  @relation(fields: [createdById], references: [id])
//   isDefault         Boolean                @default(false)
//   createdAt         DateTime               @default(now())
//   updatedAt         DateTime               @updatedAt
//   certificates      CertificateGenerated[]
//   TemplateSignature TemplateSignature[]
//   TemplateStamp     TemplateStamp[]

//   @@index([schoolId])
//   @@index([type])
// }
model CertificateTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  type         String // character, bonafide, transfer, etc.
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  layoutConfig Json // Stores design settings for signatures/stamps
  createdById  String?  @db.Uuid
  createdBy    User?    @relation(fields: [createdById], references: [id])
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations for signatures/stamps positioning
  templateSignatures TemplateSignature[]
  templateStamps     TemplateStamp[]
  DocumentTemplate   DocumentTemplate[]

  @@index([schoolId])
  @@index([type])
}

// DocumentTemplate: Main template with all content
model DocumentTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  templateType String // 'certificate', 'idcard', 'admitcard'
  subType      String // specific type (character, student, midterm, etc.)
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  layoutConfig Json
  createdById  String?  @db.Uuid
  createdBy    User?    @relation(fields: [createdById], references: [id])
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ADDED: Link to CertificateTemplate for signatures/stamps
  certificateTemplateId String?              @db.Uuid
  certificateTemplate   CertificateTemplate? @relation(fields: [certificateTemplateId], references: [id])

  // Generated certificates reference this
  certificatesGenerated CertificateGenerated[]

  @@unique([schoolId, templateType, subType, name])
  @@index([schoolId])
  @@index([templateType])
  @@index([subType])
}

// model DocumentTemplate {
//   id                   String                 @id @default(uuid()) @db.Uuid
//   name                 String
//   description          String?
//   templateType         String // 'certificate', 'idcard', 'admitcard'
//   subType              String // specific type (character, student, midterm, etc.)
//   schoolId             String                 @db.Uuid
//   school               School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   layoutConfig         Json
//   createdById          String?                @db.Uuid
//   createdBy            User?                  @relation(fields: [createdById], references: [id])
//   isDefault            Boolean                @default(false)
//   isActive             Boolean                @default(true)
//   createdAt            DateTime               @default(now())
//   updatedAt            DateTime               @updatedAt
//   CertificateGenerated CertificateGenerated[]

//   @@unique([schoolId, templateType, subType, name])
//   @@index([schoolId])
//   @@index([templateType])
//   @@index([subType])
// }

// model CertificateGenerated {
//   id                String              @id @default(uuid()) @db.Uuid
//   certificateNumber String              @unique
//   templateId        String              @db.Uuid
//   template          CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
//   studentId         String              @db.Uuid
//   student           Student             @relation(fields: [studentId], references: [userId], onDelete: Cascade)
//   schoolId          String              @db.Uuid
//   school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   issuedById        String?             @db.Uuid
//   issuedBy          User?               @relation(fields: [issuedById], references: [id])
//   issueDate         DateTime            @default(now())
//   customFields      Json // Additional dynamic values like event name, remarks, etc.
//   fileUrl           String? // If PDF is stored
//   status            String              @default("issued") // issued, pending, revoked
//   createdAt         DateTime            @default(now())

//   @@index([schoolId])
//   @@index([studentId])
//   @@index([templateId])
//   @@index([status])
// }
model CertificateGenerated {
  id                String @id @default(uuid()) @db.Uuid
  certificateNumber String @unique

  // Reference to DocumentTemplate ONLY
  templateId String           @db.Uuid
  template   DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  studentId String  @db.Uuid
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  issuedById String? @db.Uuid
  issuedBy   User?   @relation(fields: [issuedById], references: [id])

  issueDate    DateTime @default(now())
  customFields Json
  fileUrl      String?
  status       String   @default("issued")
  createdAt    DateTime @default(now())

  @@index([schoolId])
  @@index([studentId])
  @@index([templateId])
  @@index([status])
}

model DigitalIdCard {
  id             String        @id @default(uuid()) @db.Uuid
  studentId      String        @db.Uuid
  student        Student       @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  schoolId       String        @db.Uuid
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYearId String?       @db.Uuid
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  qrCodeUrl      String?
  layoutConfig   Json
  generatedAt    DateTime      @default(now())

  @@index([schoolId])
  @@index([studentId])
}

model AdmitCard {
  id           String   @id @default(uuid()) @db.Uuid
  studentId    String   @db.Uuid
  student      Student  @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  examId       String   @db.Uuid
  exam         Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  seatNumber   String
  center       String?
  layoutConfig Json
  issueDate    DateTime @default(now())

  @@index([schoolId])
  @@index([studentId])
  @@index([examId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    String?     @db.Uuid
  action    AuditAction
  tableName String
  rowId     String
  timestamp DateTime    @default(now())
  oldData   Json?
  newData   Json?
  error     String?
  user      User?       @relation(fields: [userId], references: [id])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ERROR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LEFT
  DISABLED
  BANNED
}

// ============================================
// SESSION MANAGEMENT & SECURITY
// ============================================

model UserSession {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session Info
  sessionToken String   @unique
  refreshToken String?
  expiresAt    DateTime

  // Device Info
  deviceName     String? // User-assigned name (e.g., "My iPhone")
  deviceType     String? // mobile, desktop, tablet
  browser        String? // Chrome, Safari, Firefox, etc.
  browserVersion String?
  os             String? // macOS, Windows, iOS, Android
  osVersion      String?
  ipAddress      String?
  location       String? // City, Country
  userAgent      String? // Full user agent string

  // Activity
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  // Security
  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?

  @@index([userId])
  @@index([sessionToken])
  @@index([isRevoked])
  @@index([expiresAt])
}

model SecurityEvent {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventType String // NEW_LOGIN, SUSPICIOUS_LOGIN, SESSION_REVOKED, PASSWORD_CHANGED, etc.
  severity  String @default("INFO") // INFO, WARNING, CRITICAL

  // Event Details
  title       String
  description String?
  deviceInfo  String?
  ipAddress   String?
  location    String?
  userAgent   String?

  // Metadata
  metadata String? // JSON string for additional data

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([eventType])
  @@index([createdAt])
}

enum DocumentType {
  NOTE
  ASSIGNMENT
  CERTIFICATE
  REPORT
  OTHER
}

// ============================================
// ENHANCED FEE MANAGEMENT SYSTEM SCHEMA
// ============================================

// Global Fee Structure (Template by Class)
model GlobalFeeStructure {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  academicYearId String   @db.Uuid
  classId        Int
  name           String // e.g., "Class 10 Annual Fees 2024-25"
  description    String?
  mode           FeeMode  @default(YEARLY)
  totalAmount    Float // Total calculated amount
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  school           School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear     AcademicYear          @relation(fields: [academicYearId], references: [id])
  class            Class                 @relation(fields: [classId], references: [id])
  particulars      GlobalFeeParticular[]
  studentFees      StudentFee[]
  installmentRules FeeInstallmentRule[]

  @@unique([schoolId, academicYearId, classId])
  @@index([schoolId, academicYearId])
  @@index([classId])
}

// Fee Components (Tuition, Books, Transport, etc.)
model GlobalFeeParticular {
  id                   String      @id @default(uuid()) @db.Uuid
  globalFeeStructureId String      @db.Uuid
  name                 String // "Tuition Fee", "Transport Fee", etc.
  amount               Float
  isOptional           Boolean     @default(false)
  category             FeeCategory @default(TUITION)
  displayOrder         Int         @default(0)

  globalFeeStructure GlobalFeeStructure     @relation(fields: [globalFeeStructureId], references: [id], onDelete: Cascade)
  studentParticulars StudentFeeParticular[]

  @@index([globalFeeStructureId])
}

// Installment Rules (How to break down payments)
model FeeInstallmentRule {
  id                   String   @id @default(uuid()) @db.Uuid
  globalFeeStructureId String   @db.Uuid
  installmentNumber    Int // 1, 2, 3, 4...
  dueDate              DateTime
  percentage           Float // Percentage of total
  amount               Float // Fixed amount (calculated)
  lateFeeAmount        Float    @default(0)
  lateFeeAfterDays     Int      @default(0)

  globalFeeStructure  GlobalFeeStructure      @relation(fields: [globalFeeStructureId], references: [id], onDelete: Cascade)
  studentInstallments StudentFeeInstallment[]

  @@unique([globalFeeStructureId, installmentNumber])
  @@index([globalFeeStructureId])
  @@index([dueDate])
}

// Student Fee Assignment (Individual Student's Fee)
model StudentFee {
  id                   String  @id @default(uuid()) @db.Uuid
  studentId            String  @db.Uuid
  schoolId             String  @db.Uuid
  academicYearId       String  @db.Uuid
  globalFeeStructureId String? @db.Uuid // Null for custom fees

  // Amounts
  originalAmount Float // Before any discounts
  discountAmount Float @default(0)
  finalAmount    Float // After discounts
  paidAmount     Float @default(0)
  balanceAmount  Float // Remaining

  // Status
  status   FeeStatus @default(UNPAID)
  isCustom Boolean   @default(false) // Custom fee structure

  // Dates
  assignedDate    DateTime  @default(now())
  lastPaymentDate DateTime?

  // Relations
  student            Student             @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  school             School              @relation(fields: [schoolId], references: [id])
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id])
  globalFeeStructure GlobalFeeStructure? @relation(fields: [globalFeeStructureId], references: [id])

  particulars  StudentFeeParticular[]
  installments StudentFeeInstallment[]
  payments     FeePayment[]
  discounts    FeeDiscount[]

  @@unique([studentId, academicYearId])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@index([studentId])
}

// Individual Fee Components for Each Student
model StudentFeeParticular {
  id                 String    @id @default(uuid()) @db.Uuid
  studentFeeId       String    @db.Uuid
  globalParticularId String?   @db.Uuid
  name               String
  amount             Float
  paidAmount         Float     @default(0)
  status             FeeStatus @default(UNPAID)

  studentFee            StudentFee              @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  globalParticular      GlobalFeeParticular?    @relation(fields: [globalParticularId], references: [id])
  feeParticular         FeeParticular?          @relation(fields: [feeParticularId], references: [id])
  feeParticularId       String?                 @db.Uuid
  studentFeeStructure   StudentFeeStructure?    @relation(fields: [studentFeeStructureId], references: [id])
  studentFeeStructureId String?                 @db.Uuid
  installmentBreakdowns InstallmentParticular[]

  @@index([studentFeeId])
  @@index([status])
}

// Student Installments (Payment Schedule)
model StudentFeeInstallment {
  id                String            @id @default(uuid()) @db.Uuid
  studentFeeId      String            @db.Uuid
  installmentRuleId String?           @db.Uuid
  installmentNumber Int
  dueDate           DateTime
  amount            Float
  paidAmount        Float             @default(0)
  status            InstallmentStatus @default(PENDING)
  lateFee           Float             @default(0)
  isOverdue         Boolean           @default(false)
  paidDate          DateTime?

  studentFee           StudentFee              @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  installmentRule      FeeInstallmentRule?     @relation(fields: [installmentRuleId], references: [id])
  payments             FeePaymentInstallment[]
  particularBreakdowns InstallmentParticular[]

  @@unique([studentFeeId, installmentNumber])
  @@index([studentFeeId])
  @@index([status])
  @@index([dueDate])
  @@index([isOverdue])
}

// Discount Management
model FeeDiscount {
  id           String       @id @default(uuid()) @db.Uuid
  studentFeeId String       @db.Uuid
  reason       String
  discountType DiscountType @default(FIXED)
  value        Float // Percentage or Fixed Amount
  amount       Float // Calculated discount amount
  approvedBy   String?      @db.Uuid
  approvedDate DateTime?
  remarks      String?
  createdAt    DateTime     @default(now())

  studentFee StudentFee @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  approver   User?      @relation("ApprovedDiscounts", fields: [approvedBy], references: [id])

  @@index([studentFeeId])
}

// Payment Records
model FeePayment {
  id             String @id @default(uuid()) @db.Uuid
  studentFeeId   String @db.Uuid
  studentId      String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid

  // Payment Details
  amount          Float
  paymentMode     PaymentMode
  paymentMethod   PaymentMethod @default(CASH)
  transactionId   String?       @unique
  referenceNumber String?

  // Gateway Details (for online payments)
  gatewayName      String? // "Razorpay", "Stripe", etc.
  gatewayOrderId   String?
  gatewayPaymentId String?
  gatewayResponse  Json? // Store full gateway response

  // Status
  status        PaymentStatus @default(PENDING)
  failureReason String?

  // Dates
  paymentDate DateTime  @default(now())
  clearedDate DateTime?

  // Receipt
  receiptNumber String  @unique
  receiptUrl    String?

  // Collection Details
  collectedBy String? @db.Uuid
  remarks     String?

  // Relations
  studentFee   StudentFee   @relation(fields: [studentFeeId], references: [id])
  student      Student      @relation(fields: [studentId], references: [userId])
  school       School       @relation(fields: [schoolId], references: [id])
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  collector    User?        @relation("CollectedPayments", fields: [collectedBy], references: [id])

  installmentPayments   FeePaymentInstallment[]
  feeStructure          FeeStructure?           @relation(fields: [feeStructureId], references: [id])
  feeStructureId        String?                 @db.Uuid
  studentFeeStructure   StudentFeeStructure?    @relation(fields: [studentFeeStructureId], references: [id])
  studentFeeStructureId String?                 @db.Uuid

  @@index([studentFeeId])
  @@index([studentId])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@index([paymentDate])
  @@index([receiptNumber])
}

// Link Payments to Installments
model FeePaymentInstallment {
  id            String @id @default(uuid()) @db.Uuid
  paymentId     String @db.Uuid
  installmentId String @db.Uuid
  amount        Float // Amount allocated to this installment

  payment     FeePayment            @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  installment StudentFeeInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([installmentId])
}

// Payment Reminders
model FeeReminder {
  id            String       @id @default(uuid()) @db.Uuid
  studentId     String       @db.Uuid
  studentFeeId  String       @db.Uuid
  reminderType  ReminderType @default(DUE_SOON)
  message       String
  sentDate      DateTime     @default(now())
  scheduledDate DateTime
  status        String       @default("SENT") // SENT, FAILED, PENDING
  channel       String       @default("EMAIL") // EMAIL, SMS, APP

  student Student @relation(fields: [studentId], references: [userId])

  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
}

// ============================================
// CALENDAR & EVENTS SYSTEM
// ============================================

model CalendarEvent {
  id          String  @id @default(uuid()) @db.Uuid
  schoolId    String  @db.Uuid
  title       String
  description String? @db.Text

  // Event Type & Category
  eventType EventType     @default(CUSTOM)
  category  EventCategory @default(OTHER)

  // Date & Time
  startDate DateTime
  endDate   DateTime
  startTime String? // "09:00 AM"
  endTime   String? // "05:00 PM"
  isAllDay  Boolean  @default(false)

  // Location & Details
  location String?
  venue    String?

  // Visibility & Access
  isPublic       Boolean  @default(true)
  targetAudience Audience @default(ALL)

  // Color & Display
  color    String   @default("#3B82F6") // Hex color
  priority Priority @default(NORMAL)

  // Recurrence
  isRecurring    Boolean @default(false)
  recurrenceRule Json? // RRULE format

  // Creator Info
  createdById String? @db.Uuid
  createdBy   User?   @relation(fields: [createdById], references: [id])

  // Status
  status EventStatus @default(SCHEDULED)

  // System Fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school    School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  targets   CalendarEventTarget[]
  reminders EventReminder[]

  @@index([schoolId])
  @@index([startDate])
  @@index([endDate])
  @@index([eventType])
  @@index([category])
  @@index([status])
}

model CalendarEventTarget {
  id      String @id @default(uuid()) @db.Uuid
  eventId String @db.Uuid

  // Targeting Options
  classId   Int?
  sectionId Int?
  roleId    Int?
  userId    String? @db.Uuid

  // Relations
  event   CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  class   Class?        @relation(fields: [classId], references: [id])
  section Section?      @relation(fields: [sectionId], references: [id])
  role    Role?         @relation(fields: [roleId], references: [id])
  user    User?         @relation(fields: [userId], references: [id])

  @@index([eventId])
  @@index([classId])
  @@index([sectionId])
  @@index([userId])
}

model EventReminder {
  id           String        @id @default(uuid()) @db.Uuid
  eventId      String        @db.Uuid
  reminderType ReminderType?

  // Timing
  reminderTime Int // Minutes before event (e.g., 30, 60, 1440)
  scheduledAt  DateTime

  // Status
  isSent Boolean   @default(false)
  sentAt DateTime?

  // Relations
  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([scheduledAt])
  @@index([isSent])
}

// ============================================
// ENUMS
// ============================================

enum EventType {
  CUSTOM // User created events
  HOLIDAY // School holidays
  VACATION // Vacation periods
  EXAM // Examination events
  SPORTS // Sports events
  MEETING // Staff/Parent meetings
  ADMISSION // Admission related
  FEE_DUE // Fee payment deadlines
  BIRTHDAY // Birthday celebrations
}

enum EventCategory {
  ACADEMIC
  ADMINISTRATIVE
  SPORTS
  CULTURAL
  HOLIDAY
  EXAM
  MEETING
  CELEBRATION
  OTHER
}

enum EventStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
  POSTPONED
}

// ============================================
// ENUMS
// ============================================

enum FeeCategory {
  TUITION
  ADMISSION
  EXAMINATION
  LIBRARY
  LABORATORY
  SPORTS
  TRANSPORT
  HOSTEL
  MISCELLANEOUS
  DEVELOPMENT
  CAUTION_MONEY
}

enum FeeMode {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}

enum FeeStatus {
  PAID
  UNPAID
  PARTIAL
  OVERDUE
  WAIVED
}

enum InstallmentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  WAIVED
}

enum DiscountType {
  PERCENTAGE
  FIXED
  SCHOLARSHIP
  SIBLING
  STAFF_WARD
  MERIT
}

enum PaymentMode {
  ONLINE
  OFFLINE
}

enum PaymentMethod {
  CASH
  CHEQUE
  CARD
  UPI
  NET_BANKING
  WALLET
  DEMAND_DRAFT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

enum ReminderType {
  DUE_SOON
  OVERDUE
  PAYMENT_CONFIRMATION
  INSTALLMENT_DUE
}

// ============================================
// ONLINE EXAM & HALL ATTENDANCE SYSTEM
// ============================================

model OnlineExamQuestion {
  id            String @id @default(uuid()) @db.Uuid
  examId        String @db.Uuid
  question      String
  type          String // MCQ, SUBJECTIVE, CHECKBOX
  options       Json? // Array of options for MCQ/Checkbox
  correctAnswer Json? // Correct answer(s)
  marks         Float
  order         Int

  exam    Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers StudentExamAnswer[]

  @@index([examId])
}

model StudentExamAttempt {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  studentId String @db.Uuid

  startTime DateTime  @default(now())
  endTime   DateTime?
  status    String // IN_PROGRESS, COMPLETED, TERMINATED
  score     Float?

  securityViolations Json? // Log of tab switches, etc.

  exam    Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  student Student             @relation(fields: [studentId], references: [userId])
  answers StudentExamAnswer[]

  @@index([examId])
  @@index([studentId])
}

model StudentExamAnswer {
  id         String @id @default(uuid()) @db.Uuid
  attemptId  String @db.Uuid
  questionId String @db.Uuid

  answer        Json // Student's answer
  isCorrect     Boolean?
  marksObtained Float?

  attempt  StudentExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question OnlineExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model ExamHallInvigilator {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  hallId    String @db.Uuid
  teacherId String @db.Uuid

  assignedAt DateTime @default(now())

  exam    Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  hall    ExamHall      @relation(fields: [hallId], references: [id], onDelete: Cascade)
  teacher TeachingStaff @relation(fields: [teacherId], references: [userId])

  @@unique([examId, hallId, teacherId])
}

model HallAttendance {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  hallId    String @db.Uuid
  studentId String @db.Uuid

  status   String // PRESENT, ABSENT
  markedBy String   @db.Uuid // Teacher/Admin ID
  markedAt DateTime @default(now())

  exam    Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  hall    ExamHall @relation(fields: [hallId], references: [id], onDelete: Cascade)
  student Student  @relation(fields: [studentId], references: [userId])

  @@unique([examId, studentId])
  @@index([examId])
  @@index([hallId])
}

model PromotionHistory {
  id        String @id @default(uuid()) @db.Uuid
  studentId String @db.Uuid

  fromClassId Int
  toClassId   Int

  fromYearId String @db.Uuid
  toYearId   String @db.Uuid

  status  String // PROMOTED, DETAINED, CONDITIONAL
  remarks String?

  promotedAt DateTime @default(now())
  promotedBy String   @db.Uuid // User ID of Admin

  student   Student      @relation(fields: [studentId], references: [userId])
  fromClass Class        @relation("PromotionFromClass", fields: [fromClassId], references: [id])
  toClass   Class        @relation("PromotionToClass", fields: [toClassId], references: [id])
  fromYear  AcademicYear @relation("PromotionFromYear", fields: [fromYearId], references: [id])
  toYear    AcademicYear @relation("PromotionToYear", fields: [toYearId], references: [id])
  promoter  User         @relation(fields: [promotedBy], references: [id])

  @@index([studentId])
  @@index([fromClassId])
  @@index([toClassId])
  @@index([fromYearId])
}

// ============================================
// MEDIA LIBRARY SYSTEM
// ============================================

model MediaLibrary {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  url          String // Image URL from UploadThing
  fileName     String
  fileSize     Int // Size in bytes
  mimeType     String // image/png, image/jpeg, etc.
  width        Int? // Image width (optional)
  height       Int? // Image height (optional)
  uploadedById String   @db.Uuid
  uploadedAt   DateTime @default(now())
  tags         Json? // Array for categorization
  altText      String? // Alternative text for accessibility

  // Relations
  school     School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  @@index([schoolId])
  @@index([uploadedById])
  @@index([uploadedAt])
}

// ============================================
// ALUMNI MANAGEMENT
// ============================================

model Alumni {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Original Student Information (preserved)
  originalStudentId String @unique @db.Uuid
  admissionNo       String
  name              String
  email             String
  contactNumber     String

  // Academic Information
  lastClassId      Int
  lastSectionId    Int
  lastAcademicYear String? @db.Uuid

  // Alumni Specific
  graduationYear Int
  leavingDate    DateTime @db.Date
  leavingReason  String // GRADUATED, TRANSFERRED, WITHDRAWN, OTHER

  // Contact Information
  currentAddress String?
  currentCity    String?
  currentState   String?
  currentCountry String?
  currentEmail   String?
  currentPhone   String?

  // Professional Information
  currentOccupation String?
  currentCompany    String?
  higherEducation   String? // University/College name
  achievements      String? // Text field for notable achievements

  // Engagement
  willingToMentor Boolean @default(false)
  canContact      Boolean @default(true)

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school      School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  lastClass   Class   @relation(fields: [lastClassId], references: [id])
  lastSection Section @relation(fields: [lastSectionId], references: [id])

  @@index([schoolId])
  @@index([graduationYear])
  @@index([leavingReason])
  @@index([email])
}
