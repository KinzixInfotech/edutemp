datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model School {
  id                     String                  @id @default(uuid()) @db.Uuid
  name                   String
  domain                 String                  @unique
  schoolCode             String                  @unique
  profilePicture         String
  location               String
  contactNumber          String
  websiteConfig          Json?
  signatureUrl           String?
  stampUrl               String?
  SubscriptionType       String
  Language               String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  deletedAt              DateTime?
  AcademicYear           AcademicYear[]
  admins                 Admin[]
  classes                Class[]
  attendanceDelegations  AttendanceDelegation[]
  exams                  Exam[]
  examHalls              ExamHall[]
  FeePayment             FeePayment[]
  FeeStructure           FeeStructure[]
  gallerySettings        GallerySettings?
  galleryAlbums          GalleryAlbum[]
  InventoryItem          InventoryItem[]
  libraryBooks           LibraryBook[]
  libraryBookRequests    LibraryBookRequest[]
  MasterAdmin            MasterAdmin?
  carouselImages         SchoolCarouselImage[]
  NonTeachingStaff       NonTeachingStaff[]
  Notice                 Notice[]
  Student                Student[]
  StudentFeeStructure    StudentFeeStructure[]
  Syllabus               Syllabus[]
  TeachingStaff          TeachingStaff[]
  // Transport           Transport[]
  users                  User[]
  Vehicle                Vehicle[]
  Route                  Route[]
  Assignment             Assignment[]
  Form                   Form[]
  Application            Application[]
  Stage                  Stage[]
  Upload                 Upload[]
  CertificateTemplate    CertificateTemplate[]
  CertificateGenerated   CertificateGenerated[]
  DigitalIdCard          DigitalIdCard[]
  AdmitCard              AdmitCard[]
  QrVerificationSettings QrVerificationSettings?
  PdfExportSettings      PdfExportSettings?
  Signature              Signature[]
  Stamp                  Stamp[]
  DocumentTemplate       DocumentTemplate[]
  globalFeeStructures    GlobalFeeStructure[]
  studentFees            StudentFee[]
  parents                Parent[]
  calendarEvents         CalendarEvent[]

  attendance              Attendance[]
  attendanceConfig        AttendanceConfig?
  schoolCalendar          SchoolCalendar[]
  leaveRequests           LeaveRequest[]
  leaveBalances           LeaveBalance[]
  attendanceStats         AttendanceStats[]
  bulkAttendance          BulkAttendance[]
  attendanceNotifications AttendanceNotification[]
  homework                Homework[]
  partnerSchools          PartnerSchool[]
  timeSlots               TimeSlot[]
  timetableEntries        TimetableEntry[]
  timetableTemplates      TimetableTemplate[]
  mediaLibraries          MediaLibrary[]
  teacherShifts           TeacherShift[]
  alumni                  Alumni[]
  inventoryCategories     InventoryCategory[]
  inventorySales          InventorySale[]
  publicProfile           SchoolPublicProfile? // School Explorer public profile

  // Payroll Management
  payrollConfig    PayrollConfig?
  salaryStructures SalaryStructure[]
  payrollPeriods   PayrollPeriod[]
  leaveBuckets     LeaveBucket[]
  payrollAuditLogs PayrollAuditLog[]
  librarians       Librarian[]
  accountants      Accountant[]
  directors        Director[]
  principals       Principal[]
  settings         SchoolSettings?
  transportStaffs  TransportStaff[]
  transportFees    TransportFee[]
  busRequests      BusRequest[]
  routeAssignments RouteAssignment[]
  importHistory    ImportHistory[]
  smsWallet        SmsWallet?
  feeSettings      FeeSettings?

  // Transport Auto-Generation
  transportSettings     TransportSettings?
  busServiceSuspensions BusServiceSuspension[]

  // Payment Gateway Settings (Generic)
  paymentSettings SchoolPaymentSettings?
  receipts        Receipt[]

  // AI System
  aiUsageLogs     AiUsageLog[]
  aiInsightCache  AiInsightCache[]
  aiSettings      AiSettings?
  attendanceLocks AttendanceLock[]
  subscription    SchoolSubscription?

  // Biometric System
  biometricDevices       BiometricDevice[]
  biometricIdentityMaps  BiometricIdentityMap[]
  rfidIdentityMaps       RfidIdentityMap[]
  temporaryMappingStates TemporaryMappingState[]
  biometricEvents        BiometricAttendanceEvent[]

  // School Onboarding
  onboardingComplete  Boolean            @default(false)
  onboardingDismissed Boolean            @default(false)
  activityCategories  ActivityCategory[]
  selparameters       SELParameter[]
  hpcreports          HPCReport[]
  termLocks           TermLock[]
  hpcstageTemplates   HPCStageTemplate[]
  payrollSettings     PayrollSettings?

  @@index([name])
}

// ============================================
// SCHOOL SUBSCRIPTION - ERP BILLING & CAPACITY
// ============================================

model SchoolSubscription {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Capacity
  expectedStudents Int
  unitsPurchased   Int // 1 unit = 100 students
  includedCapacity Int // unitsPurchased × 100
  softCapacity     Int // includedCapacity × 1.05 (5% buffer)

  // Pricing (locked at creation)
  pricePerUnit Decimal @default(10500) @db.Decimal(10, 2)
  yearlyAmount Decimal @db.Decimal(10, 2)

  // Billing Period
  billingStartDate DateTime
  billingEndDate   DateTime

  // Trial
  isTrial     Boolean   @default(false)
  trialDays   Int?
  trialEndsAt DateTime?

  // Status
  status      SubscriptionStatus @default(ACTIVE)
  activatedAt DateTime           @default(now())
  renewedAt   DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid // Super Admin who created

  auditLogs SubscriptionAuditLog[]

  @@index([schoolId])
  @@index([status])
  @@index([billingEndDate])
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

model SubscriptionAuditLog {
  id             String             @id @default(uuid()) @db.Uuid
  subscriptionId String             @db.Uuid
  subscription   SchoolSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  action      SubscriptionAction
  performedBy String             @db.Uuid // Super Admin ID

  // Changes
  previousValue Json?
  newValue      Json?
  reason        String?

  createdAt DateTime @default(now())

  @@index([subscriptionId])
  @@index([action])
  @@index([createdAt])
}

enum SubscriptionAction {
  SUBSCRIPTION_CREATED
  CAPACITY_ASSIGNED
  CAPACITY_UPGRADED
  CAPACITY_EXCEEDED
  TRIAL_STARTED
  TRIAL_ENDED
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_SUSPENDED
  SUBSCRIPTION_CANCELLED
  HANDOVER_COMPLETED
}

// ============================================
// IMPORT HISTORY - TRACK BULK IMPORTS
// ============================================

model ImportHistory {
  id              String   @id @default(cuid())
  schoolId        String   @db.Uuid
  module          String // students, teachers, etc.
  fileName        String
  totalRows       Int
  success         Int
  failed          Int
  importedBy      String   @db.Uuid
  createdAt       DateTime @default(now())
  errors          Json? // Store error details as JSON
  accountsCreated Int      @default(0)
  accountsFailed  Int      @default(0)

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [importedBy], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([createdAt])
}

// ============================================
// SCHOOL EXPLORER - PUBLIC DISCOVERY PLATFORM
// ============================================

model SchoolPublicProfile {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // SEO-friendly URL slug (e.g., "dav-public-school-hazaribagh")
  slug String? @unique

  // Visibility
  isPubliclyVisible Boolean @default(false)
  isFeatured        Boolean @default(false)
  isVerified        Boolean @default(false)

  // Basic Info
  tagline     String?
  description String? @db.Text
  vision      String? @db.Text
  mission     String? @db.Text

  // Media
  coverImage String?
  logoImage  String?
  videoUrl   String?

  // Contact
  publicEmail String?
  publicPhone String?
  website     String?

  // Fees
  minFee               Int?
  maxFee               Int?
  feeStructureUrl      String?
  detailedFeeStructure Json?

  // Stats
  establishedYear     Int?
  totalStudents       Int    @default(0)
  totalTeachers       Int    @default(0)
  studentTeacherRatio Float?

  // Ratings
  overallRating        Float @default(0)
  academicRating       Float @default(0)
  infrastructureRating Float @default(0)
  sportsRating         Float @default(0)

  // Metadata
  profileViews      Int      @default(0)
  lastProfileUpdate DateTime @updatedAt
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  achievements SchoolAchievement[]
  facilities   SchoolFacility[]
  badges       SchoolBadge[]
  gallery      SchoolGallery[]
  ratings      SchoolRating[]
  inquiries    AdmissionInquiry[]

  @@index([isPubliclyVisible])
  @@index([isFeatured])
  @@index([overallRating])
  @@index([slug])
}

model SchoolAchievement {
  id        String              @id @default(uuid()) @db.Uuid
  profileId String              @db.Uuid
  profile   SchoolPublicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  title       String
  description String? @db.Text
  category    String // "Academic", "Sports", "Cultural", "Innovation"
  year        Int
  imageUrl    String?
  rank        Int? // e.g., 1st place
  level       String? // "National", "State", "District"

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([category])
  @@index([year])
}

model SchoolFacility {
  id        String              @id @default(uuid()) @db.Uuid
  profileId String              @db.Uuid
  profile   SchoolPublicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  category    String // "Infrastructure", "Lab", "Sports", "Transport"
  name        String
  description String?
  isAvailable Boolean @default(true)
  icon        String?

  @@index([profileId])
  @@index([category])
}

model SchoolBadge {
  id        String              @id @default(uuid()) @db.Uuid
  profileId String              @db.Uuid
  profile   SchoolPublicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  badgeType String // "Tech-Enabled", "Best Sports", "Top Performer"
  earnedAt  DateTime  @default(now())
  expiresAt DateTime?

  @@index([profileId])
}

model SchoolGallery {
  id        String              @id @default(uuid()) @db.Uuid
  profileId String              @db.Uuid
  profile   SchoolPublicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  imageUrl     String
  caption      String?
  category     String? // "Campus", "Events", "Labs", "Sports"
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())

  @@index([profileId])
  @@index([category])
}

model SchoolRating {
  id        String              @id @default(uuid()) @db.Uuid
  profileId String              @db.Uuid
  profile   SchoolPublicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Authentication & Verification
  userId     String? @db.Uuid // Supabase auth user ID
  parentId   String? @db.Uuid // Link to Parent table (optional, for verification)
  isVerified Boolean @default(false) // Auto-set to true if parentId exists
  parentName String? // Display name for the review

  // Ratings
  academicRating       Float
  infrastructureRating Float
  teacherRating        Float
  sportsRating         Float
  overallRating        Float
  review               String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, userId]) // One review per user per school
  @@index([profileId])
  @@index([userId])
}

model AdmissionInquiry {
  id        String              @id @default(uuid()) @db.Uuid
  profileId String              @db.Uuid
  profile   SchoolPublicProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Student Info
  studentName    String
  studentAge     Int?
  preferredGrade String

  // Parent Info
  parentName  String
  parentEmail String
  parentPhone String

  // Additional
  message String? @db.Text
  source  String? // "Website", "Directory", "Comparison"

  // Status
  status     String  @default("New") // "New", "Contacted", "Scheduled", "Converted", "Closed"
  assignedTo String? @db.Uuid
  notes      String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// CHANNEL PARTNER PROGRAM SYSTEM
// ============================================

// Partner Roles
enum PartnerRole {
  AFFILIATE
  RESELLER
  ENTERPRISE
}

// Partner Levels
enum PartnerLevel {
  SILVER
  GOLD
  PLATINUM
}

// Partner Status
enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
}

// Lead Status
enum LeadStatus {
  NEW
  IN_PROGRESS
  DEMO_SCHEDULED
  CONVERTED
  REJECTED
}

// Payout Status
enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Commission Type
enum CommissionType {
  ONBOARDING
  RENEWAL
  UPGRADE
  BONUS
}

// Main Partner Model
model Partner {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Partner Details
  role   PartnerRole   @default(AFFILIATE)
  level  PartnerLevel  @default(SILVER)
  status PartnerStatus @default(PENDING)

  // Business Information
  companyName  String?
  businessType String?
  gstin        String? @unique
  panNumber    String? @unique

  // Contact Information
  contactPerson  String
  contactEmail   String  @unique
  contactPhone   String
  alternatePhone String?
  address        String
  city           String
  state          String
  country        String  @default("India")
  postalCode     String

  // Commission Configuration
  commissionRate Float @default(10) // Percentage
  renewalRate    Float @default(5) // Percentage

  // Referral Information
  referralCode String  @unique
  referralLink String
  qrCodeUrl    String?

  // Account Manager
  accountManagerId String? @db.Uuid
  accountManager   User?   @relation("PartnerAccountManager", fields: [accountManagerId], references: [id])

  // KYC & Banking
  kycStatus     String  @default("PENDING") // PENDING, VERIFIED, REJECTED
  kycDocuments  Json? // Array of document URLs
  bankName      String?
  accountNumber String?
  ifscCode      String?
  accountHolder String?
  upiId         String?

  // Statistics
  totalLeads      Int   @default(0)
  convertedLeads  Int   @default(0)
  totalRevenue    Float @default(0)
  totalCommission Float @default(0)

  // Approval Details
  approvedBy     String?   @db.Uuid
  approvedAt     DateTime?
  rejectedReason String?

  // System Fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  leads       PartnerLead[]
  schools     PartnerSchool[]
  commissions PartnerCommission[]
  payouts     PartnerPayout[]
  activities  PartnerActivity[]

  @@index([userId])
  @@index([status])
  @@index([level])
  @@index([referralCode])
  @@index([contactEmail])
}

// Partner Leads Management
model PartnerLead {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Lead Information
  schoolName     String
  contactPerson  String
  contactPhone   String
  contactEmail   String
  alternatePhone String?
  address        String?
  city           String?
  state          String?
  postalCode     String?

  // Lead Details
  estimatedStudents Int?
  currentSystem     String?
  notes             String? @db.Text

  // Status & Assignment
  status       LeadStatus @default(NEW)
  assignedToId String?    @db.Uuid
  assignedTo   User?      @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  // Conversion Details
  convertedAt       DateTime?
  convertedSchoolId String?   @db.Uuid
  rejectedReason    String?

  // Follow-up
  lastFollowUp    DateTime?
  nextFollowUp    DateTime?
  demoScheduledAt DateTime?

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activities LeadActivity[]

  @@index([partnerId])
  @@index([status])
  @@index([contactEmail])
  @@index([assignedToId])
}

// Lead Activity Log
model LeadActivity {
  id     String      @id @default(uuid()) @db.Uuid
  leadId String      @db.Uuid
  lead   PartnerLead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  activityType String // STATUS_CHANGE, FOLLOW_UP, DEMO, NOTES
  description  String  @db.Text
  oldStatus    String?
  newStatus    String?
  performedBy  String? @db.Uuid

  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
}

// Partner-School Relationship
model PartnerSchool {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  schoolId  String  @db.Uuid
  school    School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Onboarding Details
  onboardedAt      DateTime @default(now())
  subscriptionPlan String
  planStartDate    DateTime
  planEndDate      DateTime
  renewalDate      DateTime

  // Revenue & Commission
  subscriptionAmount Float
  commissionRate     Float
  commissionAmount   Float

  // Status
  isActive     Boolean @default(true)
  renewalCount Int     @default(0)

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, schoolId])
  @@index([partnerId])
  @@index([schoolId])
  @@index([renewalDate])
}

// Commission Management
model PartnerCommission {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Commission Details
  type       CommissionType @default(ONBOARDING)
  schoolId   String?        @db.Uuid
  schoolName String

  // Amounts
  revenueAmount    Float
  commissionRate   Float
  commissionAmount Float

  // Status
  isPaid   Boolean        @default(false)
  paidAt   DateTime?
  payoutId String?        @db.Uuid
  payout   PartnerPayout? @relation(fields: [payoutId], references: [id])

  // Period
  periodMonth Int
  periodYear  Int

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([partnerId])
  @@index([isPaid])
  @@index([periodMonth, periodYear])
}

// Payout Management
model PartnerPayout {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // Payout Details
  amount        Float
  commissionIds String[] // Array of commission IDs

  // Payment Information
  paymentMethod   String // BANK_TRANSFER, UPI, CHEQUE
  transactionId   String?
  referenceNumber String?
  utrNumber       String?

  // Status
  status       PayoutStatus @default(PENDING)
  requestedAt  DateTime     @default(now())
  processedAt  DateTime?
  completedAt  DateTime?
  failedReason String?

  // Processed By
  processedBy String? @db.Uuid

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  commissions PartnerCommission[]

  @@index([partnerId])
  @@index([status])
  @@index([requestedAt])
}

// Marketing Assets
model MarketingAsset {
  id String @id @default(uuid()) @db.Uuid

  // Asset Details
  title       String
  description String? @db.Text
  type        String // PITCH_DECK, BROCHURE, PRICING, VIDEO, IMAGE
  category    String? // SALES, MARKETING, TRAINING

  // File Information
  fileUrl      String
  fileName     String
  fileSize     Int?
  mimeType     String?
  thumbnailUrl String?

  // Access Control
  isActive      Boolean  @default(true)
  partnerLevels String[] // ["SILVER", "GOLD", "PLATINUM"]

  // Metadata
  downloadCount Int     @default(0)
  version       String? @default("1.0")

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([isActive])
}

// Partner Activity Log
model PartnerActivity {
  id        String  @id @default(uuid()) @db.Uuid
  partnerId String  @db.Uuid
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  activityType String // LOGIN, LEAD_ADDED, PAYOUT_REQUEST, PROFILE_UPDATE
  description  String  @db.Text
  metadata     Json?
  ipAddress    String?

  createdAt DateTime @default(now())

  @@index([partnerId])
  @@index([createdAt])
}

// Commission Slabs Configuration
model CommissionSlab {
  id String @id @default(uuid()) @db.Uuid

  // Slab Details
  name       String
  level      PartnerLevel
  minRevenue Float        @default(0)
  maxRevenue Float?

  // Rates
  onboardingRate Float // Percentage
  renewalRate    Float // Percentage
  upgradeRate    Float // Percentage

  // Conditions
  minSchools Int     @default(0)
  isActive   Boolean @default(true)

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([level])
  @@index([isActive])
}

// Global Form Builder
enum FormCategory {
  ADMISSION
  SURVEY
  FEEDBACK
  GENERAL
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Form {
  id          String       @id @default(uuid()) @db.Uuid
  schoolId    String       @db.Uuid
  title       String
  description String?
  slug        String?      @unique
  category    FormCategory @default(GENERAL)
  status      FormStatus   @default(DRAFT)
  settings    Json? // { isPublic: boolean, allowMultiple: boolean, notifications: [] }
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  fields       FormField[]
  applications Application[] // Submissions

  @@index([schoolId])
  @@index([slug])
  @@index([category])
}

model FormField {
  id       String  @id @default(uuid()) @db.Uuid
  formId   String  @db.Uuid
  name     String
  type     String // e.g., "text", "email", "file", "select"
  required Boolean @default(false)
  options  Json? // for select fields
  order    Int

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
}

model Application {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  formId         String   @db.Uuid
  applicantName  String
  applicantEmail String
  data           Json
  submittedAt    DateTime @default(now())
  currentStageId String?  @db.Uuid // Optional for non-admission forms
  createdById    String?  @db.Uuid

  school       School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  form         Form                  @relation(fields: [formId], references: [id], onDelete: Cascade)
  currentStage Stage?                @relation("CurrentStage", fields: [currentStageId], references: [id])
  createdBy    User?                 @relation(fields: [createdById], references: [id])
  documents    ApplicationDocument[]
  stageHistory StageHistory[]
  payments     Payment[]

  @@unique([schoolId, formId, applicantEmail])
}

model ApplicationDocument {
  id            String      @id @default(uuid()) @db.Uuid
  applicationId String      @db.Uuid
  fileUrl       String
  fileName      String
  mimeType      String
  size          Int
  uploadedAt    DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model Stage {
  id                String  @id @default(uuid()) @db.Uuid
  schoolId          String  @db.Uuid // Made required
  name              String // Changed from Enum to String
  type              String  @default("CUSTOM") // SYSTEM or CUSTOM
  order             Int
  requiresTest      Boolean @default(false)
  requiresInterview Boolean @default(false)
  feeRequired       Boolean @default(false)

  currentApplications Application[]  @relation("CurrentStage")
  stageHistory        StageHistory[]
  School              School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@unique([schoolId, order])
  @@index([schoolId])
}

model StageHistory {
  id            String   @id @default(uuid()) @db.Uuid
  applicationId String   @db.Uuid
  stageId       String   @db.Uuid
  movedById     String?  @db.Uuid
  movedAt       DateTime @default(now())
  notes         String?

  // Stage-specific fields
  testPassed    Boolean?
  testScore     Float?
  testDate      DateTime?
  interviewDate DateTime?
  testStartTime DateTime?
  testEndTime   DateTime?
  testVenue     String?

  interviewNotes String?

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stage       Stage       @relation(fields: [stageId], references: [id])
  movedBy     User?       @relation(fields: [movedById], references: [id])

  @@index([applicationId])
  @@index([movedAt])
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  applicationId String?       @db.Uuid
  amount        Float
  status        PaymentStatus @default(PENDING)
  transactionId String?
  paidAt        DateTime?
  application   Application?  @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
}

// Note: Use PostgreSQL provider as in current schema.
// Transport Models
model Vehicle {
  id                 String              @id @default(uuid()) @db.Uuid
  schoolId           String              @db.Uuid
  licensePlate       String              @unique
  model              String
  capacity           Int
  maintenanceDue     DateTime?
  fuelType           String? // e.g., DIESEL, PETROL, CNG, EV
  mileage            Float? // km/l or km/charge
  rcNumber           String?
  rcExpiry           DateTime?
  insuranceNumber    String?
  insuranceExpiry    DateTime?
  pucNumber          String?
  pucExpiry          DateTime?
  status             String // e.g., "active", "maintenance", "inactive"
  trackingStatus     String?             @default("OFFLINE") // MOVING, IDLE, OFFLINE
  lastLocationTime   DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  school             School              @relation(fields: [schoolId], references: [id])
  routes             Route[]
  locations          VehicleLocation[]
  vehicleAssignments VehicleAssignment[]
  busTrips           BusTrip[]
  routeAssignments   RouteAssignment[]

  @@index([schoolId])
  @@index([licensePlate])
}

model Route {
  id                     String                   @id @default(uuid()) @db.Uuid
  schoolId               String                   @db.Uuid
  name                   String
  stops                  Json // Array of {name: string, lat: float, lng: float}
  assignedVehicleId      String?                  @db.Uuid
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  school                 School                   @relation(fields: [schoolId], references: [id])
  vehicle                Vehicle?                 @relation(fields: [assignedVehicleId], references: [id])
  studentAssignments     StudentRouteAssignment[]
  busStops               BusStop[]
  studentStopAssignments StudentStopAssignment[]
  busTrips               BusTrip[]
  busAttendances         BusAttendance[]
  transportFees          TransportFee[]
  busRequests            BusRequest[]
  routeAssignment        RouteAssignment?

  @@index([schoolId])
  @@index([name])
}

model StudentRouteAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @db.Uuid
  routeId    String   @db.Uuid
  schoolId   String   @db.Uuid
  assignedAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [userId])
  route      Route    @relation(fields: [routeId], references: [id])

  @@index([studentId])
  @@index([routeId])
}

model VehicleLocation {
  id               String          @id @default(uuid()) @db.Uuid
  vehicleId        String          @db.Uuid
  tripId           String?         @db.Uuid
  transportStaffId String?         @db.Uuid
  latitude         Float
  longitude        Float
  speed            Float?
  heading          Float?
  accuracy         Float?
  timestamp        DateTime        @default(now())
  vehicle          Vehicle         @relation(fields: [vehicleId], references: [id])
  trip             BusTrip?        @relation(fields: [tripId], references: [id])
  transportStaff   TransportStaff? @relation(fields: [transportStaffId], references: [id])

  @@index([vehicleId])
  @@index([tripId])
  @@index([timestamp])
}

// ============================================
// TRANSPORT MODULE - ENHANCED
// ============================================

enum TransportRole {
  DRIVER
  CONDUCTOR
}

// Transport Staff (Drivers & Conductors)
model TransportStaff {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @unique @db.Uuid
  schoolId         String        @db.Uuid
  role             TransportRole
  employeeId       String
  name             String
  contactNumber    String
  email            String
  licenseNumber    String? // For drivers only
  licenseExpiry    DateTime?
  address          String?
  emergencyContact String?
  profilePicture   String?
  isActive         Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user                      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  school                    School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  vehicleAssignments        VehicleAssignment[]
  attendanceRecords         BusAttendance[]     @relation("BusAttendanceMarkedBy")
  locationUpdates           VehicleLocation[]
  driverTrips               BusTrip[]           @relation("TripDriver")
  conductorTrips            BusTrip[]           @relation("TripConductor")
  driverRouteAssignments    RouteAssignment[]   @relation("RouteAssignmentDriver")
  conductorRouteAssignments RouteAssignment[]   @relation("RouteAssignmentConductor")

  @@unique([schoolId, employeeId])
  @@index([schoolId])
  @@index([role])
  @@index([isActive])
}

// Vehicle Assignment (Driver/Conductor to Vehicle)
model VehicleAssignment {
  id               String        @id @default(uuid()) @db.Uuid
  vehicleId        String        @db.Uuid
  transportStaffId String        @db.Uuid
  role             TransportRole
  isActive         Boolean       @default(true)
  assignedAt       DateTime      @default(now())

  vehicle        Vehicle        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  transportStaff TransportStaff @relation(fields: [transportStaffId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, transportStaffId, role])
  @@index([vehicleId])
  @@index([transportStaffId])
  @@index([isActive])
}

// Permanent Route Assignment (Driver/Conductor to Route)
model RouteAssignment {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  routeId     String   @unique @db.Uuid // One assignment per route
  vehicleId   String   @db.Uuid
  driverId    String   @db.Uuid
  conductorId String?  @db.Uuid
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school    School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  route     Route           @relation(fields: [routeId], references: [id], onDelete: Cascade)
  vehicle   Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver    TransportStaff  @relation("RouteAssignmentDriver", fields: [driverId], references: [id])
  conductor TransportStaff? @relation("RouteAssignmentConductor", fields: [conductorId], references: [id])

  @@index([schoolId])
  @@index([driverId])
  @@index([isActive])
}

// Transport Settings for Auto-Generation
model TransportSettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Auto-generation settings
  autoGenerateTrips     Boolean @default(true)
  generateDaysInAdvance Int     @default(1) // Generate X days ahead
  generateTime          String  @default("06:00") // Time to auto-generate (for cron)

  // Weekly schedule (which days bus service operates)
  // Store as array: ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"]
  operatingDays String[] @default(["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Bus Service Suspension - Emergency disable for specific dates
model BusServiceSuspension {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Suspension period
  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  // Reason and metadata
  reason    String
  createdBy String   @db.Uuid
  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([startDate, endDate])
}

// Bus Stop with schedule
model BusStop {
  id         String   @id @default(uuid()) @db.Uuid
  routeId    String   @db.Uuid
  name       String
  latitude   Float
  longitude  Float
  orderIndex Int // Order in route
  pickupTime String? // e.g., "07:30"
  dropTime   String? // e.g., "14:30"
  address    String?
  landmark   String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  route              Route                   @relation(fields: [routeId], references: [id], onDelete: Cascade)
  studentAssignments StudentStopAssignment[]
  attendanceRecords  BusAttendance[]

  @@unique([routeId, orderIndex])
  @@index([routeId])
  @@index([isActive])
}

// Student assigned to specific stop
model StudentStopAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @db.Uuid
  stopId     String   @db.Uuid
  routeId    String   @db.Uuid
  pickupStop Boolean  @default(true)
  dropStop   Boolean  @default(true)
  isActive   Boolean  @default(true)
  assignedAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  stop    BusStop @relation(fields: [stopId], references: [id], onDelete: Cascade)
  route   Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([studentId, routeId])
  @@index([studentId])
  @@index([stopId])
  @@index([routeId])
  @@index([isActive])
}

// Bus Trip (daily trip tracking)
model BusTrip {
  id          String    @id @default(uuid()) @db.Uuid
  vehicleId   String    @db.Uuid
  routeId     String    @db.Uuid
  driverId    String    @db.Uuid
  conductorId String?   @db.Uuid
  tripType    String // PICKUP, DROP
  status      String // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  date        DateTime  @db.Date
  startedAt   DateTime?
  completedAt DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  vehicle           Vehicle           @relation(fields: [vehicleId], references: [id])
  route             Route             @relation(fields: [routeId], references: [id])
  driver            TransportStaff    @relation("TripDriver", fields: [driverId], references: [id])
  conductor         TransportStaff?   @relation("TripConductor", fields: [conductorId], references: [id])
  attendanceRecords BusAttendance[]
  locationLog       VehicleLocation[]

  @@unique([vehicleId, routeId, tripType, date])
  @@index([vehicleId])
  @@index([routeId])
  @@index([driverId])
  @@index([conductorId])
  @@index([date])
  @@index([status])
}

// Bus Attendance (per trip per student)
model BusAttendance {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @db.Uuid
  routeId    String   @db.Uuid
  stopId     String   @db.Uuid
  tripId     String   @db.Uuid
  tripType   String // PICKUP, DROP
  status     String // PRESENT, ABSENT, LATE, EXCUSED
  markedById String   @db.Uuid
  markedAt   DateTime @default(now())
  latitude   Float? // Location when marked
  longitude  Float?
  notes      String?

  student  Student        @relation(fields: [studentId], references: [userId])
  route    Route          @relation(fields: [routeId], references: [id])
  stop     BusStop        @relation(fields: [stopId], references: [id])
  trip     BusTrip        @relation(fields: [tripId], references: [id])
  markedBy TransportStaff @relation("BusAttendanceMarkedBy", fields: [markedById], references: [id])

  @@unique([studentId, tripId])
  @@index([studentId])
  @@index([tripId])
  @@index([stopId])
  @@index([markedAt])
  @@index([status])
}

// Transport Fee Structure
model TransportFee {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  routeId        String?  @db.Uuid
  name           String
  amount         Float
  frequency      String // MONTHLY, QUARTERLY, HALF_YEARLY, YEARLY
  academicYearId String?  @db.Uuid
  description    String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  school       School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  route        Route?                @relation(fields: [routeId], references: [id])
  academicYear AcademicYear?         @relation(fields: [academicYearId], references: [id])
  studentFees  StudentTransportFee[]

  @@index([schoolId])
  @@index([routeId])
  @@index([isActive])
}

// Student Transport Fee Assignment
model StudentTransportFee {
  id             String    @id @default(uuid()) @db.Uuid
  studentId      String    @db.Uuid
  transportFeeId String    @db.Uuid
  startDate      DateTime
  endDate        DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())

  student      Student               @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  transportFee TransportFee          @relation(fields: [transportFeeId], references: [id], onDelete: Cascade)
  payments     TransportFeePayment[]

  @@unique([studentId, transportFeeId])
  @@index([studentId])
  @@index([transportFeeId])
  @@index([isActive])
}

// Transport Fee Payment
model TransportFeePayment {
  id                    String   @id @default(uuid()) @db.Uuid
  studentTransportFeeId String   @db.Uuid
  amount                Float
  paymentDate           DateTime
  paymentMethod         String // CASH, ONLINE, CHEQUE, UPI
  transactionId         String?
  status                String // PAID, PENDING, FAILED, REFUNDED
  collectedById         String?  @db.Uuid
  receiptNumber         String?
  notes                 String?
  createdAt             DateTime @default(now())

  studentTransportFee StudentTransportFee @relation(fields: [studentTransportFeeId], references: [id], onDelete: Cascade)

  @@index([studentTransportFeeId])
  @@index([paymentDate])
  @@index([status])
}

// Bus Request from Parent
model BusRequest {
  id            String    @id @default(uuid()) @db.Uuid
  studentId     String    @db.Uuid
  parentId      String    @db.Uuid
  schoolId      String    @db.Uuid
  routeId       String?   @db.Uuid
  stopId        String?   @db.Uuid
  requestType   String // NEW, CHANGE_STOP, CHANGE_ROUTE, CANCEL
  status        String // PENDING, APPROVED, REJECTED, IN_REVIEW
  preferredStop String?
  stopLatitude  Float?
  stopLongitude Float?
  reason        String?
  notes         String?
  processedById String?   @db.Uuid
  processedAt   DateTime?
  adminNotes    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  student Student @relation(fields: [studentId], references: [userId])
  parent  Parent  @relation(fields: [parentId], references: [id])
  school  School  @relation(fields: [schoolId], references: [id])
  route   Route?  @relation(fields: [routeId], references: [id])

  @@index([studentId])
  @@index([parentId])
  @@index([schoolId])
  @@index([status])
  @@index([createdAt])
}

model Assignment {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  classId     Int
  title       String
  description String?
  dueDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  school      School   @relation(fields: [schoolId], references: [id])
  class       Class    @relation(fields: [classId], references: [id])

  @@index([schoolId])
  @@index([classId])
  @@index([dueDate])
}

model InventoryItem {
  id              String   @id @default(uuid())
  name            String
  category        String? // Optional for backward compatibility, prefer categoryId
  categoryId      String?  @db.Uuid
  schoolId        String   @db.Uuid
  description     String?
  imageUrl        String? // Product image
  quantity        Int
  minimumQuantity Int
  maximumQuantity Int
  unit            String
  purchaseDate    DateTime
  costPerUnit     Float
  sellingPrice    Float?   @default(0)
  isSellable      Boolean  @default(false)
  vendorName      String
  vendorContact   String
  warrantyPeriod  String?
  location        String
  status          String
  barcode         String?
  notes           String?

  School            School                 @relation(fields: [schoolId], references: [id])
  InventoryCategory InventoryCategory?     @relation(fields: [categoryId], references: [id])
  transactions      InventoryTransaction[]
  purchaseOrders    PurchaseOrderItem[]
  saleItems         InventorySaleItem[]
}

model InventoryCategory {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items  InventoryItem[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model InventorySale {
  id            String   @id @default(uuid()) @db.Uuid
  schoolId      String   @db.Uuid
  buyerName     String
  buyerId       String?  @db.Uuid // Optional link to User/Student
  buyerType     String? // STUDENT, STAFF, EXTERNAL
  totalAmount   Float
  paymentMethod String // CASH, ONLINE, ETC
  status        String // COMPLETED, REFUNDED
  saleDate      DateTime @default(now())

  school School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items  InventorySaleItem[]

  @@index([schoolId])
  @@index([saleDate])
}

model InventorySaleItem {
  id         String @id @default(uuid()) @db.Uuid
  saleId     String @db.Uuid
  itemId     String
  quantity   Int
  unitPrice  Float
  totalPrice Float

  sale InventorySale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  item InventoryItem @relation(fields: [itemId], references: [id])
}

model Syllabus {
  id             String        @id @default(uuid())
  academicYearId String?       @db.Uuid
  filename       String
  fileUrl        String
  uploadedAt     DateTime      @default(now())
  schoolId       String        @db.Uuid
  classId        Int?
  AcademicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  Class          Class?        @relation(fields: [classId], references: [id])
  School         School        @relation(fields: [schoolId], references: [id])
}

model InventoryTransaction {
  id              String        @id @default(uuid())
  itemId          String
  transactionType String
  quantity        Int
  date            DateTime
  issuedToId      String?
  issuedToName    String?
  handledById     String
  handledByName   String
  remarks         String?
  status          String
  item            InventoryItem @relation(fields: [itemId], references: [id])
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  orderDate        DateTime
  expectedDelivery DateTime
  vendorName       String
  vendorContact    String
  approvedById     String
  approvedByName   String
  status           String
  items            PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  itemId          String
  name            String
  quantity        Int
  costPerUnit     Float
  item            InventoryItem @relation(fields: [itemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
}

model Notice {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Basic Info
  title       String
  description String  @db.Text // Changed to Text for long content
  subtitle    String? // NEW: For preview text

  // File Management
  fileUrl     String?
  attachments Json? // NEW: Array of multiple attachments

  // Categorization
  category NoticeCategory // NEW: Enum instead of String
  audience Audience       @default(ALL)
  priority Priority       @default(NORMAL)
  status   Status         @default(DRAFT)

  // Author Info
  createdById String? @db.Uuid
  issuedBy    String? // NEW: Display name
  issuerRole  String? // NEW: "Science Department Head"

  // Dates & Times
  publishedAt DateTime?
  expiryDate  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt

  // Important Dates (for trips, deadlines, etc.)
  importantDates Json? // NEW: [{label: string, value: string}]

  // Read Status Tracking
  viewCount Int @default(0) // NEW: Track views

  // Relations
  Author       User?          @relation(fields: [createdById], references: [id])
  School       School         @relation(fields: [schoolId], references: [id])
  NoticeTarget NoticeTarget[]
  NoticeReads  NoticeRead[] // NEW: Track who read it

  @@index([schoolId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([publishedAt])
  @@index([expiryDate])
}

model NoticeTarget {
  id       String @id @default(uuid()) @db.Uuid
  noticeId String @db.Uuid

  // Targeting Options
  classId   Int?
  sectionId Int?
  roleId    Int? // NEW: Target specific roles
  userId    String? @db.Uuid // NEW: Target specific users

  Class   Class?   @relation(fields: [classId], references: [id])
  Notice  Notice   @relation(fields: [noticeId], references: [id])
  Section Section? @relation(fields: [sectionId], references: [id])
  Role    Role?    @relation(fields: [roleId], references: [id]) // NEW
  User    User?    @relation("NoticeTargetUser", fields: [userId], references: [id]) // NEW

  @@index([noticeId])
  @@index([classId])
  @@index([sectionId])
  @@index([roleId])
  @@index([userId])
}

// NEW: Track read status for each user
model NoticeRead {
  id       String   @id @default(uuid()) @db.Uuid
  noticeId String   @db.Uuid
  userId   String   @db.Uuid
  readAt   DateTime @default(now())

  Notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  User   User   @relation("NoticeReads", fields: [userId], references: [id])

  @@unique([noticeId, userId])
  @@index([noticeId])
  @@index([userId])
  @@index([readAt])
}

// Enhanced Enums
enum NoticeCategory {
  GENERAL
  ACADEMIC
  EXAM
  EMERGENCY
  EVENT
  SPORTS
  HOLIDAY
  FEE
  TRANSPORT
  LIBRARY
  ANNOUNCEMENT
}

enum Audience {
  ALL
  STUDENTS
  TEACHERS
  PARENTS
  STAFF // Added
  TEACHING_STAFF // Added
  NON_TEACHING_STAFF // Added
  ADMINS // Added
  CLASS
  SECTION
  CUSTOM // Added for specific users
}

enum Priority {
  NORMAL
  IMPORTANT
  URGENT
  CRITICAL // Added
}

enum Status {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED // Added for future publishing
  EXPIRED // Added for auto-expiry
}

model Role {
  id                   Int                   @id @default(autoincrement())
  name                 String                @unique
  users                User[]
  noticeTargets        NoticeTarget[]
  calendarEventTargets CalendarEventTarget[]
}

model User {
  id             String      @id @db.Uuid
  schoolId       String?     @db.Uuid
  roleId         Int
  email          String      @unique
  password       String
  name           String?
  gender         String      @default("Unknown")
  profilePicture String      @default("default.png")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  deletedAt      DateTime?
  status         UserStatus  @default(ACTIVE)
  Admin          Admin?
  librarian      Librarian?
  accountant     Accountant?
  director       Director?
  principal      Principal?
  fcmToken       String?

  AuditLog              AuditLog[]
  Document              Document[]
  MasterAdmin           MasterAdmin?
  nonTeachingStaff      NonTeachingStaff?
  Notice                Notice[]
  receivedNotifications Notification[]         @relation("NotificationReceiver")
  sentNotifications     Notification[]         @relation("NotificationSender")
  student               Student?
  teacher               TeachingStaff?
  role                  Role                   @relation(fields: [roleId], references: [id])
  school                School?                @relation(fields: [schoolId], references: [id])
  Application           Application[]
  StageHistory          StageHistory[]
  GmailAccount          GmailAccount[]
  CertificateTemplate   CertificateTemplate[]
  CertificateGenerated  CertificateGenerated[]
  DocumentTemplate      DocumentTemplate[]
  NoticeReads           NoticeRead[]           @relation("NoticeReads")
  NoticeTargets         NoticeTarget[]         @relation("NoticeTargetUser")
  approvedDiscounts     FeeDiscount[]          @relation("ApprovedDiscounts")
  collectedPayments     FeePayment[]           @relation("CollectedPayments")
  parent                Parent?
  calendarEvents        CalendarEvent[]
  calendarEventTargets  CalendarEventTarget[]
  createdDelegations    AttendanceDelegation[] @relation("DelegationCreator")

  attendance              Attendance[]
  markedAttendance        Attendance[]             @relation("MarkedBy")
  promotionsInitiated     PromotionHistory[]
  approvedAttendance      Attendance[]             @relation("ApprovedBy")
  leaveRequests           LeaveRequest[]
  reviewedLeaves          LeaveRequest[]           @relation("LeaveReviewer")
  leaveBalances           LeaveBalance[]
  attendanceStats         AttendanceStats[]
  bulkAttendanceRecords   BulkAttendance[]
  attendanceNotifications AttendanceNotification[] @relation("AttendanceNotifications")
  partner                 Partner?
  managedPartners         Partner[]                @relation("PartnerAccountManager")
  assignedLeads           PartnerLead[]            @relation("LeadAssignedTo")
  uploadedMedia           MediaLibrary[]

  // Session Management
  sessions       UserSession[]
  securityEvents SecurityEvent[]

  // Payroll Management
  payrollProfile  EmployeePayrollProfile?
  transportStaff  TransportStaff?
  importHistories ImportHistory[]

  // AI System
  aiUsageLogs AiUsageLog[]

  // Hall Ticket & Attendance Lock Management
  hallTicketOverrides     AdmitCard[]             @relation("HallTicketOverride")
  attendanceLocksLocked   AttendanceLock[]        @relation("AttendanceLockedBy")
  attendanceLocksUnlocked AttendanceLock[]        @relation("AttendanceUnlockedBy")
  admitCards              AdmitCard[]
  schoolCarouselImages    SchoolCarouselImage[]
  uploadedCarouselImages  SchoolCarouselImage[]   @relation("UserUploadedCarouselImages")
  competencyAssessments   CompetencyAssessment[]  @relation("CompetencyAssessor")
  studentActivityRecords  StudentActivityRecord[] @relation("ActivityRecorder")
  selassessments          SELAssessment[]         @relation("SELAssessor")
  hpcreports              HPCReport[]             @relation("HPCGenerator")

  // Gallery System
  createdGalleryAlbums  GalleryAlbum[]             @relation("GalleryAlbumCreator")
  uploadedGalleryImages GalleryImage[]             @relation("GalleryImageUploader")
  approvedGalleryImages GalleryImage[]             @relation("GalleryImageApprover")
  biometricIdentityMaps BiometricIdentityMap[]
  rfidIdentityMaps      RfidIdentityMap[]
  biometricEvents       BiometricAttendanceEvent[] @relation("ResolvedBiometricEvents")

  @@index([schoolId])
  @@index([roleId])
}

// model GmailAccount {
//   id           String   @id @default(uuid())
//   userId       String   @db.Uuid
//   email        String
//   accessToken  String
//   refreshToken String
//   createdAt    DateTime @default(now())
//   updatedAt    DateTime @updatedAt

//   user User @relation(fields: [userId], references: [id])

//   @@unique([userId, email]) // A user can’t have duplicate Gmail accounts
// }
model GmailAccount {
  id           String   @id @default(uuid())
  userId       String   @db.Uuid
  email        String
  accessToken  String
  refreshToken String
  name         String? // Optional: for display name
  avatar       String? // Optional: for avatar URL
  lastUsedAt   DateTime @default(now()) // NEW: Track last usage
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, email])
}

model Admin {
  userId   String @id @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])
  User     User   @relation(fields: [userId], references: [id])
}

model MasterAdmin {
  userId   String @id @unique @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])
  User     User   @relation(fields: [userId], references: [id])
}

model Librarian {
  userId      String    @id @db.Uuid
  schoolId    String    @db.Uuid
  permissions Json? // Flexible permission structure
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  school      School    @relation(fields: [schoolId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([schoolId])
}

model Accountant {
  userId      String    @id @db.Uuid
  schoolId    String    @db.Uuid
  permissions Json? // Flexible permission structure
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  school      School    @relation(fields: [schoolId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([schoolId])
}

model Student {
  userId             String  @id @db.Uuid
  classId            Int
  parentId           String? @db.Uuid
  name               String
  email              String
  dob                String
  gender             String
  admissionDate      String
  sectionId          Int
  bloodGroup         String
  rollNumber         String
  PreviousSchoolName String?

  DateOfLeaving    String?
  contactNumber    String
  Address          String
  city             String
  state            String
  country          String
  postalCode       String
  FatherName       String
  MotherName       String
  FatherNumber     String?
  MotherNumber     String?
  GuardianName     String?
  GuardianRelation String?
  House            String?
  admissionNo      String  @unique
  schoolId         String  @db.Uuid
  academicYearId   String? @db.Uuid

  // Alumni Tracking
  isAlumni          Boolean   @default(false)
  alumniConvertedAt DateTime?

  ExamIssue              ExamIssue[]
  examResults            ExamResult[]
  FeePayment             FeePayment[]
  FeeStructure           FeeStructure[]
  HomeworkSubmission     HomeworkSubmission[]
  AcademicYear           AcademicYear?            @relation(fields: [academicYearId], references: [id])
  class                  Class                    @relation(fields: [classId], references: [id])
  school                 School                   @relation(fields: [schoolId], references: [id])
  section                Section                  @relation(fields: [sectionId], references: [id])
  user                   User                     @relation(fields: [userId], references: [id])
  StudentFeeStructure    StudentFeeStructure[]
  StudentRouteAssignment StudentRouteAssignment[]
  CertificateGenerated   CertificateGenerated[]
  DigitalIdCard          DigitalIdCard[]
  AdmitCard              AdmitCard[]
  studentFees            StudentFee[]
  feeReminders           FeeReminder[]
  studentParentLinks     StudentParentLink[]
  seatAllocations        SeatAllocation[]
  studentExamAttempts    StudentExamAttempt[]
  hallAttendances        HallAttendance[]
  promotionHistories     PromotionHistory[]
  studentStopAssignments StudentStopAssignment[]
  busAttendances         BusAttendance[]
  studentTransportFees   StudentTransportFee[]
  busRequests            BusRequest[]
  receipts               Receipt[]
  competencyAssessments  CompetencyAssessment[]
  studentActivityRecords StudentActivityRecord[]
  selassessments         SELAssessment[]
  studentReflections     StudentReflection[]
  teacherFeedbacks       TeacherFeedback[]
  parentFeedbacks        ParentFeedback[]
  hpcreports             HPCReport[]

  @@index([classId])
  @@index([sectionId])
  @@index([parentId])
}

// ============================================
// PARENT-STUDENT LINKING SYSTEM
// ============================================

// Parent Model
model Parent {
  id              String  @id @default(uuid()) @db.Uuid
  userId          String  @unique @db.Uuid
  schoolId        String  @db.Uuid
  // Personal Information
  name            String
  email           String  @unique
  contactNumber   String  @unique
  alternateNumber String?
  // gender          String
  // Address Information
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?

  // Additional Details
  occupation    String?
  qualification String?
  annualIncome  String?
  bloodGroup    String?

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactNumber   String?
  emergencyContactRelation String?

  // System Fields
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
  status    UserStatus @default(ACTIVE)

  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  school          School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentLinks    StudentParentLink[]
  busRequests     BusRequest[]
  receipts        Receipt[]
  parentFeedbacks ParentFeedback[]

  @@index([schoolId])
  @@index([contactNumber])
  @@index([email])
  @@index([userId])
}

// Bridge/Junction Model for Many-to-Many Relationship
model StudentParentLink {
  id        String @id @default(uuid()) @db.Uuid
  studentId String @db.Uuid
  parentId  String @db.Uuid

  // Relation Type
  relation ParentRelationType @default(GUARDIAN)

  // Primary Contact (one parent can be marked as primary)
  isPrimary Boolean @default(false)

  // Permissions
  canPickup      Boolean @default(true)
  canViewReports Boolean @default(true)
  canViewFees    Boolean @default(true)

  // System Fields
  linkedAt   DateTime  @default(now())
  linkedBy   String?   @db.Uuid // Admin/Staff who created the link
  verifiedAt DateTime? // When parent verified the link
  isActive   Boolean   @default(true)

  // Relations
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId]) // Prevent duplicate links
  @@index([studentId])
  @@index([parentId])
  @@index([relation])
}

// Enum for Parent Relation Types
enum ParentRelationType {
  FATHER
  MOTHER
  GUARDIAN
  GRANDFATHER
  GRANDMOTHER
  UNCLE
  AUNT
  SIBLING
  OTHER
}

model ExamSeries {
  id     Int    @id @default(autoincrement())
  examId String @db.Uuid
  score  Float
  exam   Exam   @relation(fields: [examId], references: [id])
}

model ExamIssue {
  id        Int      @id @default(autoincrement())
  studentId String   @db.Uuid
  issueDate DateTime
  student   Student  @relation(fields: [studentId], references: [userId])
}

model HomeworkSubmission {
  id         String @id @default(uuid()) @db.Uuid
  homeworkId String @db.Uuid
  studentId  String @db.Uuid

  // Submission Details
  submittedAt DateTime?
  fileUrl     String?
  fileName    String?
  remarks     String?   @db.Text

  // Status
  status   SubmissionStatus @default(PENDING)
  grade    String?
  feedback String?          @db.Text

  // Evaluation
  evaluatedBy String?   @db.Uuid
  evaluatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homework Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [userId])

  @@unique([homeworkId, studentId])
  @@index([homeworkId])
  @@index([studentId])
  @@index([status])
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  LATE
  EVALUATED
  MISSING
}

model TeachingStaff {
  userId           String    @id @db.Uuid
  departmentId     Int?
  employeeId       String
  name             String
  designation      String
  gender           String
  sectionsAssigned Section[] @relation("Section_Teacher")
  age              String
  bloodGroup       String

  contactNumber         String
  dob                   String
  email                 String
  address               String
  City                  String
  district              String?
  state                 String?
  country               String?
  PostalCode            String?
  subjectId             Int?
  schoolId              String                  @db.Uuid
  academicYearId        String                  @db.Uuid
  Class                 Class[]
  homework              Homework[]
  SectionSubjectTeacher SectionSubjectTeacher[]
  AcademicYear          AcademicYear            @relation(fields: [academicYearId], references: [id])
  department            Department?             @relation(fields: [departmentId], references: [id])
  school                School                  @relation(fields: [schoolId], references: [id])
  originalDelegations   AttendanceDelegation[]  @relation("OriginalTeacher")
  substituteDelegations AttendanceDelegation[]  @relation("SubstituteTeacher")
  user                  User                    @relation(fields: [userId], references: [id])
  subjects              Subject[]               @relation("SubjectToTeachingStaff")
  timetableEntries      TimetableEntry[]
  examHallInvigilators  ExamHallInvigilator[]
  teacherShifts         TeacherShift[]
  examEvaluators        ExamEvaluator[]         @relation("EvaluatorAssignments")
  teacherFeedbacks      TeacherFeedback[]

  @@index([departmentId])
}

model NonTeachingStaff {
  userId         String       @id @db.Uuid
  departmentId   Int?
  employeeId     String
  name           String
  designation    String
  gender         String
  dob            String
  age            String
  bloodGroup     String
  contactNumber  String
  email          String
  address        String
  City           String
  district       String?
  state          String?
  country        String?
  PostalCode     String?
  schoolId       String       @db.Uuid
  academicYearId String       @db.Uuid
  AcademicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  department     Department?  @relation(fields: [departmentId], references: [id])
  school         School       @relation(fields: [schoolId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([departmentId])
}

model Class {
  id                     Int                    @id @default(autoincrement())
  schoolId               String                 @db.Uuid
  className              String
  capacity               Int?
  teachingStaffUserId    String?                @db.Uuid
  academicYearId         String?                @db.Uuid
  AcademicYear           AcademicYear?          @relation(fields: [academicYearId], references: [id])
  school                 School                 @relation(fields: [schoolId], references: [id])
  TeachingStaff          TeachingStaff?         @relation(fields: [teachingStaffUserId], references: [userId])
  FeeStructure           FeeStructure[]
  homework               Homework[]
  NoticeTarget           NoticeTarget[]
  sections               Section[]
  attendanceDelegations  AttendanceDelegation[]
  students               Student[]
  subjects               Subject[]
  Syllabi                Syllabus[]
  Assignment             Assignment[]
  globalFeeStructures    GlobalFeeStructure[]
  calendarEventTargets   CalendarEventTarget[]
  bulkAttendance         BulkAttendance[]
  exam                   Exam?                  @relation(fields: [examId], references: [id])
  examId                 String?                @db.Uuid
  timetableEntries       TimetableEntry[]
  promotionHistoriesFrom PromotionHistory[]     @relation("PromotionFromClass")
  promotionHistoriesTo   PromotionHistory[]     @relation("PromotionToClass")
  teacherShifts          TeacherShift[]
  alumni                 Alumni[]
  examEvaluators         ExamEvaluator[]
  nepStage               NEPStage? // NEP 2020 Learning Stage for HPC

  @@unique([id, schoolId])
  @@index([schoolId])
}

// model Section {
//   id                   Int                     @id @default(autoincrement())
//   name                 String
//   classId              Int
//   schoolId             String                  @db.Uuid
//   teachingStaffUserId  String?                 @db.Uuid
//   NoticeTarget         NoticeTarget[]
//   class                Class                   @relation(fields: [classId], references: [id])
//   supervisor           TeachingStaff?          @relation(fields: [teachingStaffUserId], references: [userId])
//   subjectTeachers      SectionSubjectTeacher[]
//   students             Student[]
//   timetables           Timetable[]
//   calendarEventTargets CalendarEventTarget[]
//   bulkAttendance       BulkAttendance[]

//   @@unique([classId, name])
//   @@index([classId])
// }
model Section {
  id                  Int     @id @default(autoincrement())
  name                String
  classId             Int
  schoolId            String  @db.Uuid
  teachingStaffUserId String? @db.Uuid

  // Relations
  class                  Class                   @relation(fields: [classId], references: [id])
  teachingStaff          TeachingStaff?          @relation("Section_Teacher", fields: [teachingStaffUserId], references: [userId])
  NoticeTarget           NoticeTarget[]
  subjectTeachers        SectionSubjectTeacher[]
  students               Student[]
  timetables             Timetable[]
  calendarEventTargets   CalendarEventTarget[]
  bulkAttendance         BulkAttendance[]
  attendanceDelegations  AttendanceDelegation[]
  homework               Homework[]
  timetableEntries       TimetableEntry[]
  teacherShifts          TeacherShift[]
  alumni                 Alumni[]
  promotionHistoriesFrom PromotionHistory[]      @relation("PromotionFromSection")
  promotionHistoriesTo   PromotionHistory[]      @relation("PromotionToSection")

  @@unique([classId, name])
  @@index([classId])
}

model SectionSubjectTeacher {
  id                  Int           @id @default(autoincrement())
  sectionId           Int
  subjectId           Int
  teachingStaffUserId String        @db.Uuid
  section             Section       @relation(fields: [sectionId], references: [id])
  subject             Subject       @relation(fields: [subjectId], references: [id])
  teacher             TeachingStaff @relation(fields: [teachingStaffUserId], references: [userId])

  @@unique([sectionId, subjectId])
}

// Time Slot Configuration (e.g., Period 1: 09:00-09:40)
model TimeSlot {
  id        String   @id @default(uuid()) @db.Uuid
  schoolId  String   @db.Uuid
  label     String // "Period 1", "Period 2", "Lunch Break"
  startTime String // "09:00"
  endTime   String // "09:40"
  isBreak   Boolean  @default(false)
  sequence  Int // Order: 1, 2, 3...
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school        School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  entries       TimetableEntry[]
  teacherShifts TeacherShift[]

  @@index([schoolId])
  @@index([schoolId, sequence])
}

// Individual Timetable Entry (Class X, Period 1, Monday = Math with Mr. Sharma)
model TimetableEntry {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Linking
  classId    Int
  sectionId  Int?
  subjectId  Int
  teacherId  String @db.Uuid
  timeSlotId String @db.Uuid

  // Schedule
  dayOfWeek  Int // 1=Monday, 2=Tuesday, ..., 6=Saturday
  roomNumber String?

  // Metadata
  isActive  Boolean  @default(true)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class         Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  section       Section?       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject       Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher       TeachingStaff  @relation(fields: [teacherId], references: [userId], onDelete: Cascade)
  timeSlot      TimeSlot       @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  teacherShifts TeacherShift[]

  @@unique([classId, sectionId, timeSlotId, dayOfWeek])
  @@index([schoolId])
  @@index([teacherId, dayOfWeek])
  @@index([classId, sectionId, dayOfWeek])
  @@index([timeSlotId, dayOfWeek])
}

// Date-specific Teacher Shift (Timetable)
model TeacherShift {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Linking
  classId    Int
  sectionId  Int
  subjectId  Int
  teacherId  String @db.Uuid
  timeSlotId String @db.Uuid

  // Schedule
  date       DateTime @db.Date // Specific date for this shift
  roomNumber String?

  // Sync & Override Control
  timetableEntryId String? @db.Uuid // Link to source timetable entry (if created from timetable)
  isOverride       Boolean @default(false) // True if admin manually edited (won't be auto-updated)

  // Metadata
  status    String   @default("ASSIGNED") // ASSIGNED, CANCELLED, COMPLETED
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class          Class           @relation(fields: [classId], references: [id], onDelete: Cascade)
  section        Section         @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject        Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher        TeachingStaff   @relation(fields: [teacherId], references: [userId], onDelete: Cascade)
  timeSlot       TimeSlot        @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  timetableEntry TimetableEntry? @relation(fields: [timetableEntryId], references: [id], onDelete: SetNull)

  @@unique([teacherId, date, timeSlotId]) // One teacher can't be in two places at same time
  @@index([schoolId])
  @@index([teacherId, date])
  @@index([classId, sectionId, date])
  @@index([date])
  @@index([timetableEntryId])
}

// Template for reusing timetable configurations
model TimetableTemplate {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  name           String // "Standard Week", "Exam Week"
  academicYearId String   @db.Uuid
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([academicYearId])
}

// Legacy model - kept for backward compatibility, will be deprecated
model Timetable {
  id        String   @id @default(uuid()) @db.Uuid
  sectionId Int
  day       String
  period    Int
  subject   String
  teacher   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  section   Section  @relation(fields: [sectionId], references: [id])
}

model Document {
  id          Int          @id @default(autoincrement())
  userId      String       @db.Uuid
  title       String
  description String?
  fileUrl     String
  type        DocumentType @default(OTHER)
  isPublic    Boolean      @default(false)
  uploadedAt  DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

model Subject {
  id                    Int                     @id @default(autoincrement())
  subjectName           String
  subjectCode           String?
  classId               Int
  departmentId          Int
  examResults           ExamResult[]
  homework              Homework[]
  SectionSubjectTeacher SectionSubjectTeacher[]
  class                 Class                   @relation(fields: [classId], references: [id])
  department            Department              @relation(fields: [departmentId], references: [id])
  Teacher               TeachingStaff[]         @relation("SubjectToTeachingStaff")
  examSubjects          ExamSubject[]
  timetableEntries      TimetableEntry[]
  teacherShifts         TeacherShift[]
  examEvaluators        ExamEvaluator[]
  examHallInvigilators  ExamHallInvigilator[]
  competencies          Competency[]

  @@index([classId])
  @@index([departmentId])
}

model Department {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  NonTeachingStaff NonTeachingStaff[]
  subjects         Subject[]
  teachers         TeachingStaff[]
}

// Enhanced Homework Model
model Homework {
  id        String @id @default(uuid()) @db.Uuid
  schoolId  String @db.Uuid
  classId   Int
  sectionId Int?
  subjectId Int?
  teacherId String @db.Uuid

  // Homework Details
  title       String
  description String  @db.Text
  fileUrl     String? // Optional PDF/document
  fileName    String?

  // Dates
  assignedDate DateTime @default(now())
  dueDate      DateTime

  // Status
  isActive Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school  School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class   Class         @relation(fields: [classId], references: [id])
  section Section?      @relation(fields: [sectionId], references: [id])
  subject Subject?      @relation(fields: [subjectId], references: [id])
  teacher TeachingStaff @relation(fields: [teacherId], references: [userId])

  submissions HomeworkSubmission[]

  @@index([schoolId])
  @@index([classId])
  @@index([sectionId])
  @@index([teacherId])
  @@index([dueDate])
  @@index([isActive])
}

model Exam {
  id             String     @id @default(uuid()) @db.Uuid
  schoolId       String     @db.Uuid
  title          String
  type           ExamType   @default(OFFLINE)
  startDate      DateTime?
  endDate        DateTime?
  status         ExamStatus @default(DRAFT)
  academicYearId String?    @db.Uuid
  isFinalExam    Boolean    @default(false)
  description    String?    @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  school       School        @relation(fields: [schoolId], references: [id])
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id])

  classes Class[]

  results         ExamResult[]
  examSeries      ExamSeries[]
  AdmitCard       AdmitCard[]
  subjects        ExamSubject[]
  seatAllocations SeatAllocation[]

  securitySettings      Json? // Security settings for online exams (lockScreen, tabMonitoring)
  duration              Int? // Exam duration in minutes
  enableTimer           Boolean                @default(false) // Whether to enable timer for this exam[]
  questions             OnlineExamQuestion[]
  attempts              StudentExamAttempt[]
  invigilators          ExamHallInvigilator[]
  attendance            HallAttendance[]
  examEvaluators        ExamEvaluator[]
  marksSubmissions      MarksSubmission[]
  competencyAssessments CompetencyAssessment[]

  @@index([schoolId])
}

model ExamSubject {
  id           String    @id @default(uuid()) @db.Uuid
  examId       String    @db.Uuid
  subjectId    Int
  date         DateTime?
  startTime    String?
  endTime      String?
  duration     Int?
  maxMarks     Float     @default(100)
  passingMarks Float     @default(33)

  exam    Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([examId, subjectId])
  @@index([examId])
  @@index([subjectId])
}

model ExamResult {
  id        Int    @id @default(autoincrement())
  examId    String @db.Uuid
  studentId String @db.Uuid
  subjectId Int

  marksObtained Float?
  grade         String?
  remarks       String?
  isAbsent      Boolean @default(false)

  exam    Exam    @relation(fields: [examId], references: [id])
  student Student @relation(fields: [studentId], references: [userId])
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([examId, studentId, subjectId])
  @@index([examId])
  @@index([studentId])
  @@index([subjectId])
}

model ExamHall {
  id         String  @id @default(uuid()) @db.Uuid
  schoolId   String  @db.Uuid
  name       String
  roomNumber String?
  capacity   Int

  allocations SeatAllocation[]
  school      School           @relation(fields: [schoolId], references: [id])

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  examHallInvigilators ExamHallInvigilator[]
  hallAttendances      HallAttendance[]

  @@index([schoolId])
}

model SeatAllocation {
  id         String @id @default(uuid()) @db.Uuid
  examId     String @db.Uuid
  studentId  String @db.Uuid
  examHallId String @db.Uuid
  seatNumber String

  exam    Exam     @relation(fields: [examId], references: [id])
  student Student  @relation(fields: [studentId], references: [userId])
  hall    ExamHall @relation(fields: [examHallId], references: [id])

  @@unique([examId, studentId])
  @@index([examId])
  @@index([examHallId])
}

enum ExamType {
  OFFLINE
  ONLINE
}

enum ExamStatus {
  DRAFT // Initial creation
  SCHEDULED // Published, awaiting start
  IN_PROGRESS // Exam ongoing
  COMPLETED // Exam finished
  RESULTS_PENDING // Marks entry in progress
  RESULTS_PUBLISHED // Final results out
  PUBLISHED // Legacy - kept for compatibility
}

enum HallTicketStatus {
  NOT_ISSUED
  ISSUED
  BLOCKED
  PUBLISHED
}

model AcademicYear {
  id                     String                  @id @default(uuid()) @db.Uuid
  name                   String
  startDate              DateTime
  endDate                DateTime
  isActive               Boolean                 @default(false)
  // Setup tracking for year rollover
  setupComplete          Boolean                 @default(false)
  studentsPromoted       Boolean                 @default(false)
  feesConfigured         Boolean                 @default(false)
  classesConfigured      Boolean                 @default(false)
  timetableConfigured    Boolean                 @default(false)
  subjectsConfigured     Boolean                 @default(false)
  createdAt              DateTime                @default(now())
  schoolId               String                  @db.Uuid
  school                 School                  @relation(fields: [schoolId], references: [id])
  classes                Class[]
  FeePayments            FeePayment[]
  FeeStructures          FeeStructure[]
  NonTeachingStaff       NonTeachingStaff[]
  students               Student[]
  Syllabus               Syllabus[]
  TeachingStaff          TeachingStaff[]
  DigitalIdCard          DigitalIdCard[]
  globalFeeStructures    GlobalFeeStructure[]
  studentFees            StudentFee[]
  leaveBalances          LeaveBalance[]
  attendanceStats        AttendanceStats[]
  exams                  Exam[]
  timetableTemplates     TimetableTemplate[]
  promotionHistoriesFrom PromotionHistory[]      @relation("PromotionFromYear")
  promotionHistoriesTo   PromotionHistory[]      @relation("PromotionToYear")
  transportFees          TransportFee[]
  competencyAssessments  CompetencyAssessment[]
  studentActivityRecords StudentActivityRecord[]
  selassessments         SELAssessment[]
  studentReflections     StudentReflection[]
  teacherFeedbacks       TeacherFeedback[]
  parentFeedbacks        ParentFeedback[]
  hpcreports             HPCReport[]
  termLocks              TermLock[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model FeeStructure {
  id                  String                @id @default(uuid()) @db.Uuid
  schoolId            String?               @db.Uuid
  academicYearId      String                @db.Uuid
  issueDate           DateTime              @default(now())
  name                String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  studentUserId       String?               @db.Uuid
  classId             Int?
  mode                FeeMode               @default(MONTHLY)
  isInstallment       Boolean               @default(false)
  feeParticulars      FeeParticular[]
  FeePayments         FeePayment[]
  AcademicYear        AcademicYear          @relation(fields: [academicYearId], references: [id])
  Class               Class?                @relation(fields: [classId], references: [id])
  School              School?               @relation(fields: [schoolId], references: [id])
  Student             Student?              @relation(fields: [studentUserId], references: [userId])
  StudentFeeStructure StudentFeeStructure[]
}

model FeeParticular {
  id                   String                 @id @default(uuid()) @db.Uuid
  feeStructureId       String                 @db.Uuid
  name                 String
  defaultAmount        Float
  feeStructure         FeeStructure           @relation(fields: [feeStructureId], references: [id])
  StudentFeeParticular StudentFeeParticular[]
}

model StudentFeeStructure {
  id             String                 @id @default(uuid()) @db.Uuid
  studentId      String                 @db.Uuid
  academicYearId String                 @db.Uuid
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @default(now()) @updatedAt
  schoolId       String?                @db.Uuid
  studentUserId  String?                @db.Uuid
  feeStructureId String                 @db.Uuid
  status         String                 @default("UNPAID")
  FeePayments    FeePayment[]
  feeParticulars StudentFeeParticular[]
  feeStructure   FeeStructure           @relation(fields: [feeStructureId], references: [id])
  School         School?                @relation(fields: [schoolId], references: [id])
  Student        Student?               @relation(fields: [studentUserId], references: [userId])
}

// Link installments to specific particulars
model InstallmentParticular {
  id            String @id @default(uuid()) @db.Uuid
  installmentId String @db.Uuid
  particularId  String @db.Uuid

  // How much of this particular is in this installment
  amount     Float
  paidAmount Float @default(0)

  // Relations
  installment StudentFeeInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)
  particular  StudentFeeParticular  @relation(fields: [particularId], references: [id], onDelete: Cascade)

  @@unique([installmentId, particularId])
  @@index([installmentId])
  @@index([particularId])
}

// Attendance Record - Main attendance tracking
model Attendance {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  schoolId     String   @db.Uuid
  date         DateTime @db.Date
  delegationId String?  @db.Uuid // Track if marked via delegation

  // Status & Timing
  status       AttendanceStatus
  checkInTime  DateTime?
  checkOutTime DateTime?
  workingHours Float?           @default(0) // Calculated hours

  // Location & Device Info
  checkInLocation  Json? // {latitude, longitude, address}
  checkOutLocation Json?
  deviceInfo       Json? // {deviceId, platform, appVersion}

  // Metadata
  markedBy      String?  @db.Uuid // Who marked (for students)
  markedAt      DateTime @default(now())
  isLateCheckIn Boolean  @default(false)
  lateByMinutes Int?

  // Biometric Attendance Tracking
  isBiometricEntry     Boolean   @default(false) // True if created from biometric punch
  isBiometricFinalized Boolean   @default(false) // True after night finalization
  biometricFinalizedAt DateTime? // When finalization ran

  remarks String?

  // Approval System
  requiresApproval Boolean        @default(false)
  approvalStatus   ApprovalStatus @default(PENDING)
  approvedBy       String?        @db.Uuid
  approvedAt       DateTime?
  approvalRemarks  String?

  // Relations
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  school         School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  marker         User?                @relation("MarkedBy", fields: [markedBy], references: [id])
  approver       User?                @relation("ApprovedBy", fields: [approvedBy], references: [id])
  leaveRequest   LeaveRequest?        @relation("AttendanceLeave", fields: [leaveRequestId], references: [id])
  documents      AttendanceDocument[]
  leaveRequestId String?              @db.Uuid

  @@unique([userId, schoolId, date])
  @@index([userId, date])
  @@index([schoolId, date])
  @@index([status])
  @@index([approvalStatus])
  @@index([markedBy])
}

// model AttendanceDelegation {
//   id                  String @id @default(uuid()) @db.Uuid
//   schoolId            String @db.Uuid
//   originalTeacherId   String @db.Uuid
//   substituteTeacherId String @db.Uuid
//   classId             Int
//   sectionId           Int?

//   // Delegation Period
//   startDate DateTime @db.Date
//   endDate   DateTime @db.Date

//   // Status & Metadata
//   status      DelegationStatus @default(ACTIVE)
//   reason      String?          @db.Text
//   createdById String           @db.Uuid
//   createdAt   DateTime         @default(now())
//   updatedAt   DateTime         @updatedAt

//   // Relations
//   school            School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   originalTeacher   TeachingStaff @relation("OriginalTeacher", fields: [originalTeacherId], references: [userId])
//   substituteTeacher TeachingStaff @relation("SubstituteTeacher", fields: [substituteTeacherId], references: [userId])
//   class             Class         @relation(fields: [classId], references: [id])
//   section           Section?      @relation(fields: [sectionId], references: [id])
//   createdBy         User          @relation("DelegationCreator", fields: [createdById], references: [id])

//   @@unique([schoolId, classId, sectionId, startDate, endDate, substituteTeacherId])
//   @@index([schoolId, startDate, endDate])
//   @@index([substituteTeacherId, startDate, endDate])
//   @@index([originalTeacherId, startDate, endDate])
//   @@index([status])
// }
model AttendanceDelegation {
  id                  String @id @default(uuid()) @db.Uuid
  schoolId            String @db.Uuid
  originalTeacherId   String @db.Uuid
  substituteTeacherId String @db.Uuid
  classId             Int
  sectionId           Int?

  // Delegation Period
  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  // Status & Metadata
  status DelegationStatus @default(ACTIVE)
  reason String?          @db.Text

  acknowledgedAt DateTime? // Tracks when substitute teacher acknowledged the delegation
  createdById    String    @db.Uuid
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  school            School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  originalTeacher   TeachingStaff @relation("OriginalTeacher", fields: [originalTeacherId], references: [userId])
  substituteTeacher TeachingStaff @relation("SubstituteTeacher", fields: [substituteTeacherId], references: [userId])
  class             Class         @relation(fields: [classId], references: [id])
  section           Section?      @relation(fields: [sectionId], references: [id])
  createdBy         User          @relation("DelegationCreator", fields: [createdById], references: [id])

  // ✅ New Rules
  @@unique([schoolId, originalTeacherId, startDate, endDate])
  @@unique([schoolId, classId, sectionId, startDate, endDate])
  // Existing helpful indexes
  @@index([schoolId, startDate, endDate])
  @@index([substituteTeacherId, startDate, endDate])
  @@index([originalTeacherId, startDate, endDate])
  @@index([status])
}

enum DelegationStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// School Calendar - Define working days, holidays
model SchoolCalendar {
  id       String   @id @default(uuid()) @db.Uuid
  schoolId String   @db.Uuid
  date     DateTime @db.Date

  // Day Configuration
  dayType     DayType @default(WORKING_DAY)
  isHoliday   Boolean @default(false)
  holidayName String?

  // Working Hours
  startTime String? // "09:00"
  endTime   String? // "17:00"

  // Metadata
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, date])
  @@index([schoolId, date])
  @@index([dayType])
}

// Attendance Configuration - School-specific settings
model AttendanceConfig {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid

  // Working Hours
  defaultStartTime   String @default("09:00")
  defaultEndTime     String @default("17:00")
  gracePeriodMinutes Int    @default(15) // Late after this
  halfDayHours       Float  @default(4)
  fullDayHours       Float  @default(8)

  // Geo-fencing
  enableGeoFencing    Boolean @default(false)
  schoolLatitude      Float?
  schoolLongitude     Float?
  allowedRadiusMeters Int?    @default(500)

  // Auto-marking Rules
  autoMarkAbsent Boolean @default(true)
  autoMarkTime   String  @default("10:00") // Mark absent if not checked in by this time

  // Approval Rules
  requireApprovalDays Int     @default(3) // Past attendance needs approval after X days
  autoApproveLeaves   Boolean @default(false)

  // Leave Approval Hierarchy - NEW
  // Controls who can approve leave and regularization requests
  adminCanApproveLeaves     Boolean @default(true) // Admin can approve leaves
  principalCanApproveLeaves Boolean @default(true) // Principal can approve leaves
  directorCanApproveLeaves  Boolean @default(true) // Director can approve leaves
  directorOverridesAll      Boolean @default(false) // If true, only Director can approve (Admin/Principal read-only)
  principalOverridesAdmin   Boolean @default(false) // If true, Admin becomes read-only for leaves

  // Notifications
  sendDailyReminders Boolean @default(true)
  reminderTime       String  @default("08:30")
  notifyParents      Boolean @default(true)

  // Biometric Attendance Settings
  enableBiometricAttendance Boolean @default(false)

  // Stats Calculation
  calculateOnWeekends  Boolean @default(false)
  minAttendancePercent Float   @default(75)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

// Leave Management
model LeaveRequest {
  id       String @id @default(uuid()) @db.Uuid
  userId   String @db.Uuid
  schoolId String @db.Uuid

  // Leave Details
  leaveType LeaveType
  startDate DateTime  @db.Date
  endDate   DateTime  @db.Date
  totalDays Int
  reason    String    @db.Text

  // Status
  status        LeaveStatus @default(PENDING)
  submittedAt   DateTime    @default(now())
  reviewedBy    String?     @db.Uuid
  reviewedAt    DateTime?
  reviewRemarks String?

  // Emergency Contact
  emergencyContact      String?
  emergencyContactPhone String?

  // Relations
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  school     School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  reviewer   User?           @relation("LeaveReviewer", fields: [reviewedBy], references: [id])
  attendance Attendance[]    @relation("AttendanceLeave")
  documents  LeaveDocument[]

  @@index([userId, status])
  @@index([schoolId, status])
  @@index([startDate, endDate])
}

// Leave Balance Tracking
model LeaveBalance {
  id             String @id @default(uuid()) @db.Uuid
  userId         String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid

  // Balance by Type
  casualLeaveTotal   Int @default(12)
  casualLeaveUsed    Int @default(0)
  casualLeaveBalance Int @default(12)

  sickLeaveTotal   Int @default(10)
  sickLeaveUsed    Int @default(0)
  sickLeaveBalance Int @default(10)

  earnedLeaveTotal   Int @default(15)
  earnedLeaveUsed    Int @default(0)
  earnedLeaveBalance Int @default(15)

  maternityLeaveTotal   Int @default(180)
  maternityLeaveUsed    Int @default(0)
  maternityLeaveBalance Int @default(180)

  // Metadata
  lastResetDate DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([userId, academicYearId])
  @@index([userId, schoolId])
}

// Attendance Stats - Pre-calculated for performance
model AttendanceStats {
  id             String @id @default(uuid()) @db.Uuid
  userId         String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid
  month          Int // 1-12
  year           Int

  // Stats
  totalWorkingDays Int @default(0)
  totalPresent     Int @default(0)
  totalAbsent      Int @default(0)
  totalHalfDay     Int @default(0)
  totalLate        Int @default(0)
  totalLeaves      Int @default(0)
  totalHolidays    Int @default(0)

  attendancePercentage Float @default(0)
  avgWorkingHours      Float @default(0)

  // Calculated
  lastCalculated DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([userId, academicYearId, month, year])
  @@index([userId, schoolId])
  @@index([academicYearId, month, year])
  @@index([attendancePercentage])
}

// Bulk Attendance - For efficient batch marking
model BulkAttendance {
  id        String   @id @default(uuid()) @db.Uuid
  schoolId  String   @db.Uuid
  classId   Int?
  sectionId Int?
  date      DateTime @db.Date
  markedBy  String   @db.Uuid
  markedAt  DateTime @default(now())

  // Summary
  totalStudents Int
  presentCount  Int
  absentCount   Int
  lateCount     Int
  halfDayCount  Int

  // Metadata
  remarks String?

  school  School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  class   Class?   @relation(fields: [classId], references: [id])
  section Section? @relation(fields: [sectionId], references: [id])
  marker  User     @relation(fields: [markedBy], references: [id])

  @@index([schoolId, date])
  @@index([classId, date])
  @@index([markedBy])
}

// Attendance Documents (Medical certificates, etc.)
model AttendanceDocument {
  id           String   @id @default(uuid()) @db.Uuid
  attendanceId String   @db.Uuid
  documentType String // "MEDICAL_CERTIFICATE", "LEAVE_LETTER", etc.
  fileUrl      String
  fileName     String
  uploadedAt   DateTime @default(now())

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
}

// Leave Documents
model LeaveDocument {
  id             String   @id @default(uuid()) @db.Uuid
  leaveRequestId String   @db.Uuid
  documentType   String
  fileUrl        String
  fileName       String
  uploadedAt     DateTime @default(now())

  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  @@index([leaveRequestId])
}

// Attendance Notifications Queue
model AttendanceNotification {
  id               String           @id @default(uuid()) @db.Uuid
  schoolId         String           @db.Uuid
  userId           String           @db.Uuid
  notificationType NotificationType

  // Notification Details
  title        String
  message      String             @db.Text
  scheduledFor DateTime
  sentAt       DateTime?
  status       NotificationStatus @default(PENDING)

  // Metadata
  metadata  Json? // Additional data
  createdAt DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User   @relation("AttendanceNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([userId, status])
}

// ============================================
// ENUMS
// ============================================

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

enum DayType {
  WORKING_DAY
  WEEKEND
  HOLIDAY
  EXAM_DAY
  VACATION
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  NOT_REQUIRED
}

enum LeaveType {
  CASUAL
  SICK
  EARNED
  MATERNITY
  PATERNITY
  EMERGENCY
  UNPAID
  COMPENSATORY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Notification Enums
enum NotificationType {
  DAILY_REMINDER
  ABSENT_ALERT
  LEAVE_APPROVED
  LEAVE_REJECTED
  LOW_ATTENDANCE
  APPROVAL_REQUIRED
  GENERAL
  SYLLABUS
  ASSIGNMENT
  FEE
  EXAM
  ATTENDANCE
  NOTICE
  LEAVE
  TRANSPORT
  LIBRARY
  ADMISSION
  EVENT
  HPC_FEEDBACK
  RESULT
  TIMETABLE
  BIRTHDAY
  ANNIVERSARY
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH

  URGENT
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model Notification {
  id         String  @id @default(uuid()) @db.Uuid
  senderId   String? @db.Uuid
  receiverId String  @db.Uuid
  schoolId   String  @db.Uuid

  // Content
  title    String
  message  String               @db.Text
  type     NotificationType     @default(GENERAL)
  priority NotificationPriority @default(NORMAL)
  icon     String               @default("📢")

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Action & Metadata
  actionUrl String? // Deep link or action URL
  metadata  Json? // Additional data

  // Timestamps
  createdAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiry date

  // Relations
  receiver User  @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender   User? @relation("NotificationSender", fields: [senderId], references: [id])

  @@index([receiverId, isRead])
  @@index([receiverId, createdAt])
  @@index([schoolId])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
}

model LibraryBook {
  id          String  @id @default(uuid()) @db.Uuid
  schoolId    String  @db.Uuid
  title       String
  author      String
  ISBN        String
  category    String
  publisher   String
  edition     String?
  description String?
  coverImage  String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school   School               @relation(fields: [schoolId], references: [id])
  copies   LibraryBookCopy[]
  requests LibraryBookRequest[]

  @@index([schoolId])
  @@index([ISBN])
  @@index([title])
  @@index([author])
}

model LibraryBookCopy {
  id              String  @id @default(uuid()) @db.Uuid
  bookId          String  @db.Uuid
  accessionNumber String // Unique ID for the physical copy
  barcode         String? @unique // Scannable barcode unique to this copy
  status          String  @default("AVAILABLE") // AVAILABLE, ISSUED, LOST, DAMAGED, RESERVED
  condition       String  @default("GOOD") // NEW, GOOD, FAIR, POOR
  location        String? // Shelf number etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  book         LibraryBook          @relation(fields: [bookId], references: [id], onDelete: Cascade)
  transactions LibraryTransaction[]
  requests     LibraryBookRequest[]

  @@index([bookId])
  @@index([status])
  @@index([barcode])
}

model LibraryTransaction {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  userId   String @db.Uuid // Student or Staff ID
  copyId   String @db.Uuid // specific copy
  userType String // STUDENT, TEACHER, STAFF

  issueDate  DateTime  @default(now())
  dueDate    DateTime
  returnDate DateTime?

  status String @default("ISSUED") // ISSUED, RETURNED, OVERDUE, LOST

  fineAmount Float   @default(0)
  finePaid   Boolean @default(false)
  remarks    String?

  copy LibraryBookCopy @relation(fields: [copyId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model LibrarySettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid

  maxBooksStudent Int @default(3)
  maxBooksTeacher Int @default(5)

  issueDaysStudent Int @default(14)
  issueDaysTeacher Int @default(30)

  finePerDay Float  @default(5)
  currency   String @default("INR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LibraryBookRequest {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  bookId   String @db.Uuid
  userId   String @db.Uuid
  userType String // STUDENT, TEACHER, STAFF

  // Request Details
  status      RequestStatus @default(PENDING)
  requestDate DateTime      @default(now())

  // Approval Details
  approvedBy   String?   @db.Uuid
  approvedDate DateTime?
  pickupCode   String?   @unique // 6-char unique code for collection
  pickupDate   DateTime? // Date by which book must be collected
  copyId       String?   @db.Uuid // Assigned copy on approval

  // Collection Details
  collectedDate DateTime?
  collectedBy   String?   @db.Uuid // Staff who handed over the book

  // Rejection/Cancellation
  rejectedBy      String?   @db.Uuid
  rejectedDate    DateTime?
  rejectionReason String?

  remarks String?

  // Relations
  school School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  book   LibraryBook      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  copy   LibraryBookCopy? @relation(fields: [copyId], references: [id])

  @@index([schoolId])
  @@index([userId])
  @@index([status])
  @@index([pickupDate])
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  COLLECTED
  EXPIRED
  CANCELLED
}

model Upload {
  id        String   @id @default(uuid())
  userId    String?
  fileUrl   String
  fileName  String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())
  School    School?  @relation(fields: [schoolId], references: [id])
  schoolId  String?  @db.Uuid
}

// ============================================
// SCHOOL GALLERY SYSTEM
// ============================================

enum GalleryCategory {
  ANNUAL_DAY
  SPORTS_DAY
  CULTURAL
  GRADUATION
  FIELD_TRIP
  CLASSROOM
  INFRASTRUCTURE
  AWARDS
  GENERAL
}

enum GalleryVisibility {
  ALL // Everyone
  PARENTS_ONLY // Parents and staff
  STAFF_ONLY // Teachers, admin, principal
  CLASS_SPECIFIC // Specific classes only
}

enum ImageProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ImageApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model GallerySettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Storage Quota (in bytes)
  storageQuota     BigInt @default(524288000) // 500MB default
  storageUsed      BigInt @default(0)
  maxImageSize     Int    @default(10485760) // 10MB max per image
  dailyUploadLimit Int    @default(50) // Max uploads per day

  // Feature Toggles
  requireApproval Boolean @default(false) // Require admin approval before public
  allowPublicView Boolean @default(true) // Allow unauthenticated viewing

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

model GalleryAlbum {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  title       String
  description String?
  coverImage  String? // URL to cover image
  eventDate   DateTime? // Date of event (if applicable)
  category    GalleryCategory @default(GENERAL)

  // Access Control
  isPublic   Boolean           @default(true)
  visibility GalleryVisibility @default(ALL)

  // Metadata
  imageCount  Int       @default(0)
  createdById String    @db.Uuid
  createdBy   User      @relation("GalleryAlbumCreator", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  images GalleryImage[]

  @@index([schoolId])
  @@index([category])
  @@index([eventDate])
  @@index([visibility])
}

model GalleryImage {
  id       String       @id @default(uuid()) @db.Uuid
  albumId  String       @db.Uuid
  album    GalleryAlbum @relation(fields: [albumId], references: [id], onDelete: Cascade)
  schoolId String       @db.Uuid

  // Image URLs (UploadThing)
  originalUrl  String // Original uploaded image
  thumbnailUrl String? // Generated thumbnail (300px)
  optimizedUrl String? // WebP compressed version

  // Metadata
  fileName      String
  fileSize      Int // Original size in bytes
  optimizedSize Int? // Compressed size
  mimeType      String
  width         Int?
  height        Int?
  caption       String?
  altText       String?

  // Processing Status
  processingStatus ImageProcessingStatus @default(PENDING)
  processingError  String?

  // Approval Workflow
  approvalStatus  ImageApprovalStatus @default(APPROVED)
  approvedById    String?             @db.Uuid
  approvedBy      User?               @relation("GalleryImageApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?

  // Soft Delete
  isActive    Boolean   @default(true)
  deletedAt   DateTime?
  deletedById String?   @db.Uuid

  // Uploader Info
  uploadedById String   @db.Uuid
  uploadedBy   User     @relation("GalleryImageUploader", fields: [uploadedById], references: [id])
  uploadedAt   DateTime @default(now())

  @@index([albumId])
  @@index([schoolId])
  @@index([approvalStatus])
  @@index([processingStatus])
  @@index([isActive])
}

// certificates generation models

// Add to your existing schema.prisma

model Signature {
  id                 String              @id @default(uuid()) @db.Uuid
  schoolId           String              @db.Uuid
  name               String
  designation        String?
  imageUrl           String
  isDefault          Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  templateSignatures TemplateSignature[]

  @@index([schoolId])
}

model Stamp {
  id             String          @id @default(uuid()) @db.Uuid
  schoolId       String          @db.Uuid
  name           String
  imageUrl       String
  position       Json? // { x: number, y: number }
  forDocument    String? // e.g., 'certificate', 'idcard'
  isDefault      Boolean         @default(false)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  templateStamps TemplateStamp[]

  @@index([schoolId])
}

model TemplateSignature {
  id           String              @id @default(uuid()) @db.Uuid
  templateId   String              @db.Uuid
  signatureId  String              @db.Uuid
  x            Float
  y            Float
  scale        Float               @default(1.0)
  rotation     Float               @default(0.0)
  templateType String // e.g., 'certificate', 'idcard'
  createdAt    DateTime            @default(now())
  template     CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade) // Assume CertificateTemplate; adjust for other templates
  signature    Signature           @relation(fields: [signatureId], references: [id], onDelete: Cascade)
}

model TemplateStamp {
  id           String              @id @default(uuid()) @db.Uuid
  templateId   String              @db.Uuid
  stampId      String              @db.Uuid
  x            Float
  y            Float
  scale        Float               @default(1.0)
  rotation     Float               @default(0.0)
  templateType String // e.g., 'certificate', 'idcard'
  createdAt    DateTime            @default(now())
  template     CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade) // Adjust for other
  stamp        Stamp               @relation(fields: [stampId], references: [id], onDelete: Cascade)
}

model QrVerificationSettings {
  id       String @id @default(cuid())
  schoolId String @db.Uuid // CRITICAL: @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  // Enablement
  enabledForCertificates Boolean @default(true)
  enabledForIdCards      Boolean @default(true)
  enabledForAdmitCards   Boolean @default(false)

  // Data Encoding
  encodeStudentId       Boolean @default(true)
  encodeCertificateId   Boolean @default(true)
  encodeIssueDate       Boolean @default(true)
  encodeSchoolId        Boolean @default(true)
  encodeVerificationUrl Boolean @default(true)
  customFields          Json?

  // Placement
  qrPlacementX Float @default(500)
  qrPlacementY Float @default(720)
  qrSize       Float @default(120)

  // Design
  qrColor              String  @default("#000000")
  qrBackground         String  @default("#FFFFFF")
  errorCorrectionLevel String  @default("M")
  logoOverlayUrl       String?

  // Verification Portal
  verificationBaseUrl String  @default("https://your-school.com/verify")
  portalTitle         String  @default("Verify Certificate")
  portalLogoUrl       String?
  portalPrimaryColor  String  @default("#1e40af")

  // Security
  useHashEncryption Boolean @default(true)
  hashAlgorithm     String  @default("SHA256")
  qrValidityDays    Int?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([schoolId])
}

model PdfExportSettings {
  id       String @id @default(cuid())
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  // Page Layout
  paperSize    String @default("A4") // A4, A5, Letter, Custom
  customWidth  Float? // mm
  customHeight Float? // mm
  orientation  String @default("portrait") // portrait, landscape
  marginTop    Float  @default(20) // mm
  marginBottom Float  @default(20) // mm
  marginLeft   Float  @default(20) // mm
  marginRight  Float  @default(20) // mm

  // Output Quality
  resolution  String  @default("standard") // standard, high, ultra
  compression String  @default("medium") // low, medium, high
  embedFonts  Boolean @default(true)

  // Branding & Header/Footer
  headerImageUrl    String?
  footerImageUrl    String?
  schoolLogoUrl     String?
  watermarkType     String  @default("none") // none, text, image
  watermarkText     String?
  watermarkImageUrl String?
  footerText        String?
  pageNumbering     Boolean @default(true)

  // Security & Protection
  passwordProtect    Boolean @default(false)
  password           String? // Encrypted in production
  disablePrint       Boolean @default(false)
  disableCopy        Boolean @default(false)
  digitalSignature   Boolean @default(false)
  saveAsDefault      Boolean @default(false)
  // File Handling
  fileNameFormat     String  @default("{student_name}_{document_type}.pdf")
  autoSaveLocation   String  @default("cloud") // cloud, local
  bulkExportBehavior String  @default("separate") // combine, separate

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([schoolId])
}

// model CertificateTemplate {
//   id                String                 @id @default(uuid()) @db.Uuid
//   name              String
//   description       String?
//   type              String // character, bonafide, transfer, etc.
//   schoolId          String                 @db.Uuid
//   school            School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   layoutConfig      Json // Stores ALL design settings
//   createdById       String?                @db.Uuid
//   createdBy         User?                  @relation(fields: [createdById], references: [id])
//   isDefault         Boolean                @default(false)
//   createdAt         DateTime               @default(now())
//   updatedAt         DateTime               @updatedAt
//   certificates      CertificateGenerated[]
//   TemplateSignature TemplateSignature[]
//   TemplateStamp     TemplateStamp[]

//   @@index([schoolId])
//   @@index([type])
// }
model CertificateTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  type         String // character, bonafide, transfer, etc.
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  layoutConfig Json // Stores design settings for signatures/stamps
  createdById  String?  @db.Uuid
  createdBy    User?    @relation(fields: [createdById], references: [id])
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations for signatures/stamps positioning
  templateSignatures TemplateSignature[]
  templateStamps     TemplateStamp[]
  DocumentTemplate   DocumentTemplate[]

  @@index([schoolId])
  @@index([type])
}

// DocumentTemplate: Main template with all content
model DocumentTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  templateType String // 'certificate', 'idcard', 'admitcard'
  subType      String // specific type (character, student, midterm, etc.)
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  layoutConfig Json
  createdById  String?  @db.Uuid
  createdBy    User?    @relation(fields: [createdById], references: [id])
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ADDED: Link to CertificateTemplate for signatures/stamps
  certificateTemplateId String?              @db.Uuid
  certificateTemplate   CertificateTemplate? @relation(fields: [certificateTemplateId], references: [id])

  // Generated certificates reference this
  certificatesGenerated CertificateGenerated[]

  @@unique([schoolId, templateType, subType, name])
  @@index([schoolId])
  @@index([templateType])
  @@index([subType])
}

// model DocumentTemplate {
//   id                   String                 @id @default(uuid()) @db.Uuid
//   name                 String
//   description          String?
//   templateType         String // 'certificate', 'idcard', 'admitcard'
//   subType              String // specific type (character, student, midterm, etc.)
//   schoolId             String                 @db.Uuid
//   school               School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   layoutConfig         Json
//   createdById          String?                @db.Uuid
//   createdBy            User?                  @relation(fields: [createdById], references: [id])
//   isDefault            Boolean                @default(false)
//   isActive             Boolean                @default(true)
//   createdAt            DateTime               @default(now())
//   updatedAt            DateTime               @updatedAt
//   CertificateGenerated CertificateGenerated[]

//   @@unique([schoolId, templateType, subType, name])
//   @@index([schoolId])
//   @@index([templateType])
//   @@index([subType])
// }

// model CertificateGenerated {
//   id                String              @id @default(uuid()) @db.Uuid
//   certificateNumber String              @unique
//   templateId        String              @db.Uuid
//   template          CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
//   studentId         String              @db.Uuid
//   student           Student             @relation(fields: [studentId], references: [userId], onDelete: Cascade)
//   schoolId          String              @db.Uuid
//   school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   issuedById        String?             @db.Uuid
//   issuedBy          User?               @relation(fields: [issuedById], references: [id])
//   issueDate         DateTime            @default(now())
//   customFields      Json // Additional dynamic values like event name, remarks, etc.
//   fileUrl           String? // If PDF is stored
//   status            String              @default("issued") // issued, pending, revoked
//   createdAt         DateTime            @default(now())

//   @@index([schoolId])
//   @@index([studentId])
//   @@index([templateId])
//   @@index([status])
// }
model CertificateGenerated {
  id                String @id @default(uuid()) @db.Uuid
  certificateNumber String @unique

  // Reference to DocumentTemplate ONLY
  templateId String           @db.Uuid
  template   DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  studentId String  @db.Uuid
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  issuedById String? @db.Uuid
  issuedBy   User?   @relation(fields: [issuedById], references: [id])

  issueDate    DateTime @default(now())
  customFields Json
  fileUrl      String?
  status       String   @default("issued")
  createdAt    DateTime @default(now())

  // Parent sharing
  showToParent Boolean   @default(false)
  sharedAt     DateTime?

  @@index([schoolId])
  @@index([studentId])
  @@index([templateId])
  @@index([status])
  @@index([showToParent])
}

model DigitalIdCard {
  id             String        @id @default(uuid()) @db.Uuid
  studentId      String        @db.Uuid
  student        Student       @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  schoolId       String        @db.Uuid
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYearId String?       @db.Uuid
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  qrCodeUrl      String?
  layoutConfig   Json
  generatedAt    DateTime      @default(now())

  // New fields for file handling and status
  fileUrl    String?
  status     String    @default("active") // active, expired, revoked
  validUntil DateTime?
  templateId String?

  // Parent sharing
  showToParent Boolean   @default(false)
  sharedAt     DateTime?

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([showToParent])
}

model AdmitCard {
  id           String   @id @default(uuid()) @db.Uuid
  studentId    String   @db.Uuid
  student      Student  @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  examId       String   @db.Uuid
  exam         Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  seatNumber   String?
  center       String?
  layoutConfig Json?
  issueDate    DateTime @default(now())

  // Parent sharing
  showToParent Boolean   @default(false)
  sharedAt     DateTime?

  // Eligibility & Issue Control (Hall Ticket Management)
  status            HallTicketStatus @default(NOT_ISSUED)
  isEligible        Boolean          @default(true)
  feeCleared        Boolean          @default(false)
  attendanceOk      Boolean          @default(false)
  attendancePercent Float?
  manualBlock       Boolean          @default(false)
  blockReason       String?
  isOverride        Boolean          @default(false)
  overrideReason    String?
  overrideBy        String?          @db.Uuid
  overrideByUser    User?            @relation("HallTicketOverride", fields: [overrideBy], references: [id])
  overrideAt        DateTime?
  publishedAt       DateTime?
  isPublished       Boolean          @default(false)
  user              User?            @relation(fields: [userId], references: [id])
  userId            String?          @db.Uuid

  @@unique([studentId, examId])
  @@index([schoolId])
  @@index([studentId])
  @@index([examId])
  @@index([showToParent])
}

// ============================================
// ATTENDANCE LOCK - MONTHLY FREEZE CONTROL
// ============================================

model AttendanceLock {
  id           String    @id @default(uuid()) @db.Uuid
  schoolId     String    @db.Uuid
  month        Int // 1-12
  year         Int
  isLocked     Boolean   @default(false)
  lockedAt     DateTime?
  lockedBy     String?   @db.Uuid
  unlockedAt   DateTime?
  unlockedBy   String?   @db.Uuid
  unlockReason String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  school         School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  lockedByUser   User?  @relation("AttendanceLockedBy", fields: [lockedBy], references: [id])
  unlockedByUser User?  @relation("AttendanceUnlockedBy", fields: [unlockedBy], references: [id])

  @@unique([schoolId, month, year])
  @@index([schoolId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    String?     @db.Uuid
  action    AuditAction
  tableName String
  rowId     String
  timestamp DateTime    @default(now())
  oldData   Json?
  newData   Json?
  error     String?
  user      User?       @relation(fields: [userId], references: [id])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ERROR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LEFT
  DISABLED
  BANNED
}

// ============================================
// SESSION MANAGEMENT & SECURITY
// ============================================

model UserSession {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session Info
  sessionToken String   @unique
  refreshToken String?
  expiresAt    DateTime

  // Device Info
  deviceName     String? // User-assigned name (e.g., "My iPhone")
  deviceType     String? // mobile, desktop, tablet
  browser        String? // Chrome, Safari, Firefox, etc.
  browserVersion String?
  os             String? // macOS, Windows, iOS, Android
  osVersion      String?
  ipAddress      String?
  location       String? // City, Country
  userAgent      String? // Full user agent string

  // Activity
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  // Security
  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?

  @@index([userId])
  @@index([sessionToken])
  @@index([isRevoked])
  @@index([expiresAt])
}

model SecurityEvent {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventType String // NEW_LOGIN, SUSPICIOUS_LOGIN, SESSION_REVOKED, PASSWORD_CHANGED, etc.
  severity  String @default("INFO") // INFO, WARNING, CRITICAL

  // Event Details
  title       String
  description String?
  deviceInfo  String?
  ipAddress   String?
  location    String?
  userAgent   String?

  // Metadata
  metadata String? // JSON string for additional data

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([eventType])
  @@index([createdAt])
}

enum DocumentType {
  NOTE
  ASSIGNMENT
  CERTIFICATE
  REPORT
  OTHER
}

// ============================================
// ENHANCED FEE MANAGEMENT SYSTEM SCHEMA
// ============================================

// Global Fee Structure (Template by Class)
model GlobalFeeStructure {
  id             String  @id @default(uuid()) @db.Uuid
  schoolId       String  @db.Uuid
  academicYearId String  @db.Uuid
  classId        Int
  name           String // e.g., "Class 10 Annual Fees 2024-25"
  description    String?
  mode           FeeMode @default(YEARLY)
  totalAmount    Float // Total calculated amount
  isActive       Boolean @default(true)

  // 3-State Workflow: DRAFT, ACTIVE, ARCHIVED
  status             String  @default("DRAFT")
  version            Int     @default(1)
  clonedFromId       String? @db.Uuid
  enableInstallments Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school           School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear     AcademicYear          @relation(fields: [academicYearId], references: [id])
  class            Class                 @relation(fields: [classId], references: [id])
  particulars      GlobalFeeParticular[]
  studentFees      StudentFee[]
  installmentRules FeeInstallmentRule[]

  @@unique([schoolId, academicYearId, classId])
  @@index([schoolId, academicYearId])
  @@index([classId])
  @@index([status])
}

// Fee Components (Tuition, Books, Transport, etc.)
model GlobalFeeParticular {
  id                   String      @id @default(uuid()) @db.Uuid
  globalFeeStructureId String      @db.Uuid
  name                 String // "Tuition Fee", "Transport Fee", etc.
  amount               Float
  isOptional           Boolean     @default(false)
  category             FeeCategory @default(TUITION)
  displayOrder         Int         @default(0)

  globalFeeStructure GlobalFeeStructure     @relation(fields: [globalFeeStructureId], references: [id], onDelete: Cascade)
  studentParticulars StudentFeeParticular[]

  @@index([globalFeeStructureId])
}

// Installment Rules (How to break down payments)
model FeeInstallmentRule {
  id                   String   @id @default(uuid()) @db.Uuid
  globalFeeStructureId String   @db.Uuid
  installmentNumber    Int // 1, 2, 3, 4...
  dueDate              DateTime
  percentage           Float // Percentage of total
  amount               Float // Fixed amount (calculated)
  lateFeeAmount        Float    @default(0)
  lateFeeAfterDays     Int      @default(0)

  globalFeeStructure  GlobalFeeStructure      @relation(fields: [globalFeeStructureId], references: [id], onDelete: Cascade)
  studentInstallments StudentFeeInstallment[]

  @@unique([globalFeeStructureId, installmentNumber])
  @@index([globalFeeStructureId])
  @@index([dueDate])
}

// Student Fee Assignment (Individual Student's Fee)
model StudentFee {
  id                   String  @id @default(uuid()) @db.Uuid
  studentId            String  @db.Uuid
  schoolId             String  @db.Uuid
  academicYearId       String  @db.Uuid
  globalFeeStructureId String? @db.Uuid // Null for custom fees

  // Amounts
  originalAmount Float // Before any discounts
  discountAmount Float @default(0)
  finalAmount    Float // After discounts
  paidAmount     Float @default(0)
  balanceAmount  Float // Remaining

  // Status
  status   FeeStatus @default(UNPAID)
  isCustom Boolean   @default(false) // Custom fee structure

  // Dates
  assignedDate    DateTime  @default(now())
  lastPaymentDate DateTime?

  // Relations
  student            Student             @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  school             School              @relation(fields: [schoolId], references: [id])
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id])
  globalFeeStructure GlobalFeeStructure? @relation(fields: [globalFeeStructureId], references: [id])

  particulars  StudentFeeParticular[]
  installments StudentFeeInstallment[]
  payments     FeePayment[]
  discounts    FeeDiscount[]

  @@unique([studentId, academicYearId])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@index([studentId])
}

// Individual Fee Components for Each Student
model StudentFeeParticular {
  id                 String    @id @default(uuid()) @db.Uuid
  studentFeeId       String    @db.Uuid
  globalParticularId String?   @db.Uuid
  name               String
  amount             Float
  paidAmount         Float     @default(0)
  status             FeeStatus @default(UNPAID)

  studentFee            StudentFee              @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  globalParticular      GlobalFeeParticular?    @relation(fields: [globalParticularId], references: [id])
  feeParticular         FeeParticular?          @relation(fields: [feeParticularId], references: [id])
  feeParticularId       String?                 @db.Uuid
  studentFeeStructure   StudentFeeStructure?    @relation(fields: [studentFeeStructureId], references: [id])
  studentFeeStructureId String?                 @db.Uuid
  installmentBreakdowns InstallmentParticular[]

  @@index([studentFeeId])
  @@index([status])
}

// Student Installments (Payment Schedule)
model StudentFeeInstallment {
  id                String            @id @default(uuid()) @db.Uuid
  studentFeeId      String            @db.Uuid
  installmentRuleId String?           @db.Uuid
  installmentNumber Int
  dueDate           DateTime
  amount            Float
  paidAmount        Float             @default(0)
  status            InstallmentStatus @default(PENDING)
  lateFee           Float             @default(0)
  isOverdue         Boolean           @default(false)
  paidDate          DateTime?

  studentFee           StudentFee              @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  installmentRule      FeeInstallmentRule?     @relation(fields: [installmentRuleId], references: [id])
  payments             FeePaymentInstallment[]
  particularBreakdowns InstallmentParticular[]

  @@unique([studentFeeId, installmentNumber])
  @@index([studentFeeId])
  @@index([status])
  @@index([dueDate])
  @@index([isOverdue])
}

// Discount Management
model FeeDiscount {
  id           String       @id @default(uuid()) @db.Uuid
  studentFeeId String       @db.Uuid
  reason       String
  discountType DiscountType @default(FIXED)
  value        Float // Percentage or Fixed Amount
  amount       Float // Calculated discount amount
  approvedBy   String?      @db.Uuid
  approvedDate DateTime?
  remarks      String?
  createdAt    DateTime     @default(now())

  studentFee StudentFee @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  approver   User?      @relation("ApprovedDiscounts", fields: [approvedBy], references: [id])

  @@index([studentFeeId])
}

// Payment Records
model FeePayment {
  id             String @id @default(uuid()) @db.Uuid
  studentFeeId   String @db.Uuid
  studentId      String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid

  // Payment Details
  amount          Float
  paymentMode     PaymentMode
  paymentMethod   PaymentMethod @default(CASH)
  transactionId   String?       @unique
  referenceNumber String?

  // Gateway Details (for online payments)
  gatewayName      String? // "Razorpay", "Stripe", etc.
  gatewayOrderId   String?
  gatewayPaymentId String?
  gatewayResponse  Json? // Store full gateway response

  // Gateway Settlement Details
  settlementStatus String? // pending, processed, failed
  bankReference    String? // RRN sent by bank

  // Webhook reconciliation
  webhookVerified Boolean   @default(false)
  reconciledAt    DateTime?

  // Status
  status        PaymentStatus @default(PENDING)
  failureReason String?

  // Dates
  paymentDate DateTime  @default(now())
  clearedDate DateTime?

  // Receipt
  receiptNumber String  @unique
  receiptUrl    String?

  // Collection Details
  collectedBy String? @db.Uuid
  remarks     String?

  // Relations
  studentFee   StudentFee   @relation(fields: [studentFeeId], references: [id])
  student      Student      @relation(fields: [studentId], references: [userId])
  school       School       @relation(fields: [schoolId], references: [id])
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  collector    User?        @relation("CollectedPayments", fields: [collectedBy], references: [id])

  installmentPayments   FeePaymentInstallment[]
  feeStructure          FeeStructure?           @relation(fields: [feeStructureId], references: [id])
  feeStructureId        String?                 @db.Uuid
  studentFeeStructure   StudentFeeStructure?    @relation(fields: [studentFeeStructureId], references: [id])
  studentFeeStructureId String?                 @db.Uuid
  receipts              Receipt[]

  @@index([studentFeeId])
  @@index([studentId])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@index([paymentDate])
  @@index([receiptNumber])
  @@index([gatewayOrderId])
  @@index([settlementStatus])
}

// Link Payments to Installments
model FeePaymentInstallment {
  id            String @id @default(uuid()) @db.Uuid
  paymentId     String @db.Uuid
  installmentId String @db.Uuid
  amount        Float // Amount allocated to this installment

  payment     FeePayment            @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  installment StudentFeeInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([installmentId])
}

// Payment Reminders
model FeeReminder {
  id            String       @id @default(uuid()) @db.Uuid
  studentId     String       @db.Uuid
  studentFeeId  String       @db.Uuid
  reminderType  ReminderType @default(DUE_SOON)
  message       String
  sentDate      DateTime     @default(now())
  scheduledDate DateTime
  status        String       @default("SENT") // SENT, FAILED, PENDING
  channel       String       @default("EMAIL") // EMAIL, SMS, APP

  student Student @relation(fields: [studentId], references: [userId])

  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
}

// ============================================
// CALENDAR & EVENTS SYSTEM
// ============================================

model CalendarEvent {
  id          String  @id @default(uuid()) @db.Uuid
  schoolId    String  @db.Uuid
  title       String
  description String? @db.Text

  // Event Type & Category
  eventType EventType     @default(CUSTOM)
  category  EventCategory @default(OTHER)

  // Date & Time
  startDate DateTime
  endDate   DateTime
  startTime String? // "09:00 AM"
  endTime   String? // "05:00 PM"
  isAllDay  Boolean  @default(false)

  // Location & Details
  location String?
  venue    String?

  // Visibility & Access
  isPublic       Boolean  @default(true)
  targetAudience Audience @default(ALL)

  // Color & Display
  color    String   @default("#3B82F6") // Hex color
  priority Priority @default(NORMAL)

  // Recurrence
  isRecurring    Boolean @default(false)
  recurrenceRule Json? // RRULE format

  // Creator Info
  createdById String? @db.Uuid
  createdBy   User?   @relation(fields: [createdById], references: [id])

  // Status
  status EventStatus @default(SCHEDULED)

  // System Fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school    School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  targets   CalendarEventTarget[]
  reminders EventReminder[]

  @@index([schoolId])
  @@index([startDate])
  @@index([endDate])
  @@index([eventType])
  @@index([category])
  @@index([status])
}

model CalendarEventTarget {
  id      String @id @default(uuid()) @db.Uuid
  eventId String @db.Uuid

  // Targeting Options
  classId   Int?
  sectionId Int?
  roleId    Int?
  userId    String? @db.Uuid

  // Relations
  event   CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  class   Class?        @relation(fields: [classId], references: [id])
  section Section?      @relation(fields: [sectionId], references: [id])
  role    Role?         @relation(fields: [roleId], references: [id])
  user    User?         @relation(fields: [userId], references: [id])

  @@index([eventId])
  @@index([classId])
  @@index([sectionId])
  @@index([userId])
}

model EventReminder {
  id           String        @id @default(uuid()) @db.Uuid
  eventId      String        @db.Uuid
  reminderType ReminderType?

  // Timing
  reminderTime Int // Minutes before event (e.g., 30, 60, 1440)
  scheduledAt  DateTime

  // Status
  isSent Boolean   @default(false)
  sentAt DateTime?

  // Relations
  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([scheduledAt])
  @@index([isSent])
}

// ============================================
// ENUMS
// ============================================

enum EventType {
  CUSTOM // User created events
  HOLIDAY // School holidays
  VACATION // Vacation periods
  EXAM // Examination events
  SPORTS // Sports events
  MEETING // Staff/Parent meetings
  ADMISSION // Admission related
  FEE_DUE // Fee payment deadlines
  BIRTHDAY // Birthday celebrations
}

enum EventCategory {
  ACADEMIC
  ADMINISTRATIVE
  SPORTS
  CULTURAL
  HOLIDAY
  EXAM
  MEETING
  CELEBRATION
  OTHER
}

enum EventStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
  POSTPONED
}

// ============================================
// ENUMS
// ============================================

enum FeeCategory {
  TUITION
  ADMISSION
  EXAMINATION
  LIBRARY
  LABORATORY
  SPORTS
  TRANSPORT
  HOSTEL
  MISCELLANEOUS
  DEVELOPMENT
  CAUTION_MONEY
}

enum FeeMode {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}

enum FeeStatus {
  PAID
  UNPAID
  PARTIAL
  OVERDUE
  WAIVED
}

enum InstallmentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  WAIVED
}

enum DiscountType {
  PERCENTAGE
  FIXED
  SCHOLARSHIP
  SIBLING
  STAFF_WARD
  MERIT
}

enum PaymentMode {
  ONLINE
  OFFLINE
}

enum PaymentMethod {
  CASH
  CHEQUE
  CARD
  UPI
  NET_BANKING
  WALLET
  DEMAND_DRAFT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

enum ReminderType {
  DUE_SOON
  OVERDUE
  PAYMENT_CONFIRMATION
  INSTALLMENT_DUE
}

// ============================================
// ONLINE EXAM & HALL ATTENDANCE SYSTEM
// ============================================

model OnlineExamQuestion {
  id            String @id @default(uuid()) @db.Uuid
  examId        String @db.Uuid
  question      String
  type          String // MCQ, SUBJECTIVE, CHECKBOX
  options       Json? // Array of options for MCQ/Checkbox
  correctAnswer Json? // Correct answer(s)
  marks         Float
  order         Int

  exam    Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers StudentExamAnswer[]

  @@index([examId])
}

model StudentExamAttempt {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  studentId String @db.Uuid

  startTime DateTime  @default(now())
  endTime   DateTime?
  status    String // IN_PROGRESS, COMPLETED, TERMINATED
  score     Float?

  securityViolations Json? // Log of tab switches, etc.

  exam    Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  student Student             @relation(fields: [studentId], references: [userId])
  answers StudentExamAnswer[]

  @@index([examId])
  @@index([studentId])
}

model StudentExamAnswer {
  id         String @id @default(uuid()) @db.Uuid
  attemptId  String @db.Uuid
  questionId String @db.Uuid

  answer        Json // Student's answer
  isCorrect     Boolean?
  marksObtained Float?

  attempt  StudentExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question OnlineExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model ExamHallInvigilator {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  hallId    String @db.Uuid
  teacherId String @db.Uuid

  assignedAt DateTime @default(now())

  // New fields for shift management
  date      DateTime
  startTime DateTime
  endTime   DateTime
  role      String?  @default("PRIMARY") // PRIMARY, ASSISTANT, RELIEF
  subjectId Int? // Optional link to specific subject paper

  exam    Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  hall    ExamHall      @relation(fields: [hallId], references: [id], onDelete: Cascade)
  teacher TeachingStaff @relation(fields: [teacherId], references: [userId])
  subject Subject?      @relation(fields: [subjectId], references: [id])

  @@index([examId])
  @@index([hallId])
  @@index([teacherId])
  @@index([subjectId])
}

model HallAttendance {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  hallId    String @db.Uuid
  studentId String @db.Uuid

  status   String // PRESENT, ABSENT
  markedBy String   @db.Uuid // Teacher/Admin ID
  markedAt DateTime @default(now())

  exam    Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  hall    ExamHall @relation(fields: [hallId], references: [id], onDelete: Cascade)
  student Student  @relation(fields: [studentId], references: [userId])

  @@unique([examId, studentId])
  @@index([examId])
  @@index([hallId])
}

// Marks entry status enum
enum MarkStatus {
  DRAFT
  SUBMITTED
  LOCKED
  PUBLISHED
}

// Evaluator assignments - teachers assigned to mark specific subjects/classes
model ExamEvaluator {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  teacherId String @db.Uuid
  subjectId Int
  classId   Int

  assignedAt DateTime @default(now())
  assignedBy String   @db.Uuid

  exam    Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  teacher TeachingStaff @relation("EvaluatorAssignments", fields: [teacherId], references: [userId])
  subject Subject       @relation(fields: [subjectId], references: [id])
  class   Class         @relation(fields: [classId], references: [id])

  @@unique([examId, teacherId, subjectId, classId])
  @@index([teacherId])
  @@index([examId])
}

// Marks submission tracking - per subject/class combination
model MarksSubmission {
  id        String @id @default(uuid()) @db.Uuid
  examId    String @db.Uuid
  subjectId Int
  classId   Int

  status       MarkStatus @default(DRAFT)
  submittedBy  String?    @db.Uuid
  submittedAt  DateTime?
  lockedAt     DateTime?
  lockedBy     String?    @db.Uuid
  unlockReason String?

  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([examId, subjectId, classId])
  @@index([examId])
}

model PromotionHistory {
  id        String @id @default(uuid()) @db.Uuid
  studentId String @db.Uuid

  fromClassId   Int
  toClassId     Int
  fromSectionId Int?
  toSectionId   Int?

  fromYearId String @db.Uuid
  toYearId   String @db.Uuid

  status  String // PROMOTED, DETAINED, CONDITIONAL
  remarks String?

  promotedAt DateTime @default(now())
  promotedBy String   @db.Uuid // User ID of Admin
  batchId    String?  @db.Uuid // Group promotions done together

  // Rollback tracking
  isRolledBack   Boolean   @default(false)
  rolledBackAt   DateTime?
  rolledBackBy   String?   @db.Uuid
  rollbackReason String?

  student     Student      @relation(fields: [studentId], references: [userId])
  fromClass   Class        @relation("PromotionFromClass", fields: [fromClassId], references: [id])
  toClass     Class        @relation("PromotionToClass", fields: [toClassId], references: [id])
  fromSection Section?     @relation("PromotionFromSection", fields: [fromSectionId], references: [id])
  toSection   Section?     @relation("PromotionToSection", fields: [toSectionId], references: [id])
  fromYear    AcademicYear @relation("PromotionFromYear", fields: [fromYearId], references: [id])
  toYear      AcademicYear @relation("PromotionToYear", fields: [toYearId], references: [id])
  promoter    User         @relation(fields: [promotedBy], references: [id])

  @@index([studentId])
  @@index([fromClassId])
  @@index([toClassId])
  @@index([fromYearId])
  @@index([batchId])
}

// ============================================
// MEDIA LIBRARY SYSTEM
// ============================================

model MediaLibrary {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  url          String // Image URL from UploadThing
  fileName     String
  fileSize     Int // Size in bytes
  mimeType     String // image/png, image/jpeg, etc.
  width        Int? // Image width (optional)
  height       Int? // Image height (optional)
  uploadedById String   @db.Uuid
  uploadedAt   DateTime @default(now())
  tags         Json? // Array for categorization
  altText      String? // Alternative text for accessibility

  // Relations
  school     School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  @@index([schoolId])
  @@index([uploadedById])
  @@index([uploadedAt])
}

// ============================================
// ALUMNI MANAGEMENT
// ============================================

model Alumni {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Original Student Information (preserved)
  originalStudentId String @unique @db.Uuid
  admissionNo       String
  name              String
  email             String
  contactNumber     String

  // Academic Information
  lastClassId      Int
  lastSectionId    Int
  lastAcademicYear String? @db.Uuid

  // Alumni Specific
  graduationYear Int
  leavingDate    DateTime @db.Date
  leavingReason  String // GRADUATED, TRANSFERRED, WITHDRAWN, OTHER

  // Contact Information
  currentAddress String?
  currentCity    String?
  currentState   String?
  currentCountry String?
  currentEmail   String?
  currentPhone   String?

  // Professional Information
  currentOccupation String?
  currentCompany    String?
  higherEducation   String? // University/College name
  achievements      String? // Text field for notable achievements

  // Engagement
  willingToMentor Boolean @default(false)
  canContact      Boolean @default(true)

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school      School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  lastClass   Class   @relation(fields: [lastClassId], references: [id])
  lastSection Section @relation(fields: [lastSectionId], references: [id])

  @@index([schoolId])
  @@index([graduationYear])
  @@index([leavingReason])
  @@index([email])
}

// ============================================
// PAYROLL MANAGEMENT SYSTEM
// ============================================

// Payroll Configuration per School
model PayrollConfig {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Pay Cycle
  payCycleDay Int @default(1) // Day of month to run payroll
  paymentDay  Int @default(7) // Day when salaries are disbursed

  // Working Hours
  standardWorkingDays  Int   @default(26)
  standardWorkingHours Float @default(8)

  // Statutory Configuration - Provident Fund
  enablePF          Boolean @default(true)
  pfEmployerPercent Float   @default(12)
  pfEmployeePercent Float   @default(12)
  pfWageLimit       Float   @default(15000) // Basic wage limit for PF

  // Statutory Configuration - ESI
  enableESI          Boolean @default(true)
  esiEmployerPercent Float   @default(3.25)
  esiEmployeePercent Float   @default(0.75)
  esiWageLimit       Float   @default(21000) // Gross wage limit for ESI

  // Professional Tax
  enableProfessionalTax Boolean @default(true)
  professionalTaxSlab   Json? // State-wise PT slabs

  // TDS Configuration
  enableTDS Boolean @default(true)
  tdsSlabs  Json? // Income tax slabs

  // Leave Encashment
  enableLeaveEncashment Boolean @default(false)
  leaveEncashmentRate   Float? // Per day rate

  // Overtime
  enableOvertime Boolean @default(false)
  overtimeRate   Float   @default(1.5) // Multiplier

  // Grace Period for Late
  lateGraceMinutes Int   @default(15)
  halfDayThreshold Float @default(4) // Hours for half day

  // Loan & Advance Settings
  enableLoanApplications          Boolean @default(false) // Teachers can apply for loans
  enableSalaryAdvanceApplications Boolean @default(false) // Teachers can request salary advance
  maxLoanAmount                   Float? // Maximum loan amount
  maxAdvancePercent               Float   @default(50) // Max % of salary for advance

  // Automation Settings
  autoSyncNewStaff         Boolean @default(true) // Auto-create payroll profile for new staff
  enableAutoPeriodCreation Boolean @default(false) // Auto-create payroll period on pay cycle day

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Employee Payroll Profile (extends User/Staff)
model EmployeePayrollProfile {
  id       String @id @default(uuid()) @db.Uuid
  userId   String @unique @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId String @db.Uuid

  // Employment Details
  employeeType     EmployeeType   @default(TEACHING)
  employmentType   EmploymentType @default(PERMANENT)
  joiningDate      DateTime
  confirmationDate DateTime?
  exitDate         DateTime?

  // Salary Details
  salaryStructureId String?          @db.Uuid
  salaryStructure   SalaryStructure? @relation(fields: [salaryStructureId], references: [id])

  // Bank Details
  bankName      String?
  bankBranch    String?
  accountNumber String?
  ifscCode      String?
  accountHolder String?
  upiId         String?

  // Tax Details
  panNumber    String?
  aadharNumber String?
  uanNumber    String? // PF UAN
  esiNumber    String?

  // Tax Regime
  taxRegime       TaxRegime @default(NEW)
  taxDeclarations Json? // Investment declarations for old regime

  // Status
  isActive Boolean @default(true)

  // Pending Updates (Self-Service - Requires Admin Approval)
  pendingBankDetails     Json? // {bankName, accountNumber, ifscCode, accountHolder}
  pendingIdDetails       Json? // {panNumber, aadharNumber, uanNumber, esiNumber}
  pendingSubmittedAt     DateTime?
  pendingApprovedAt      DateTime?
  pendingApprovedBy      String?   @db.Uuid
  pendingRejectedAt      DateTime?
  pendingRejectedBy      String?   @db.Uuid
  pendingRejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payslips     Payslip[]
  deductions   EmployeeDeduction[]
  loans        EmployeeLoan[]
  payrollItems PayrollItem[]

  @@index([schoolId])
  @@index([userId])
  @@index([employeeType])
  @@index([isActive])
}

enum EmployeeType {
  TEACHING
  NON_TEACHING
}

enum EmploymentType {
  PERMANENT
  CONTRACT
  PROBATION
  TEMPORARY
  PART_TIME
}

enum TaxRegime {
  OLD
  NEW
}

// Salary Structure Template
model SalaryStructure {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Earnings
  basicSalary      Float @default(0)
  hraPercent       Float @default(40) // % of basic
  daPercent        Float @default(0) // Dearness Allowance
  taAmount         Float @default(0) // Transport Allowance
  medicalAllowance Float @default(0)
  specialAllowance Float @default(0)
  otherAllowances  Json? // Custom allowances [{name, amount, type}]

  // Calculated CTC
  grossSalary Float @default(0)
  ctc         Float @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employees EmployeePayrollProfile[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([isActive])
}

// Payroll Period (Monthly processing)
model PayrollPeriod {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  month     Int // 1-12
  year      Int
  startDate DateTime
  endDate   DateTime

  // Working Days
  totalWorkingDays Int
  holidays         Int @default(0)
  weekends         Int @default(0)

  // Status
  status      PayrollStatus @default(DRAFT)
  processedAt DateTime?
  processedBy String?       @db.Uuid
  approvedAt  DateTime?
  approvedBy  String?       @db.Uuid
  paidAt      DateTime?

  // Bank Settlement Tracking
  bankSlipGeneratedAt   DateTime?
  bankTransferReference String?
  settlementConfirmedAt DateTime?
  settlementConfirmedBy String?   @db.Uuid

  // Summary
  totalEmployees   Int   @default(0)
  totalGrossSalary Float @default(0)
  totalDeductions  Float @default(0)
  totalNetSalary   Float @default(0)

  // Lock Status (prevent modifications after payout)
  isLocked     Boolean   @default(false)
  lockedAt     DateTime?
  lockedBy     String?   @db.Uuid
  lockedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payrollItems PayrollItem[]

  @@unique([schoolId, month, year])
  @@index([schoolId])
  @@index([status])
  @@index([month, year])
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  PENDING_APPROVAL
  APPROVED
  PAID
  CANCELLED
}

// School-level Payroll Settings
model PayrollSettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Approval Settings
  requireDirectorApproval Boolean @default(true)
  allowAdminToRunPayroll  Boolean @default(true)
  autoEmailPayslips       Boolean @default(false)

  // Thresholds
  maxSalaryWithoutApproval Float? // Optional: Auto-approve below this amount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// Individual Payroll Entry for each employee
model PayrollItem {
  id       String        @id @default(uuid()) @db.Uuid
  periodId String        @db.Uuid
  period   PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  employeeId String                 @db.Uuid
  employee   EmployeePayrollProfile @relation(fields: [employeeId], references: [id])

  // Attendance Data (synced from attendance module)
  daysWorked    Int   @default(0)
  daysAbsent    Int   @default(0)
  daysLeave     Int   @default(0)
  daysHoliday   Int   @default(0)
  overtimeHours Float @default(0)
  lateCount     Int   @default(0)
  halfDayCount  Int   @default(0)

  // Earnings Breakdown
  basicEarned    Float @default(0)
  hraEarned      Float @default(0)
  daEarned       Float @default(0)
  taEarned       Float @default(0)
  medicalEarned  Float @default(0)
  specialEarned  Float @default(0)
  overtimeEarned Float @default(0)
  incentives     Float @default(0)
  arrears        Float @default(0)
  otherEarnings  Json? // [{name, amount}]
  grossEarnings  Float @default(0)

  // Deductions Breakdown
  pfEmployee       Float @default(0)
  pfEmployer       Float @default(0)
  esiEmployee      Float @default(0)
  esiEmployer      Float @default(0)
  professionalTax  Float @default(0)
  tds              Float @default(0)
  loanDeduction    Float @default(0)
  advanceDeduction Float @default(0)
  lossOfPay        Float @default(0)
  otherDeductions  Json? // [{name, amount}]
  totalDeductions  Float @default(0)

  // Net Salary
  netSalary Float @default(0)

  // Readiness Status (for validation)
  readiness  PayrollReadiness @default(READY)
  holdReason String? // Reason if ON_HOLD or SKIPPED

  // Payment Status
  paymentStatus  PayrollPaymentStatus  @default(PENDING)
  paymentMethod  PayrollPaymentMethod?
  transactionId  String?
  paidAt         DateTime?
  paymentRemarks String?

  // Payslip Reference
  payslipId String? @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([periodId, employeeId])
  @@index([periodId])
  @@index([employeeId])
  @@index([paymentStatus])
  @@index([readiness])
}

enum PayrollReadiness {
  READY // Fully configured, can be paid
  ON_HOLD_BANK // Salary calculated but bank details missing
  ON_HOLD_APPROVAL // Profile changes pending approval
  SKIPPED_NO_STRUCTURE // No salary structure assigned
}

enum PayrollPaymentStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

enum PayrollPaymentMethod {
  BANK_TRANSFER
  NEFT
  RTGS
  UPI
  CASH
  CHEQUE
}

// Payslip Generation
model Payslip {
  id         String                 @id @default(uuid()) @db.Uuid
  employeeId String                 @db.Uuid
  employee   EmployeePayrollProfile @relation(fields: [employeeId], references: [id])

  month Int
  year  Int

  // Employee Snapshot (for record keeping)
  employeeName     String
  employeeId_staff String // Employee ID from staff record
  designation      String?
  department       String?
  bankAccount      String?
  panNumber        String?
  uanNumber        String?

  // Payslip Data (full snapshot)
  earnings   Json // {basic, hra, da, ta, medical, special, overtime, incentives, arrears, others}
  deductions Json // {pf, esi, pt, tds, loan, advance, lop, others}
  netSalary  Float

  // Attendance Summary
  attendanceSummary Json // {daysWorked, daysAbsent, daysLeave, holidays, lateCount}

  // PDF
  pdfUrl String?

  // Status
  status       PayslipStatus @default(GENERATED)
  sentAt       DateTime?
  downloadedAt DateTime?

  // Email Tracking
  emailedAt DateTime?
  emailId   String? // Email service ID for tracking

  createdAt DateTime @default(now())

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
  @@index([status])
}

enum PayslipStatus {
  GENERATED
  SENT
  DOWNLOADED
}

// Employee Deductions (recurring deductions like fines, adjustments)
model EmployeeDeduction {
  id         String                 @id @default(uuid()) @db.Uuid
  employeeId String                 @db.Uuid
  employee   EmployeePayrollProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  type        DeductionType
  description String
  amount      Float
  startDate   DateTime
  endDate     DateTime?
  frequency   DeductionFrequency @default(ONE_TIME)
  isActive    Boolean            @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([isActive])
}

enum DeductionType {
  PF_ARREARS
  FINE
  ADJUSTMENT
  SALARY_ADVANCE
  OTHER
}

enum DeductionFrequency {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

// Employee Loans/Advances
model EmployeeLoan {
  id         String                 @id @default(uuid()) @db.Uuid
  employeeId String                 @db.Uuid
  employee   EmployeePayrollProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  type            LoanType
  principalAmount Float
  interestRate    Float      @default(0)
  totalAmount     Float
  emiAmount       Float
  tenure          Int // months
  startDate       DateTime
  amountPaid      Float      @default(0)
  amountPending   Float
  status          LoanStatus @default(ACTIVE)

  approvedBy String?   @db.Uuid
  approvedAt DateTime?

  remarks String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repayments LoanRepayment[]

  @@index([employeeId])
  @@index([status])
}

enum LoanType {
  SALARY_ADVANCE
  PERSONAL_LOAN
  EMERGENCY_LOAN
  FESTIVAL_ADVANCE
}

enum LoanStatus {
  PENDING_APPROVAL
  ACTIVE
  COMPLETED
  CANCELLED
  DEFAULTED
}

model LoanRepayment {
  id     String       @id @default(uuid()) @db.Uuid
  loanId String       @db.Uuid
  loan   EmployeeLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  amount        Float
  month         Int
  year          Int
  payrollItemId String?         @db.Uuid
  status        RepaymentStatus @default(PENDING)
  paidAt        DateTime?

  createdAt DateTime @default(now())

  @@unique([loanId, month, year])
  @@index([loanId])
  @@index([status])
}

enum RepaymentStatus {
  PENDING
  DEDUCTED
  SKIPPED
  PAID_EXTERNALLY
}

// Enhanced Leave Bucket (monthly/yearly limits per leave type)
model LeaveBucket {
  id             String @id @default(uuid()) @db.Uuid
  schoolId       String @db.Uuid
  school         School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYearId String @db.Uuid

  leaveType LeaveType

  // Limits
  yearlyLimit     Int     @default(0)
  monthlyLimit    Int     @default(0) // 0 means no monthly limit
  carryForward    Boolean @default(false)
  maxCarryForward Int     @default(0)
  encashable      Boolean @default(false)
  encashmentRate  Float? // Per day rate

  // Probation Rules
  applicableDuringProbation Boolean @default(false)
  probationLimit            Int     @default(0)

  // Applicability
  applicableTo EmployeeType[] // [TEACHING, NON_TEACHING]

  // Description
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, academicYearId, leaveType])
  @@index([schoolId])
  @@index([academicYearId])
}

// Payroll Audit Log
model PayrollAuditLog {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  action     PayrollAuditAction
  entityType PayrollEntityType
  entityId   String             @db.Uuid

  performedBy   String @db.Uuid
  performerName String

  // Change Details
  previousData Json?
  newData      Json?
  description  String?

  // Context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([createdAt])
}

enum PayrollAuditAction {
  CREATE
  UPDATE
  DELETE
  PROCESS
  APPROVE
  REJECT
  PAY
  GENERATE_PAYSLIP
  SEND_PAYSLIP
}

enum PayrollEntityType {
  PAYROLL_CONFIG
  SALARY_STRUCTURE
  EMPLOYEE_PROFILE
  PAYROLL_PERIOD
  PAYROLL_ITEM
  PAYSLIP
  LOAN
  DEDUCTION
  LEAVE_BUCKET
}

model LoginAttempt {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  ipAddress String
  success   Boolean
  reason    String?
  schoolId  String?  @db.Uuid
  timestamp DateTime @default(now())
  userAgent String?

  @@index([ipAddress])
  @@index([email])
  @@index([timestamp])
}

model Director {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @unique @db.Uuid
  schoolId   String    @db.Uuid
  department String?
  joinDate   DateTime?

  // Approval tracking (Director can approve payroll and library requests)
  payrollApprovalsCount Int @default(0)
  libraryApprovalsCount Int @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([userId])
}

model Principal {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @unique @db.Uuid
  schoolId   String    @db.Uuid
  department String?
  joinDate   DateTime?

  // Approval tracking (Principal can approve payroll and library requests)
  payrollApprovalsCount Int @default(0)
  libraryApprovalsCount Int @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([userId])
}

model SchoolSettings {
  id                String  @id @default(uuid()) @db.Uuid
  schoolId          String  @unique @db.Uuid
  school            School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  admissionNoPrefix String? // e.g., "STU"
  employeeIdPrefix  String? // e.g., "EMP"

  // School Location for Geofencing & Attendance
  schoolLatitude   Float? // School GPS latitude
  schoolLongitude  Float? // School GPS longitude
  geofenceRadius   Int    @default(200) // Meters - transport driver geofencing (auto trip start/end)
  attendanceRadius Int    @default(500) // Meters - teacher attendance proximity check

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// ==================== FEE SETTINGS ====================

model FeeSettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid

  // General Settings
  currency            String  @default("INR")
  defaultFeeMode      String  @default("YEARLY") // MONTHLY, QUARTERLY, HALF_YEARLY, YEARLY
  allowPartialPayment Boolean @default(true)
  allowAdvancePayment Boolean @default(true)
  installmentFlexible Boolean @default(true) // If false, full payment only

  // Late Fee Settings
  lateFeeEnabled    Boolean @default(false)
  lateFeeType       String  @default("FIXED") // FIXED or PERCENTAGE
  lateFeeAmount     Float   @default(0)
  lateFeePercentage Float   @default(0)
  gracePeriodDays   Int     @default(15)
  autoApplyLateFee  Boolean @default(false)

  // Online Payment Settings
  onlinePaymentEnabled Boolean @default(false)
  paymentGateway       String? // Deprecated in favor of SchoolPaymentSettings provider
  sandboxMode          Boolean @default(true)

  // Bank Account Details (for offline payments reference)
  showBankDetails   Boolean @default(false)
  bankName          String?
  accountNumber     String?
  ifscCode          String?
  accountHolderName String?
  branchName        String?
  upiId             String?
  bankQrCodeUrl     String? // URL to QR image

  // Receipt Settings
  receiptPrefix       String  @default("REC")
  receiptTemplate     String  @default("default") // default, detailed, minimal
  autoGenerateReceipt Boolean @default(true)
  showSchoolLogo      Boolean @default(true)
  receiptFooterText   String?

  // Notification Settings
  emailReminders          Boolean @default(true)
  smsReminders            Boolean @default(false)
  pushReminders           Boolean @default(false)
  reminderDaysBefore      Int     @default(7)
  overdueReminders        Boolean @default(true)
  overdueReminderInterval Int     @default(7) // Days between overdue reminders

  // Discount Settings
  siblingDiscountEnabled         Boolean @default(false)
  siblingDiscountPercentage      Float   @default(0)
  earlyPaymentDiscountEnabled    Boolean @default(false)
  earlyPaymentDiscountPercentage Float   @default(0)
  earlyPaymentDays               Int     @default(10) // Default Fallback
  earlyPaymentDaysMonthly        Int     @default(7)
  earlyPaymentDaysQuarterly      Int     @default(15)
  earlyPaymentDaysHalfYearly     Int     @default(30)
  earlyPaymentDaysYearly         Int     @default(60)
  staffWardDiscountEnabled       Boolean @default(false)
  staffWardDiscountPercentage    Float   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

// ==================== RECEIPT MANAGEMENT ====================

model Receipt {
  id            String @id @default(uuid()) @db.Uuid
  schoolId      String @db.Uuid
  receiptNumber String @unique // e.g., REC-2024-001

  // Payment Reference
  feePaymentId String     @db.Uuid
  feePayment   FeePayment @relation(fields: [feePaymentId], references: [id], onDelete: Cascade)

  // Student/Parent Info
  studentId String  @db.Uuid
  student   Student @relation(fields: [studentId], references: [userId])
  parentId  String? @db.Uuid
  parent    Parent? @relation(fields: [parentId], references: [id])

  // Receipt Data (JSON snapshot for reliable PDF generation)
  receiptData Json // Complete snapshot: student name, items, amounts, school details, etc.

  // PDF Storage
  pdfUrl       String? // URL to stored PDF file
  pdfGenerated Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([feePaymentId])
  @@index([studentId])
  @@index([receiptNumber])
  @@index([createdAt])
}

// ==================== PAYMENT GATEWAY SETTINGS ====================

model SchoolPaymentSettings {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Gateway Provider
  provider PaymentGatewayProvider @default(MANUAL)

  // Credentials (Encrypted/Stored safely)
  merchantId String? // e.g., MID for PayU/ICICI
  accessCode String? // e.g., Access Code for CCAvenue
  secretKey  String? // e.g., Hashing key/Salt
  workingKey String?

  // Configuration
  isEnabled Boolean @default(false)
  testMode  Boolean @default(false)

  // URLs (if custom, otherwise auto-generated)
  successUrl String?
  failureUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

enum PaymentGatewayProvider {
  MANUAL // Cash/Cheque/DD logged manually
  ICICI_EAZYPAY
  SBI_COLLECT
  HDFC_SMARTHUB
  AXIS_EASYPAY
  BILLDESK
  PAYU
  RAZORPAY // Optional future re-addition
  CASHFREE // Optional future re-addition
}

// ==================== FEE AUDIT LOG ====================

model FeeAuditLog {
  id           String  @id @default(uuid()) @db.Uuid
  schoolId     String  @db.Uuid
  studentFeeId String? @db.Uuid
  studentId    String? @db.Uuid

  action      String // FEE_ASSIGNED, PAYMENT_RECEIVED, REFUND_PROCESSED, DISCOUNT_APPLIED, LATE_FEE_APPLIED, FEE_MODIFIED, INSTALLMENT_MODIFIED
  description String

  // Value tracking
  previousValue Json? // Previous state
  newValue      Json? // New state
  amount        Float? // Amount involved (if applicable)

  // User tracking
  performedBy     String? @db.Uuid
  performedByName String?
  performedByRole String?

  // Additional context
  metadata  Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([studentFeeId])
  @@index([studentId])
  @@index([action])
  @@index([createdAt])
}

// ==================== SMS MODULE ====================

model SmsTemplate {
  id             String              @id @default(uuid()) @db.Uuid
  name           String // Friendly name e.g., "Attendance Absent"
  dltTemplateId  String              @unique // DLT registered template ID
  content        String // Template content with {VAR} placeholders
  variables      String[] // Allowed variable names
  category       SmsTemplateCategory
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  smsLogs        SmsLog[]
  triggerConfigs SmsTriggerConfig[]
}

model SmsWallet {
  id           String                 @id @default(uuid()) @db.Uuid
  schoolId     String                 @unique @db.Uuid
  school       School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  balance      Float                  @default(0) // Credits remaining
  totalCredits Float                  @default(0) // Total purchased
  usedCredits  Float                  @default(0) // Total used
  isFrozen     Boolean                @default(false)
  frozenReason String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  transactions SmsWalletTransaction[]

  @@index([schoolId])
}

model SmsWalletTransaction {
  id          String             @id @default(uuid()) @db.Uuid
  walletId    String             @db.Uuid
  wallet      SmsWallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type        SmsTransactionType
  amount      Float // Credits (positive for recharge, negative for usage)
  description String?
  referenceId String? // Payment gateway reference
  createdAt   DateTime           @default(now())

  @@index([walletId])
  @@index([createdAt])
}

model SmsLog {
  id           String          @id @default(uuid()) @db.Uuid
  schoolId     String          @db.Uuid
  templateId   String?         @db.Uuid
  template     SmsTemplate?    @relation(fields: [templateId], references: [id])
  recipients   String[] // Phone numbers
  message      String // Final rendered message
  status       SmsStatus
  cost         Float // Credits used
  fast2smsId   String? // API response ID
  errorMessage String?
  sentBy       String?         @db.Uuid // User who triggered
  trigger      SmsTriggerType? // If auto-triggered
  createdAt    DateTime        @default(now())

  @@index([schoolId, createdAt])
  @@index([status])
}

model SmsTriggerConfig {
  id          String         @id @default(uuid()) @db.Uuid
  schoolId    String         @db.Uuid
  triggerType SmsTriggerType
  templateId  String?        @db.Uuid
  template    SmsTemplate?   @relation(fields: [templateId], references: [id])
  isEnabled   Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([schoolId, triggerType])
  @@index([schoolId])
}

enum SmsTemplateCategory {
  ATTENDANCE
  FEE_REMINDER
  OTP
  NOTICE
  HOLIDAY
  GENERAL
}

enum SmsTransactionType {
  RECHARGE
  USAGE
  REFUND
  ADJUSTMENT
}

enum SmsStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum SmsTriggerType {
  ATTENDANCE_ABSENT
  FEE_DUE_REMINDER
  FEE_OVERDUE
  OTP_LOGIN
  NOTICE_BROADCAST
  HOLIDAY_ANNOUNCEMENT
}

model SmsSettings {
  id                 String   @id @default("default")
  costPerSms         Float    @default(0.20)
  minPurchase        Int      @default(100)
  creditPacks        Json     @default("[]")
  whitelistedDomains Json     @default("[]")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// ============================================
// AI SYSTEM - USAGE TRACKING & CONTROL
// ============================================

model AiUsageLog {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  userId       String   @db.Uuid
  userRole     String // ADMIN, SUPER_ADMIN
  feature      String // DASHBOARD_INSIGHTS, ATTENDANCE_SUMMARY, etc
  model        String // gemini-1.5-flash
  inputTokens  Int?
  outputTokens Int?
  totalTokens  Int?
  costUsd      Float?
  promptHash   String
  responseHash String?
  cached       Boolean  @default(false)
  createdAt    DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId, createdAt])
  @@index([userId])
  @@index([feature])
}

model AiInsightCache {
  id        String   @id @default(uuid()) @db.Uuid
  schoolId  String   @db.Uuid
  date      DateTime @db.Date
  dayType   String // HOLIDAY, WORKING, EXAM, HALF_DAY, SUNDAY, VACATION
  feature   String // DASHBOARD_INSIGHTS
  response  String   @db.Text
  expiresAt DateTime
  createdAt DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, date, feature])
  @@index([schoolId, date])
  @@index([expiresAt])
}

model AiSettings {
  id                String   @id @default(uuid()) @db.Uuid
  schoolId          String   @unique @db.Uuid
  aiEnabled         Boolean  @default(true)
  allowedRoles      String[] @default(["SUPER_ADMIN", "ADMIN"])
  dailyLimit        Int      @default(1) // Max AI runs per day per school
  monthlyTokenLimit Int? // Optional monthly token budget
  model             String   @default("gemini-1.5-flash")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model AiActionPolicy {
  id        String   @id @default(uuid()) @db.Uuid
  feature   String   @unique // DASHBOARD_INSIGHTS, FEES, ATTENDANCE
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ============================================
// CRON NOTIFICATION SYSTEM
// ============================================

// Track sent cron notifications (deduplication + audit)
model CronNotificationLog {
  id       String   @id @default(uuid()) @db.Uuid
  schoolId String   @db.Uuid
  userId   String   @db.Uuid
  ruleType String // ATTENDANCE_REMINDER, FEE_DUE, MARKED_ABSENT, etc.
  ruleKey  String // Unique key (e.g., "absent_2024-01-09_userId")
  title    String
  message  String
  priority String   @default("NORMAL") // NORMAL, HIGH, CRITICAL
  sentAt   DateTime @default(now())

  @@unique([userId, ruleKey]) // Prevent duplicate notifications
  @@index([schoolId, sentAt])
  @@index([userId, ruleType, sentAt])
  @@index([sentAt])
}

// Daily limit tracker (max 3 pushes/user/day)
model NotificationDailyLimit {
  id     String   @id @default(uuid()) @db.Uuid
  userId String   @db.Uuid
  date   DateTime @db.Date
  count  Int      @default(0)

  @@unique([userId, date])
  @@index([date])
}

// ============================================
// SCHOOL CAROUSEL - DASHBOARD GALLERY
// ============================================

model SchoolCarouselImage {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  imageUrl     String
  caption      String?
  displayOrder Int     @default(0)

  audience String[] @default(["ALL"])
  category String? // For grouping images (e.g., "Events", "Announcements", "Sports")

  expiryDate DateTime? // e.g., for limited-time event banners

  uploadedById String? @db.Uuid
  uploadedBy   User?   @relation("UserUploadedCarouselImages", fields: [uploadedById], references: [id])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?  @db.Uuid

  @@index([schoolId])
}

// ============================================
// HPC MODULE - NEP 2020 HOLISTIC PROGRESS CARD
// ============================================

// Subject Competencies (Academic Assessment Upgrade)
model Competency {
  id          String  @id @default(uuid()) @db.Uuid
  subjectId   Int
  name        String // "Conceptual Understanding", "Problem Solving"
  description String?
  order       Int     @default(0)
  isActive    Boolean @default(true)

  subject     Subject                @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  assessments CompetencyAssessment[]

  @@unique([subjectId, name])
  @@index([subjectId])
}

model CompetencyAssessment {
  id             String  @id @default(uuid()) @db.Uuid
  studentId      String  @db.Uuid
  competencyId   String  @db.Uuid
  examId         String? @db.Uuid
  academicYearId String  @db.Uuid
  termNumber     Int // 1, 2, 3

  grade        String? // A, B, C, D, E or 1-5 scale
  remarks      String?
  assessedById String   @db.Uuid
  assessedAt   DateTime @default(now())

  student      Student      @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  competency   Competency   @relation(fields: [competencyId], references: [id], onDelete: Cascade)
  exam         Exam?        @relation(fields: [examId], references: [id])
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  assessedBy   User         @relation("CompetencyAssessor", fields: [assessedById], references: [id])

  @@unique([studentId, competencyId, academicYearId, termNumber])
  @@index([studentId])
  @@index([competencyId])
  @@index([examId])
}

// Co-Curricular Activities & Life Skills
model ActivityCategory {
  id          String  @id @default(uuid()) @db.Uuid
  schoolId    String  @db.Uuid
  name        String // "Sports", "Arts", "Leadership", "Community Service"
  description String?
  icon        String?
  order       Int     @default(0)
  isActive    Boolean @default(true)

  school     School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  activities Activity[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Activity {
  id          String  @id @default(uuid()) @db.Uuid
  categoryId  String  @db.Uuid
  name        String // "Cricket", "Debate", "Art Club"
  description String?
  isActive    Boolean @default(true)

  category       ActivityCategory        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  participations StudentActivityRecord[]

  @@index([categoryId])
}

model StudentActivityRecord {
  id             String @id @default(uuid()) @db.Uuid
  studentId      String @db.Uuid
  activityId     String @db.Uuid
  academicYearId String @db.Uuid
  termNumber     Int

  participationRating Int     @default(0) // 1-5 stars
  consistencyRating   Int     @default(0) // 1-5 stars
  attitudeRating      Int     @default(0) // 1-5 stars
  remarks             String?
  achievements        String? // "Won 1st place in inter-school"

  recordedById String   @db.Uuid
  recordedAt   DateTime @default(now())

  student      Student      @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  activity     Activity     @relation(fields: [activityId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  recordedBy   User         @relation("ActivityRecorder", fields: [recordedById], references: [id])

  @@unique([studentId, activityId, academicYearId, termNumber])
  @@index([studentId])
  @@index([activityId])
}

// Behavior & Social-Emotional Learning (SEL)
model SELParameter {
  id          String  @id @default(uuid()) @db.Uuid
  schoolId    String  @db.Uuid
  name        String // "Discipline", "Empathy", "Communication"
  description String?
  category    String? // "Social", "Emotional", "Behavioral"
  order       Int     @default(0)
  isActive    Boolean @default(true)

  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assessments SELAssessment[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

enum SELGrade {
  NEEDS_IMPROVEMENT
  DEVELOPING
  PROFICIENT
  EXCELLENT
}

model SELAssessment {
  id             String @id @default(uuid()) @db.Uuid
  studentId      String @db.Uuid
  parameterId    String @db.Uuid
  academicYearId String @db.Uuid
  termNumber     Int

  grade   SELGrade
  remarks String?

  assessedById String   @db.Uuid
  assessedAt   DateTime @default(now())

  student      Student      @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  parameter    SELParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  assessedBy   User         @relation("SELAssessor", fields: [assessedById], references: [id])

  @@unique([studentId, parameterId, academicYearId, termNumber])
  @@index([studentId])
  @@index([parameterId])
}

// Student Self-Reflection
model StudentReflection {
  id             String @id @default(uuid()) @db.Uuid
  studentId      String @db.Uuid
  academicYearId String @db.Uuid
  termNumber     Int

  learnedWell     String  @db.Text // "What did you learn well?"
  foundDifficult  String? @db.Text // "What was difficult?"
  wantToImprove   String? @db.Text // "What do you want to improve?"
  favoriteSubject String?
  goals           String? @db.Text // "Goals for next term"

  submittedAt DateTime @default(now())

  student      Student      @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([studentId, academicYearId, termNumber])
  @@index([studentId])
}

// Teacher Narrative Feedback
model TeacherFeedback {
  id             String @id @default(uuid()) @db.Uuid
  studentId      String @db.Uuid
  teacherId      String @db.Uuid
  academicYearId String @db.Uuid
  termNumber     Int

  strengths      String  @db.Text // "Key strengths observed"
  areasToImprove String? @db.Text // "Areas needing improvement"
  suggestions    String? @db.Text // "Suggested actions"
  overallRemarks String? @db.Text

  submittedAt DateTime @default(now())

  student      Student       @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  teacher      TeachingStaff @relation(fields: [teacherId], references: [userId])
  academicYear AcademicYear  @relation(fields: [academicYearId], references: [id])

  @@unique([studentId, teacherId, academicYearId, termNumber])
  @@index([studentId])
  @@index([teacherId])
}

// Parent Feedback (Optional)
model ParentFeedback {
  id             String @id @default(uuid()) @db.Uuid
  studentId      String @db.Uuid
  parentId       String @db.Uuid
  academicYearId String @db.Uuid
  termNumber     Int

  childInterest     String? // "High", "Moderate", "Low"
  homeParticipation String? // "Active", "Needs Encouragement"
  observations      String? @db.Text
  suggestions       String? @db.Text

  submittedAt DateTime @default(now())

  student      Student      @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  parent       Parent       @relation(fields: [parentId], references: [id])
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([studentId, parentId, academicYearId, termNumber])
  @@index([studentId])
  @@index([parentId])
}

// HPC Generation Record
model HPCReport {
  id             String @id @default(uuid()) @db.Uuid
  studentId      String @db.Uuid
  academicYearId String @db.Uuid
  termNumber     Int
  schoolId       String @db.Uuid

  pdfUrl        String?
  generatedAt   DateTime @default(now())
  generatedById String   @db.Uuid

  student      Student      @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  generatedBy  User         @relation("HPCGenerator", fields: [generatedById], references: [id])

  @@unique([studentId, academicYearId, termNumber])
  @@index([studentId])
  @@index([schoolId])
}

model TermLock {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  academicYearId String   @db.Uuid
  termNumber     Int
  isLocked       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([schoolId, academicYearId, termNumber])
  @@index([schoolId])
}

// NEP 2020 Learning Stages
enum NEPStage {
  FOUNDATIONAL // Pre-primary to Class 2: Play-based, habits, motor skills
  PREPARATORY // Class 3-5: Basic academics, expression, group work
  MIDDLE // Class 6-8: Subject depth, critical thinking, life skills
  SECONDARY // Class 9-12: Academic rigor, career orientation, ethics
}

// Stage-based HPC Template Configuration
model HPCStageTemplate {
  id       String   @id @default(uuid()) @db.Uuid
  schoolId String   @db.Uuid
  stage    NEPStage
  name     String // e.g. "Foundational Stage Template"

  // Weightages (must sum to 1.0)
  academicWeight Float @default(0.4) // Weight for academics
  selWeight      Float @default(0.3) // Weight for SEL
  activityWeight Float @default(0.3) // Weight for activities

  // Display options
  showMarks       Boolean @default(false) // Foundational/Preparatory = false
  showGrades      Boolean @default(true)
  showPercentages Boolean @default(false)

  // Stage-specific categories and competencies (JSON for flexibility)
  categories Json? // { "academic": [...], "sel": [...], "activity": [...] }
  gradeScale Json? // Custom grade scale if different from default

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, stage])
  @@index([schoolId])
}

// ============================================
// BIOMETRIC SYSTEM - DEVICE & ATTENDANCE INTEGRATION
// ============================================

enum BiometricDeviceType {
  FINGERPRINT
  RFID
  COMBO
}

enum ConnectionType {
  HTTP
  HTTPS
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
  NEVER_SYNCED
}

enum RfidCardType {
  MIFARE
  EM4100
  HID
  OTHER
}

enum MappingType {
  RFID_ENROLL
  FINGERPRINT_ENROLL
}

enum MappingStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELLED
}

// Biometric Device Configuration
model BiometricDevice {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Device Configuration
  name       String // e.g., "Main Gate Entry"
  deviceType BiometricDeviceType
  ipAddress  String
  port       Int                 @default(80)
  username   String // Credentials for ISAPI auth
  password   String // Encrypted/hashed

  // Connection Settings
  connectionType   ConnectionType @default(HTTP)
  isEnabled        Boolean        @default(true)
  pollingInterval  Int            @default(60) // seconds
  lastSyncedAt     DateTime?
  lastSyncStatus   SyncStatus?
  lastErrorMessage String?

  // Capabilities (internal metadata)
  supportsFingerprint Boolean @default(true)
  supportsRfid        Boolean @default(true)
  supportsFace        Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school       School                     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  identityMaps BiometricIdentityMap[]
  rfidMaps     RfidIdentityMap[]
  events       BiometricAttendanceEvent[]

  @@unique([schoolId, ipAddress, port])
  @@index([schoolId])
  @@index([isEnabled])
}

// User-to-Device Identity Mapping
model BiometricIdentityMap {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  userId   String @db.Uuid
  deviceId String @db.Uuid

  // Device User ID (employeeNo in Hikvision)
  deviceUserId String

  // Enrollment Status (polled from device)
  fingerprintCount Int     @default(0)
  hasCard          Boolean @default(false)
  hasFace          Boolean @default(false)

  isActive   Boolean  @default(true)
  enrolledAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  school School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  device BiometricDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@unique([deviceId, deviceUserId])
  @@index([schoolId])
  @@index([userId])
}

// RFID Card Identity Mapping
model RfidIdentityMap {
  id       String  @id @default(uuid()) @db.Uuid
  schoolId String  @db.Uuid
  userId   String  @db.Uuid
  deviceId String? @db.Uuid // Optional - synced to specific device

  // Card Details
  cardUid    String // Raw UID from card
  cardNumber String? // Printed number if different
  cardType   RfidCardType @default(MIFARE)

  isActive     Boolean   @default(true)
  isPrimary    Boolean   @default(true) // For handling replacements
  assignedAt   DateTime  @default(now())
  revokedAt    DateTime?
  revokedBy    String?   @db.Uuid
  revokeReason String?

  school School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  device BiometricDevice? @relation(fields: [deviceId], references: [id])

  @@unique([cardUid]) // Globally unique card
  @@index([schoolId])
  @@index([userId])
  @@index([cardUid])
}

// Temporary State for Enrollment Sessions
model TemporaryMappingState {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  userId   String @db.Uuid
  deviceId String @db.Uuid

  mappingType MappingType // RFID_ENROLL, FINGERPRINT_ENROLL
  status      MappingStatus @default(PENDING)

  expiresAt   DateTime // Auto-cleanup stale states
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId, mappingType])
  @@index([schoolId])
  @@index([expiresAt])
}

// Raw Attendance Events from Biometric Devices
model BiometricAttendanceEvent {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid
  deviceId String @db.Uuid

  // Event Data (from device)
  deviceUserId String // employeeNo
  eventType    String // verifyFingerprint, verifyCard, etc.
  eventTime    DateTime
  rawEventId   String // Original event ID from device
  rawPayload   Json // Full event for audit

  // Resolution
  resolvedUserId  String?   @db.Uuid
  processedAt     DateTime?
  processingError String?

  // Deduplication
  eventHash String @unique // device_id + deviceUserId + timestamp hash

  createdAt DateTime @default(now())

  school       School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  device       BiometricDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  resolvedUser User?           @relation("ResolvedBiometricEvents", fields: [resolvedUserId], references: [id])

  @@index([schoolId, eventTime])
  @@index([deviceId, eventTime])
  @@index([resolvedUserId])
}
