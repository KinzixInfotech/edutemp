generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
}

model School {
  id                     String                  @id @default(uuid()) @db.Uuid
  name                   String
  domain                 String                  @unique
  schoolCode             String                  @unique
  profilePicture         String
  location               String
  contactNumber          String
  SubscriptionType       String
  Language               String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  deletedAt              DateTime?
  AcademicYear           AcademicYear[]
  admins                 Admin[]
  classes                Class[]
  exams                  Exam[]
  FeePayment             FeePayment[]
  FeeStructure           FeeStructure[]
  galleries              Gallery[]
  InventoryItem          InventoryItem[]
  libraryBooks           LibraryBook[]
  MasterAdmin            MasterAdmin?
  NonTeachingStaff       NonTeachingStaff[]
  Notice                 Notice[]
  Student                Student[]
  StudentFeeStructure    StudentFeeStructure[]
  Syllabus               Syllabus[]
  TeachingStaff          TeachingStaff[]
  // Transport           Transport[]
  users                  User[]
  Vehicle                Vehicle[]
  Route                  Route[]
  Assignment             Assignment[]
  AdmissionForm          AdmissionForm[]
  Application            Application[]
  Stage                  Stage[]
  Upload                 Upload[]
  CertificateTemplate    CertificateTemplate[]
  CertificateGenerated   CertificateGenerated[]
  DigitalIdCard          DigitalIdCard[]
  AdmitCard              AdmitCard[]
  QrVerificationSettings QrVerificationSettings?
  PdfExportSettings      PdfExportSettings?
  Signature              Signature[]
  Stamp                  Stamp[]
  DocumentTemplate       DocumentTemplate[]
  globalFeeStructures    GlobalFeeStructure[]
  studentFees            StudentFee[]
  parents                Parent[]

  @@index([name])
}

// admission module
model AdmissionForm {
  id           String        @id @default(uuid()) @db.Uuid
  schoolId     String        @db.Uuid
  name         String
  description  String?
  slug         String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  fields       FormField[]
  applications Application[]

  @@index([schoolId])
  @@index([slug])
}

model FormField {
  id              String        @id @default(uuid()) @db.Uuid
  admissionFormId String        @db.Uuid
  name            String
  type            String // e.g., "text", "email", "file", "select"
  required        Boolean       @default(false)
  options         Json? // for select fields
  order           Int
  admissionForm   AdmissionForm @relation(fields: [admissionFormId], references: [id], onDelete: Cascade)

  @@index([admissionFormId])
}

// model Application {
//   id              String                @id @default(uuid()) @db.Uuid
//   schoolId        String                @db.Uuid
//   admissionFormId String                @db.Uuid
//   applicantName   String
//   applicantEmail  String
//   data            Json // submitted form data
//   submittedAt     DateTime              @default(now())
//   currentStageId  String                @db.Uuid
//   createdById     String?               @db.Uuid // optional user who submitted
//   school          School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   admissionForm   AdmissionForm         @relation(fields: [admissionFormId], references: [id], onDelete: Cascade)
//   currentStage    Stage                 @relation("CurrentStage", fields: [currentStageId], references: [id])
//   createdBy       User?                 @relation(fields: [createdById], references: [id])
//   documents       ApplicationDocument[]
//   stageHistory    StageHistory[]
//   payments        Payment[]

//   @@index([schoolId])
//   @@index([admissionFormId])
//   @@index([currentStageId])
//   @@index([submittedAt])
//   @@index([applicantEmail])
// }
model Application {
  id              String   @id @default(uuid()) @db.Uuid
  schoolId        String   @db.Uuid
  admissionFormId String   @db.Uuid
  applicantName   String
  applicantEmail  String
  data            Json
  submittedAt     DateTime @default(now())
  currentStageId  String   @db.Uuid
  createdById     String?  @db.Uuid

  school        School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  admissionForm AdmissionForm         @relation(fields: [admissionFormId], references: [id], onDelete: Cascade)
  currentStage  Stage                 @relation("CurrentStage", fields: [currentStageId], references: [id])
  createdBy     User?                 @relation(fields: [createdById], references: [id])
  documents     ApplicationDocument[]
  stageHistory  StageHistory[]
  payments      Payment[]

  @@unique([schoolId, admissionFormId, applicantEmail])
}

model ApplicationDocument {
  id            String      @id @default(uuid()) @db.Uuid
  applicationId String      @db.Uuid
  fileUrl       String
  fileName      String
  mimeType      String
  size          Int
  uploadedAt    DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model Stage {
  id                  String         @id @default(uuid()) @db.Uuid
  name                StageName      @unique
  order               Int            @unique
  requiresTest        Boolean        @default(false)
  requiresInterview   Boolean        @default(false)
  feeRequired         Boolean        @default(false)
  currentApplications Application[]  @relation("CurrentStage")
  stageHistory        StageHistory[]
  School              School?        @relation(fields: [schoolId], references: [id])
  schoolId            String?        @db.Uuid
}

// model StageHistory {
//   id            String      @id @default(uuid()) @db.Uuid
//   applicationId String      @db.Uuid
//   stageId       String      @db.Uuid
//   movedById     String?     @db.Uuid // Made optional for system/public actions
//   movedAt       DateTime    @default(now())
//   notes         String?
//   application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
//   stage         Stage       @relation(fields: [stageId], references: [id])
//   movedBy       User?       @relation(fields: [movedById], references: [id])

//   @@index([applicationId])
//   @@index([movedAt])
// }
model StageHistory {
  id            String   @id @default(uuid()) @db.Uuid
  applicationId String   @db.Uuid
  stageId       String   @db.Uuid
  movedById     String?  @db.Uuid
  movedAt       DateTime @default(now())
  notes         String?

  // Stage-specific fields
  testPassed    Boolean?
  testScore     Float?
  testDate      DateTime?
  interviewDate DateTime?
  testStartTime DateTime?
  testEndTime   DateTime?
  testVenue     String?

  interviewNotes String?

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stage       Stage       @relation(fields: [stageId], references: [id])
  movedBy     User?       @relation(fields: [movedById], references: [id])

  @@index([applicationId])
  @@index([movedAt])
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  applicationId String?       @db.Uuid
  amount        Float
  status        PaymentStatus @default(PENDING)
  transactionId String?
  paidAt        DateTime?
  application   Application?  @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([status])
}

// Note: Use PostgreSQL provider as in current schema.
// Transport Models
model Vehicle {
  id             String            @id @default(uuid()) @db.Uuid
  schoolId       String            @db.Uuid
  licensePlate   String            @unique
  model          String
  capacity       Int
  maintenanceDue DateTime?
  status         String // e.g., "active", "maintenance", "inactive"
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id])
  routes         Route[]
  locations      VehicleLocation[]

  @@index([schoolId])
  @@index([licensePlate])
}

model Route {
  id                 String                   @id @default(uuid()) @db.Uuid
  schoolId           String                   @db.Uuid
  name               String
  stops              Json // Array of {name: string, lat: float, lng: float}
  assignedVehicleId  String?                  @db.Uuid
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  school             School                   @relation(fields: [schoolId], references: [id])
  vehicle            Vehicle?                 @relation(fields: [assignedVehicleId], references: [id])
  studentAssignments StudentRouteAssignment[]

  @@index([schoolId])
  @@index([name])
}

model StudentRouteAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  studentId  String   @db.Uuid
  routeId    String   @db.Uuid
  schoolId   String   @db.Uuid
  assignedAt DateTime @default(now())
  student    Student  @relation(fields: [studentId], references: [userId])
  route      Route    @relation(fields: [routeId], references: [id])

  @@index([studentId])
  @@index([routeId])
}

model VehicleLocation {
  id        String   @id @default(uuid()) @db.Uuid
  vehicleId String   @db.Uuid
  latitude  Float
  longitude Float
  timestamp DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([timestamp])
}

model Assignment {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  classId     Int
  title       String
  description String?
  dueDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  school      School   @relation(fields: [schoolId], references: [id])
  class       Class    @relation(fields: [classId], references: [id])

  @@index([schoolId])
  @@index([classId])
  @@index([dueDate])
}

model InventoryItem {
  id              String                 @id @default(uuid())
  name            String
  category        String
  schoolId        String                 @db.Uuid
  description     String?
  quantity        Int
  minimumQuantity Int
  maximumQuantity Int
  unit            String
  purchaseDate    DateTime
  costPerUnit     Float
  vendorName      String
  vendorContact   String
  warrantyPeriod  String?
  location        String
  status          String
  barcode         String?
  notes           String?
  School          School                 @relation(fields: [schoolId], references: [id])
  transactions    InventoryTransaction[]
  purchaseOrders  PurchaseOrderItem[]
}

model Syllabus {
  id             String        @id @default(uuid())
  academicYearId String?       @db.Uuid
  fileUrl        String
  uploadedAt     DateTime      @default(now())
  schoolId       String        @db.Uuid
  classId        Int?
  AcademicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  Class          Class?        @relation(fields: [classId], references: [id])
  School         School        @relation(fields: [schoolId], references: [id])
}

model InventoryTransaction {
  id              String        @id @default(uuid())
  itemId          String
  transactionType String
  quantity        Int
  date            DateTime
  issuedToId      String?
  issuedToName    String?
  handledById     String
  handledByName   String
  remarks         String?
  status          String
  item            InventoryItem @relation(fields: [itemId], references: [id])
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  orderDate        DateTime
  expectedDelivery DateTime
  vendorName       String
  vendorContact    String
  approvedById     String
  approvedByName   String
  status           String
  items            PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  itemId          String
  name            String
  quantity        Int
  costPerUnit     Float
  item            InventoryItem @relation(fields: [itemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
}

model Notice {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @db.Uuid

  // Basic Info
  title       String
  description String  @db.Text // Changed to Text for long content
  subtitle    String? // NEW: For preview text

  // File Management
  fileUrl     String?
  attachments Json? // NEW: Array of multiple attachments

  // Categorization
  category NoticeCategory // NEW: Enum instead of String
  audience Audience       @default(ALL)
  priority Priority       @default(NORMAL)
  status   Status         @default(DRAFT)

  // Author Info
  createdById String? @db.Uuid
  issuedBy    String? // NEW: Display name
  issuerRole  String? // NEW: "Science Department Head"

  // Dates & Times
  publishedAt DateTime?
  expiryDate  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt

  // Important Dates (for trips, deadlines, etc.)
  importantDates Json? // NEW: [{label: string, value: string}]

  // Read Status Tracking
  viewCount Int @default(0) // NEW: Track views

  // Relations
  Author       User?          @relation(fields: [createdById], references: [id])
  School       School         @relation(fields: [schoolId], references: [id])
  NoticeTarget NoticeTarget[]
  NoticeReads  NoticeRead[] // NEW: Track who read it

  @@index([schoolId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([publishedAt])
  @@index([expiryDate])
}

model NoticeTarget {
  id       String @id @default(uuid()) @db.Uuid
  noticeId String @db.Uuid

  // Targeting Options
  classId   Int?
  sectionId Int?
  roleId    Int? // NEW: Target specific roles
  userId    String? @db.Uuid // NEW: Target specific users

  Class   Class?   @relation(fields: [classId], references: [id])
  Notice  Notice   @relation(fields: [noticeId], references: [id])
  Section Section? @relation(fields: [sectionId], references: [id])
  Role    Role?    @relation(fields: [roleId], references: [id]) // NEW
  User    User?    @relation("NoticeTargetUser", fields: [userId], references: [id]) // NEW

  @@index([noticeId])
  @@index([classId])
  @@index([sectionId])
  @@index([roleId])
  @@index([userId])
}

// NEW: Track read status for each user
model NoticeRead {
  id       String   @id @default(uuid()) @db.Uuid
  noticeId String   @db.Uuid
  userId   String   @db.Uuid
  readAt   DateTime @default(now())

  Notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  User   User   @relation("NoticeReads", fields: [userId], references: [id])

  @@unique([noticeId, userId])
  @@index([noticeId])
  @@index([userId])
  @@index([readAt])
}

// Enhanced Enums
enum NoticeCategory {
  GENERAL
  ACADEMIC
  EXAM
  EMERGENCY
  EVENT
  SPORTS
  HOLIDAY
  FEE
  TRANSPORT
  LIBRARY
  ANNOUNCEMENT
}

enum Audience {
  ALL
  STUDENTS
  TEACHERS
  PARENTS
  STAFF // Added
  TEACHING_STAFF // Added
  NON_TEACHING_STAFF // Added
  ADMINS // Added
  CLASS
  SECTION
  CUSTOM // Added for specific users
}

enum Priority {
  NORMAL
  IMPORTANT
  URGENT
  CRITICAL // Added
}

enum Status {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED // Added for future publishing
  EXPIRED // Added for auto-expiry
}

model Role {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  users         User[]
  noticeTargets NoticeTarget[]
}

model User {
  id                    String                 @id @db.Uuid
  schoolId              String?                @db.Uuid
  roleId                Int
  email                 String                 @unique
  password              String
  name                  String?
  gender                String
  profilePicture        String                 @default("default.png")
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  deletedAt             DateTime?
  status                UserStatus             @default(ACTIVE)
  Admin                 Admin?
  fcmToken              String?
  attendance            Attendance[]
  AuditLog              AuditLog[]
  Document              Document[]
  issuedBooks           LibraryBook[]          @relation("IssuedBooks")
  reservedBooks         LibraryBook[]          @relation("ReservedBooks")
  MasterAdmin           MasterAdmin?
  nonTeachingStaff      NonTeachingStaff?
  Notice                Notice[]
  receivedNotifications Notification[]         @relation("Receiver")
  sentNotifications     Notification[]         @relation("Sender")
  student               Student?
  teacher               TeachingStaff?
  role                  Role                   @relation(fields: [roleId], references: [id])
  school                School?                @relation(fields: [schoolId], references: [id])
  Application           Application[]
  StageHistory          StageHistory[]
  GmailAccount          GmailAccount[]
  CertificateTemplate   CertificateTemplate[]
  CertificateGenerated  CertificateGenerated[]
  DocumentTemplate      DocumentTemplate[]
  NoticeReads           NoticeRead[]           @relation("NoticeReads")
  NoticeTargets         NoticeTarget[]         @relation("NoticeTargetUser")
  approvedDiscounts     FeeDiscount[]          @relation("ApprovedDiscounts")
  collectedPayments     FeePayment[]           @relation("CollectedPayments")
  parent                Parent?

  @@index([schoolId])
  @@index([roleId])
}

// model GmailAccount {
//   id           String   @id @default(uuid())
//   userId       String   @db.Uuid
//   email        String
//   accessToken  String
//   refreshToken String
//   createdAt    DateTime @default(now())
//   updatedAt    DateTime @updatedAt

//   user User @relation(fields: [userId], references: [id])

//   @@unique([userId, email]) // A user canâ€™t have duplicate Gmail accounts
// }
model GmailAccount {
  id           String   @id @default(uuid())
  userId       String   @db.Uuid
  email        String
  accessToken  String
  refreshToken String
  name         String? // Optional: for display name
  avatar       String? // Optional: for avatar URL
  lastUsedAt   DateTime @default(now()) // NEW: Track last usage
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, email])
}

model Admin {
  userId   String @id @db.Uuid
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])
  User     User   @relation(fields: [userId], references: [id])
}

model MasterAdmin {
  userId   String @id @unique @db.Uuid
  schoolId String @unique @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])
  User     User   @relation(fields: [userId], references: [id])
}

model Student {
  userId             String  @id @db.Uuid
  classId            Int
  parentId           String? @db.Uuid
  name               String
  email              String
  dob                String
  gender             String
  admissionDate      String
  sectionId          Int
  bloodGroup         String
  rollNumber         String
  PreviousSchoolName String?

  DateOfLeaving          String?
  contactNumber          String
  Address                String
  city                   String
  state                  String
  country                String
  postalCode             String
  FatherName             String
  MotherName             String
  FatherNumber           String?
  MotherNumber           String?
  GuardianName           String?
  GuardianRelation       String?
  House                  String?
  admissionNo            String
  schoolId               String                   @db.Uuid
  academicYearId         String?                  @db.Uuid
  ExamIssue              ExamIssue[]
  examResults            ExamResult[]
  FeePayment             FeePayment[]
  FeeStructure           FeeStructure[]
  HomeworkSubmission     HomeworkSubmission[]
  AcademicYear           AcademicYear?            @relation(fields: [academicYearId], references: [id])
  class                  Class                    @relation(fields: [classId], references: [id])
  school                 School                   @relation(fields: [schoolId], references: [id])
  section                Section                  @relation(fields: [sectionId], references: [id])
  user                   User                     @relation(fields: [userId], references: [id])
  StudentFeeStructure    StudentFeeStructure[]
  StudentRouteAssignment StudentRouteAssignment[]
  CertificateGenerated   CertificateGenerated[]
  DigitalIdCard          DigitalIdCard[]
  AdmitCard              AdmitCard[]
  studentFees            StudentFee[]
  feeReminders           FeeReminder[]
  studentParentLinks     StudentParentLink[]

  @@index([classId])
  @@index([sectionId])
  @@index([parentId])
}

// ============================================
// PARENT-STUDENT LINKING SYSTEM
// ============================================

// Parent Model
model Parent {
  id              String  @id @default(uuid()) @db.Uuid
  userId          String  @unique @db.Uuid
  schoolId        String  @db.Uuid
  // Personal Information
  name            String
  email           String  @unique
  contactNumber   String  @unique
  alternateNumber String?
  // gender          String
  // Address Information
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?

  // Additional Details
  occupation    String?
  qualification String?
  annualIncome  String?
  bloodGroup    String?

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactNumber   String?
  emergencyContactRelation String?

  // System Fields
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
  status    UserStatus @default(ACTIVE)

  // Relations
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  school       School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentLinks StudentParentLink[]

  @@index([schoolId])
  @@index([contactNumber])
  @@index([email])
  @@index([userId])
}

// Bridge/Junction Model for Many-to-Many Relationship
model StudentParentLink {
  id        String @id @default(uuid()) @db.Uuid
  studentId String @db.Uuid
  parentId  String @db.Uuid

  // Relation Type
  relation ParentRelationType @default(GUARDIAN)

  // Primary Contact (one parent can be marked as primary)
  isPrimary Boolean @default(false)

  // Permissions
  canPickup      Boolean @default(true)
  canViewReports Boolean @default(true)
  canViewFees    Boolean @default(true)

  // System Fields
  linkedAt   DateTime  @default(now())
  linkedBy   String?   @db.Uuid // Admin/Staff who created the link
  verifiedAt DateTime? // When parent verified the link
  isActive   Boolean   @default(true)

  // Relations
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId]) // Prevent duplicate links
  @@index([studentId])
  @@index([parentId])
  @@index([relation])
}

// Enum for Parent Relation Types
enum ParentRelationType {
  FATHER
  MOTHER
  GUARDIAN
  GRANDFATHER
  GRANDMOTHER
  UNCLE
  AUNT
  SIBLING
  OTHER
}

model ExamSeries {
  id     Int   @id @default(autoincrement())
  examId Int
  score  Float
  exam   Exam  @relation(fields: [examId], references: [id])
}

model ExamIssue {
  id        Int      @id @default(autoincrement())
  studentId String   @db.Uuid
  issueDate DateTime
  student   Student  @relation(fields: [studentId], references: [userId])
}

model HomeworkSubmission {
  id             Int      @id @default(autoincrement())
  homeworkId     Int
  studentId      String   @db.Uuid
  submissionDate DateTime
  homework       Homework @relation(fields: [homeworkId], references: [id])
  student        Student  @relation(fields: [studentId], references: [userId])
}

model TeachingStaff {
  userId                String                  @id @db.Uuid
  departmentId          Int?
  employeeId            String
  name                  String
  designation           String
  gender                String
  age                   String
  bloodGroup            String
  contactNumber         String
  dob                   String
  email                 String
  address               String
  City                  String
  district              String?
  state                 String?
  country               String?
  PostalCode            String?
  subjectId             Int?
  schoolId              String                  @db.Uuid
  academicYearId        String                  @db.Uuid
  Class                 Class[]
  homework              Homework[]
  Section               Section[]
  SectionSubjectTeacher SectionSubjectTeacher[]
  AcademicYear          AcademicYear            @relation(fields: [academicYearId], references: [id])
  department            Department?             @relation(fields: [departmentId], references: [id])
  school                School                  @relation(fields: [schoolId], references: [id])
  user                  User                    @relation(fields: [userId], references: [id])
  subjects              Subject[]               @relation("SubjectToTeachingStaff")

  @@index([departmentId])
}

model NonTeachingStaff {
  userId         String       @id @db.Uuid
  departmentId   Int?
  employeeId     String
  name           String
  designation    String
  gender         String
  dob            String
  age            String
  bloodGroup     String
  contactNumber  String
  email          String
  address        String
  City           String
  district       String?
  state          String?
  country        String?
  PostalCode     String?
  schoolId       String       @db.Uuid
  academicYearId String       @db.Uuid
  AcademicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  department     Department?  @relation(fields: [departmentId], references: [id])
  school         School       @relation(fields: [schoolId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([departmentId])
}

model Class {
  id                  Int                  @id @default(autoincrement())
  schoolId            String               @db.Uuid
  className           String
  capacity            Int?
  teachingStaffUserId String?              @db.Uuid
  academicYearId      String?              @db.Uuid
  AcademicYear        AcademicYear?        @relation(fields: [academicYearId], references: [id])
  school              School               @relation(fields: [schoolId], references: [id])
  TeachingStaff       TeachingStaff?       @relation(fields: [teachingStaffUserId], references: [userId])
  FeeStructure        FeeStructure[]
  homework            Homework[]
  NoticeTarget        NoticeTarget[]
  sections            Section[]
  students            Student[]
  subjects            Subject[]
  Syllabi             Syllabus[]
  Assignment          Assignment[]
  globalFeeStructures GlobalFeeStructure[]

  @@unique([id, schoolId])
  @@index([schoolId])
}

model Section {
  id                  Int                     @id @default(autoincrement())
  name                String
  classId             Int
  schoolId            String                  @db.Uuid
  teachingStaffUserId String?                 @db.Uuid
  NoticeTarget        NoticeTarget[]
  class               Class                   @relation(fields: [classId], references: [id])
  supervisor          TeachingStaff?          @relation(fields: [teachingStaffUserId], references: [userId])
  subjectTeachers     SectionSubjectTeacher[]
  students            Student[]
  timetables          Timetable[]

  @@unique([classId, name])
  @@index([classId])
}

model SectionSubjectTeacher {
  id                  Int           @id @default(autoincrement())
  sectionId           Int
  subjectId           Int
  teachingStaffUserId String        @db.Uuid
  section             Section       @relation(fields: [sectionId], references: [id])
  subject             Subject       @relation(fields: [subjectId], references: [id])
  teacher             TeachingStaff @relation(fields: [teachingStaffUserId], references: [userId])

  @@unique([sectionId, subjectId])
}

model Timetable {
  id        String   @id @default(uuid()) @db.Uuid
  sectionId Int
  day       String
  period    Int
  subject   String
  teacher   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  section   Section  @relation(fields: [sectionId], references: [id])
}

model Document {
  id          Int          @id @default(autoincrement())
  userId      String       @db.Uuid
  title       String
  description String?
  fileUrl     String
  type        DocumentType @default(OTHER)
  isPublic    Boolean      @default(false)
  uploadedAt  DateTime     @default(now())
  user        User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
}

model Subject {
  id                    Int                     @id @default(autoincrement())
  subjectName           String
  subjectCode           String?
  classId               Int
  departmentId          Int
  examResults           ExamResult[]
  homework              Homework[]
  SectionSubjectTeacher SectionSubjectTeacher[]
  class                 Class                   @relation(fields: [classId], references: [id])
  department            Department              @relation(fields: [departmentId], references: [id])
  Teacher               TeachingStaff[]         @relation("SubjectToTeachingStaff")

  @@index([classId])
  @@index([departmentId])
}

model Department {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  NonTeachingStaff NonTeachingStaff[]
  subjects         Subject[]
  teachers         TeachingStaff[]
}

model Homework {
  id                 Int                  @id @default(autoincrement())
  classId            Int
  subjectId          Int
  teacherId          String               @db.Uuid
  class              Class                @relation(fields: [classId], references: [id])
  subject            Subject              @relation(fields: [subjectId], references: [id])
  teacher            TeachingStaff        @relation(fields: [teacherId], references: [userId])
  HomeworkSubmission HomeworkSubmission[]

  @@index([classId])
  @@index([subjectId])
  @@index([teacherId])
}

model Exam {
  id         Int          @id @default(autoincrement())
  schoolId   String       @db.Uuid
  title      String
  createdAt  DateTime     @default(now())
  school     School       @relation(fields: [schoolId], references: [id])
  results    ExamResult[]
  examSeries ExamSeries[]
  AdmitCard  AdmitCard[]

  @@index([schoolId])
}

model ExamResult {
  id        Int     @id @default(autoincrement())
  examId    Int
  studentId String  @db.Uuid
  subjectId Int
  exam      Exam    @relation(fields: [examId], references: [id])
  student   Student @relation(fields: [studentId], references: [userId])
  subject   Subject @relation(fields: [subjectId], references: [id])

  @@unique([examId, studentId, subjectId])
  @@index([examId])
  @@index([studentId])
  @@index([subjectId])
}

model AcademicYear {
  id                  String               @id @default(uuid()) @db.Uuid
  name                String
  startDate           DateTime
  endDate             DateTime
  isActive            Boolean              @default(false)
  createdAt           DateTime             @default(now())
  schoolId            String               @db.Uuid
  school              School               @relation(fields: [schoolId], references: [id])
  classes             Class[]
  FeePayments         FeePayment[]
  FeeStructures       FeeStructure[]
  NonTeachingStaff    NonTeachingStaff[]
  students            Student[]
  Syllabus            Syllabus[]
  TeachingStaff       TeachingStaff[]
  DigitalIdCard       DigitalIdCard[]
  globalFeeStructures GlobalFeeStructure[]
  studentFees         StudentFee[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model FeeStructure {
  id                  String                @id @default(uuid()) @db.Uuid
  schoolId            String?               @db.Uuid
  academicYearId      String                @db.Uuid
  issueDate           DateTime              @default(now())
  name                String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  studentUserId       String?               @db.Uuid
  classId             Int?
  mode                FeeMode               @default(MONTHLY)
  isInstallment       Boolean               @default(false)
  feeParticulars      FeeParticular[]
  FeePayments         FeePayment[]
  AcademicYear        AcademicYear          @relation(fields: [academicYearId], references: [id])
  Class               Class?                @relation(fields: [classId], references: [id])
  School              School?               @relation(fields: [schoolId], references: [id])
  Student             Student?              @relation(fields: [studentUserId], references: [userId])
  StudentFeeStructure StudentFeeStructure[]
}

model FeeParticular {
  id                   String                 @id @default(uuid()) @db.Uuid
  feeStructureId       String                 @db.Uuid
  name                 String
  defaultAmount        Float
  feeStructure         FeeStructure           @relation(fields: [feeStructureId], references: [id])
  StudentFeeParticular StudentFeeParticular[]
}

model StudentFeeStructure {
  id             String                 @id @default(uuid()) @db.Uuid
  studentId      String                 @db.Uuid
  academicYearId String                 @db.Uuid
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @default(now()) @updatedAt
  schoolId       String?                @db.Uuid
  studentUserId  String?                @db.Uuid
  feeStructureId String                 @db.Uuid
  status         String                 @default("UNPAID")
  FeePayments    FeePayment[]
  feeParticulars StudentFeeParticular[]
  feeStructure   FeeStructure           @relation(fields: [feeStructureId], references: [id])
  School         School?                @relation(fields: [schoolId], references: [id])
  Student        Student?               @relation(fields: [studentUserId], references: [userId])
}

// Link installments to specific particulars
model InstallmentParticular {
  id            String @id @default(uuid()) @db.Uuid
  installmentId String @db.Uuid
  particularId  String @db.Uuid

  // How much of this particular is in this installment
  amount     Float
  paidAmount Float @default(0)

  // Relations
  installment StudentFeeInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)
  particular  StudentFeeParticular  @relation(fields: [particularId], references: [id], onDelete: Cascade)

  @@unique([installmentId, particularId])
  @@index([installmentId])
  @@index([particularId])
}

model Attendance {
  id     Int              @id @default(autoincrement())
  userId String           @db.Uuid
  date   DateTime
  status AttendanceStatus
  user   User             @relation(fields: [userId], references: [id])

  @@unique([userId, date])
}

model Notification {
  id         Int      @id @default(autoincrement())
  senderId   String   @db.Uuid
  receiverId String   @db.Uuid
  message    String
  createdAt  DateTime @default(now())
  receiver   User     @relation("Receiver", fields: [receiverId], references: [id])
  sender     User     @relation("Sender", fields: [senderId], references: [id])

  @@index([receiverId])
  @@index([senderId])
}

model LibraryBook {
  schoolId     String    @db.Uuid
  title        String
  author       String
  ISBN         String
  category     String
  createdAt    DateTime  @default(now())
  dueAt        DateTime?
  edition      String?
  fineAmount   Float?
  issuedAt     DateTime?
  issuedToId   String?   @db.Uuid
  publisher    String
  reservedAt   DateTime?
  reservedById String?   @db.Uuid
  status       String
  updatedAt    DateTime  @updatedAt
  id           String    @id @default(uuid()) @db.Uuid
  issuedTo     User?     @relation("IssuedBooks", fields: [issuedToId], references: [id])
  reservedBy   User?     @relation("ReservedBooks", fields: [reservedById], references: [id])
  school       School    @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
  @@index([status])
  @@index([ISBN])
}

model Upload {
  id        String   @id @default(uuid())
  userId    String?
  fileUrl   String
  fileName  String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())
  School    School?  @relation(fields: [schoolId], references: [id])
  schoolId  String?  @db.Uuid
}

model Gallery {
  id       Int    @id @default(autoincrement())
  schoolId String @db.Uuid
  title    String
  school   School @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
}

// certificates generation models

// Add to your existing schema.prisma

model Signature {
  id                 String              @id @default(uuid()) @db.Uuid
  schoolId           String              @db.Uuid
  name               String
  designation        String?
  imageUrl           String
  isDefault          Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  templateSignatures TemplateSignature[]

  @@index([schoolId])
}

model Stamp {
  id             String          @id @default(uuid()) @db.Uuid
  schoolId       String          @db.Uuid
  name           String
  imageUrl       String
  position       Json? // { x: number, y: number }
  forDocument    String? // e.g., 'certificate', 'idcard'
  isDefault      Boolean         @default(false)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  templateStamps TemplateStamp[]

  @@index([schoolId])
}

model TemplateSignature {
  id           String              @id @default(uuid()) @db.Uuid
  templateId   String              @db.Uuid
  signatureId  String              @db.Uuid
  x            Float
  y            Float
  scale        Float               @default(1.0)
  rotation     Float               @default(0.0)
  templateType String // e.g., 'certificate', 'idcard'
  createdAt    DateTime            @default(now())
  template     CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade) // Assume CertificateTemplate; adjust for other templates
  signature    Signature           @relation(fields: [signatureId], references: [id], onDelete: Cascade)
}

model TemplateStamp {
  id           String              @id @default(uuid()) @db.Uuid
  templateId   String              @db.Uuid
  stampId      String              @db.Uuid
  x            Float
  y            Float
  scale        Float               @default(1.0)
  rotation     Float               @default(0.0)
  templateType String // e.g., 'certificate', 'idcard'
  createdAt    DateTime            @default(now())
  template     CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade) // Adjust for other
  stamp        Stamp               @relation(fields: [stampId], references: [id], onDelete: Cascade)
}

model QrVerificationSettings {
  id       String @id @default(cuid())
  schoolId String @db.Uuid // CRITICAL: @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  // Enablement
  enabledForCertificates Boolean @default(true)
  enabledForIdCards      Boolean @default(true)
  enabledForAdmitCards   Boolean @default(false)

  // Data Encoding
  encodeStudentId       Boolean @default(true)
  encodeCertificateId   Boolean @default(true)
  encodeIssueDate       Boolean @default(true)
  encodeSchoolId        Boolean @default(true)
  encodeVerificationUrl Boolean @default(true)
  customFields          Json?

  // Placement
  qrPlacementX Float @default(500)
  qrPlacementY Float @default(720)
  qrSize       Float @default(120)

  // Design
  qrColor              String  @default("#000000")
  qrBackground         String  @default("#FFFFFF")
  errorCorrectionLevel String  @default("M")
  logoOverlayUrl       String?

  // Verification Portal
  verificationBaseUrl String  @default("https://your-school.com/verify")
  portalTitle         String  @default("Verify Certificate")
  portalLogoUrl       String?
  portalPrimaryColor  String  @default("#1e40af")

  // Security
  useHashEncryption Boolean @default(true)
  hashAlgorithm     String  @default("SHA256")
  qrValidityDays    Int?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([schoolId])
}

model PdfExportSettings {
  id       String @id @default(cuid())
  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id])

  // Page Layout
  paperSize    String @default("A4") // A4, A5, Letter, Custom
  customWidth  Float? // mm
  customHeight Float? // mm
  orientation  String @default("portrait") // portrait, landscape
  marginTop    Float  @default(20) // mm
  marginBottom Float  @default(20) // mm
  marginLeft   Float  @default(20) // mm
  marginRight  Float  @default(20) // mm

  // Output Quality
  resolution  String  @default("standard") // standard, high, ultra
  compression String  @default("medium") // low, medium, high
  embedFonts  Boolean @default(true)

  // Branding & Header/Footer
  headerImageUrl    String?
  footerImageUrl    String?
  schoolLogoUrl     String?
  watermarkType     String  @default("none") // none, text, image
  watermarkText     String?
  watermarkImageUrl String?
  footerText        String?
  pageNumbering     Boolean @default(true)

  // Security & Protection
  passwordProtect    Boolean @default(false)
  password           String? // Encrypted in production
  disablePrint       Boolean @default(false)
  disableCopy        Boolean @default(false)
  digitalSignature   Boolean @default(false)
  saveAsDefault      Boolean @default(false)
  // File Handling
  fileNameFormat     String  @default("{student_name}_{document_type}.pdf")
  autoSaveLocation   String  @default("cloud") // cloud, local
  bulkExportBehavior String  @default("separate") // combine, separate

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([schoolId])
}

// model CertificateTemplate {
//   id                String                 @id @default(uuid()) @db.Uuid
//   name              String
//   description       String?
//   type              String // character, bonafide, transfer, etc.
//   schoolId          String                 @db.Uuid
//   school            School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   layoutConfig      Json // Stores ALL design settings
//   createdById       String?                @db.Uuid
//   createdBy         User?                  @relation(fields: [createdById], references: [id])
//   isDefault         Boolean                @default(false)
//   createdAt         DateTime               @default(now())
//   updatedAt         DateTime               @updatedAt
//   certificates      CertificateGenerated[]
//   TemplateSignature TemplateSignature[]
//   TemplateStamp     TemplateStamp[]

//   @@index([schoolId])
//   @@index([type])
// }
model CertificateTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  type         String // character, bonafide, transfer, etc.
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  layoutConfig Json // Stores design settings for signatures/stamps
  createdById  String?  @db.Uuid
  createdBy    User?    @relation(fields: [createdById], references: [id])
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations for signatures/stamps positioning
  templateSignatures TemplateSignature[]
  templateStamps     TemplateStamp[]
  DocumentTemplate   DocumentTemplate[]

  @@index([schoolId])
  @@index([type])
}

// DocumentTemplate: Main template with all content
model DocumentTemplate {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  templateType String // 'certificate', 'idcard', 'admitcard'
  subType      String // specific type (character, student, midterm, etc.)
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  layoutConfig Json
  createdById  String?  @db.Uuid
  createdBy    User?    @relation(fields: [createdById], references: [id])
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ADDED: Link to CertificateTemplate for signatures/stamps
  certificateTemplateId String?              @db.Uuid
  certificateTemplate   CertificateTemplate? @relation(fields: [certificateTemplateId], references: [id])

  // Generated certificates reference this
  certificatesGenerated CertificateGenerated[]

  @@unique([schoolId, templateType, subType, name])
  @@index([schoolId])
  @@index([templateType])
  @@index([subType])
}

// model DocumentTemplate {
//   id                   String                 @id @default(uuid()) @db.Uuid
//   name                 String
//   description          String?
//   templateType         String // 'certificate', 'idcard', 'admitcard'
//   subType              String // specific type (character, student, midterm, etc.)
//   schoolId             String                 @db.Uuid
//   school               School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   layoutConfig         Json
//   createdById          String?                @db.Uuid
//   createdBy            User?                  @relation(fields: [createdById], references: [id])
//   isDefault            Boolean                @default(false)
//   isActive             Boolean                @default(true)
//   createdAt            DateTime               @default(now())
//   updatedAt            DateTime               @updatedAt
//   CertificateGenerated CertificateGenerated[]

//   @@unique([schoolId, templateType, subType, name])
//   @@index([schoolId])
//   @@index([templateType])
//   @@index([subType])
// }

// model CertificateGenerated {
//   id                String              @id @default(uuid()) @db.Uuid
//   certificateNumber String              @unique
//   templateId        String              @db.Uuid
//   template          CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
//   studentId         String              @db.Uuid
//   student           Student             @relation(fields: [studentId], references: [userId], onDelete: Cascade)
//   schoolId          String              @db.Uuid
//   school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
//   issuedById        String?             @db.Uuid
//   issuedBy          User?               @relation(fields: [issuedById], references: [id])
//   issueDate         DateTime            @default(now())
//   customFields      Json // Additional dynamic values like event name, remarks, etc.
//   fileUrl           String? // If PDF is stored
//   status            String              @default("issued") // issued, pending, revoked
//   createdAt         DateTime            @default(now())

//   @@index([schoolId])
//   @@index([studentId])
//   @@index([templateId])
//   @@index([status])
// }
model CertificateGenerated {
  id                String @id @default(uuid()) @db.Uuid
  certificateNumber String @unique

  // Reference to DocumentTemplate ONLY
  templateId String           @db.Uuid
  template   DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  studentId String  @db.Uuid
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  schoolId String @db.Uuid
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  issuedById String? @db.Uuid
  issuedBy   User?   @relation(fields: [issuedById], references: [id])

  issueDate    DateTime @default(now())
  customFields Json
  fileUrl      String?
  status       String   @default("issued")
  createdAt    DateTime @default(now())

  @@index([schoolId])
  @@index([studentId])
  @@index([templateId])
  @@index([status])
}

model DigitalIdCard {
  id             String        @id @default(uuid()) @db.Uuid
  studentId      String        @db.Uuid
  student        Student       @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  schoolId       String        @db.Uuid
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYearId String?       @db.Uuid
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  qrCodeUrl      String?
  layoutConfig   Json
  generatedAt    DateTime      @default(now())

  @@index([schoolId])
  @@index([studentId])
}

model AdmitCard {
  id           String   @id @default(uuid()) @db.Uuid
  studentId    String   @db.Uuid
  student      Student  @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  examId       Int
  exam         Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  seatNumber   String
  center       String?
  layoutConfig Json
  issueDate    DateTime @default(now())

  @@index([schoolId])
  @@index([studentId])
  @@index([examId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    String?     @db.Uuid
  action    AuditAction
  tableName String
  rowId     String
  timestamp DateTime    @default(now())
  oldData   Json?
  newData   Json?
  error     String?
  user      User?       @relation(fields: [userId], references: [id])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ERROR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LEFT
  DISABLED
  BANNED
}

enum DocumentType {
  NOTE
  ASSIGNMENT
  CERTIFICATE
  REPORT
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HOLIDAY
}

enum StageName {
  REVIEW
  TEST_INTERVIEW
  OFFER
  ENROLLED
  REJECTED
}

// ============================================
// ENHANCED FEE MANAGEMENT SYSTEM SCHEMA
// ============================================

// Global Fee Structure (Template by Class)
model GlobalFeeStructure {
  id             String   @id @default(uuid()) @db.Uuid
  schoolId       String   @db.Uuid
  academicYearId String   @db.Uuid
  classId        Int
  name           String // e.g., "Class 10 Annual Fees 2024-25"
  description    String?
  mode           FeeMode  @default(YEARLY)
  totalAmount    Float // Total calculated amount
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  school           School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear     AcademicYear          @relation(fields: [academicYearId], references: [id])
  class            Class                 @relation(fields: [classId], references: [id])
  particulars      GlobalFeeParticular[]
  studentFees      StudentFee[]
  installmentRules FeeInstallmentRule[]

  @@unique([schoolId, academicYearId, classId])
  @@index([schoolId, academicYearId])
  @@index([classId])
}

// Fee Components (Tuition, Books, Transport, etc.)
model GlobalFeeParticular {
  id                   String      @id @default(uuid()) @db.Uuid
  globalFeeStructureId String      @db.Uuid
  name                 String // "Tuition Fee", "Transport Fee", etc.
  amount               Float
  isOptional           Boolean     @default(false)
  category             FeeCategory @default(TUITION)
  displayOrder         Int         @default(0)

  globalFeeStructure GlobalFeeStructure     @relation(fields: [globalFeeStructureId], references: [id], onDelete: Cascade)
  studentParticulars StudentFeeParticular[]

  @@index([globalFeeStructureId])
}

// Installment Rules (How to break down payments)
model FeeInstallmentRule {
  id                   String   @id @default(uuid()) @db.Uuid
  globalFeeStructureId String   @db.Uuid
  installmentNumber    Int // 1, 2, 3, 4...
  dueDate              DateTime
  percentage           Float // Percentage of total
  amount               Float // Fixed amount (calculated)
  lateFeeAmount        Float    @default(0)
  lateFeeAfterDays     Int      @default(0)

  globalFeeStructure  GlobalFeeStructure      @relation(fields: [globalFeeStructureId], references: [id], onDelete: Cascade)
  studentInstallments StudentFeeInstallment[]

  @@unique([globalFeeStructureId, installmentNumber])
  @@index([globalFeeStructureId])
  @@index([dueDate])
}

// Student Fee Assignment (Individual Student's Fee)
model StudentFee {
  id                   String  @id @default(uuid()) @db.Uuid
  studentId            String  @db.Uuid
  schoolId             String  @db.Uuid
  academicYearId       String  @db.Uuid
  globalFeeStructureId String? @db.Uuid // Null for custom fees

  // Amounts
  originalAmount Float // Before any discounts
  discountAmount Float @default(0)
  finalAmount    Float // After discounts
  paidAmount     Float @default(0)
  balanceAmount  Float // Remaining

  // Status
  status   FeeStatus @default(UNPAID)
  isCustom Boolean   @default(false) // Custom fee structure

  // Dates
  assignedDate    DateTime  @default(now())
  lastPaymentDate DateTime?

  // Relations
  student            Student             @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  school             School              @relation(fields: [schoolId], references: [id])
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id])
  globalFeeStructure GlobalFeeStructure? @relation(fields: [globalFeeStructureId], references: [id])

  particulars  StudentFeeParticular[]
  installments StudentFeeInstallment[]
  payments     FeePayment[]
  discounts    FeeDiscount[]

  @@unique([studentId, academicYearId])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@index([studentId])
}

// Individual Fee Components for Each Student
model StudentFeeParticular {
  id                 String    @id @default(uuid()) @db.Uuid
  studentFeeId       String    @db.Uuid
  globalParticularId String?   @db.Uuid
  name               String
  amount             Float
  paidAmount         Float     @default(0)
  status             FeeStatus @default(UNPAID)

  studentFee            StudentFee              @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  globalParticular      GlobalFeeParticular?    @relation(fields: [globalParticularId], references: [id])
  feeParticular         FeeParticular?          @relation(fields: [feeParticularId], references: [id])
  feeParticularId       String?                 @db.Uuid
  studentFeeStructure   StudentFeeStructure?    @relation(fields: [studentFeeStructureId], references: [id])
  studentFeeStructureId String?                 @db.Uuid
  installmentBreakdowns InstallmentParticular[]

  @@index([studentFeeId])
  @@index([status])
}

// Student Installments (Payment Schedule)
model StudentFeeInstallment {
  id                String            @id @default(uuid()) @db.Uuid
  studentFeeId      String            @db.Uuid
  installmentRuleId String?           @db.Uuid
  installmentNumber Int
  dueDate           DateTime
  amount            Float
  paidAmount        Float             @default(0)
  status            InstallmentStatus @default(PENDING)
  lateFee           Float             @default(0)
  isOverdue         Boolean           @default(false)
  paidDate          DateTime?

  studentFee           StudentFee              @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  installmentRule      FeeInstallmentRule?     @relation(fields: [installmentRuleId], references: [id])
  payments             FeePaymentInstallment[]
  particularBreakdowns InstallmentParticular[]

  @@unique([studentFeeId, installmentNumber])
  @@index([studentFeeId])
  @@index([status])
  @@index([dueDate])
  @@index([isOverdue])
}

// Discount Management
model FeeDiscount {
  id           String       @id @default(uuid()) @db.Uuid
  studentFeeId String       @db.Uuid
  reason       String
  discountType DiscountType @default(FIXED)
  value        Float // Percentage or Fixed Amount
  amount       Float // Calculated discount amount
  approvedBy   String?      @db.Uuid
  approvedDate DateTime?
  remarks      String?
  createdAt    DateTime     @default(now())

  studentFee StudentFee @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  approver   User?      @relation("ApprovedDiscounts", fields: [approvedBy], references: [id])

  @@index([studentFeeId])
}

// Payment Records
model FeePayment {
  id             String @id @default(uuid()) @db.Uuid
  studentFeeId   String @db.Uuid
  studentId      String @db.Uuid
  schoolId       String @db.Uuid
  academicYearId String @db.Uuid

  // Payment Details
  amount          Float
  paymentMode     PaymentMode
  paymentMethod   PaymentMethod @default(CASH)
  transactionId   String?       @unique
  referenceNumber String?

  // Gateway Details (for online payments)
  gatewayName      String? // "Razorpay", "Stripe", etc.
  gatewayOrderId   String?
  gatewayPaymentId String?
  gatewayResponse  Json? // Store full gateway response

  // Status
  status        PaymentStatus @default(PENDING)
  failureReason String?

  // Dates
  paymentDate DateTime  @default(now())
  clearedDate DateTime?

  // Receipt
  receiptNumber String  @unique
  receiptUrl    String?

  // Collection Details
  collectedBy String? @db.Uuid
  remarks     String?

  // Relations
  studentFee   StudentFee   @relation(fields: [studentFeeId], references: [id])
  student      Student      @relation(fields: [studentId], references: [userId])
  school       School       @relation(fields: [schoolId], references: [id])
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  collector    User?        @relation("CollectedPayments", fields: [collectedBy], references: [id])

  installmentPayments   FeePaymentInstallment[]
  feeStructure          FeeStructure?           @relation(fields: [feeStructureId], references: [id])
  feeStructureId        String?                 @db.Uuid
  studentFeeStructure   StudentFeeStructure?    @relation(fields: [studentFeeStructureId], references: [id])
  studentFeeStructureId String?                 @db.Uuid

  @@index([studentFeeId])
  @@index([studentId])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@index([paymentDate])
  @@index([receiptNumber])
}

// Link Payments to Installments
model FeePaymentInstallment {
  id            String @id @default(uuid()) @db.Uuid
  paymentId     String @db.Uuid
  installmentId String @db.Uuid
  amount        Float // Amount allocated to this installment

  payment     FeePayment            @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  installment StudentFeeInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([installmentId])
}

// Payment Reminders
model FeeReminder {
  id            String       @id @default(uuid()) @db.Uuid
  studentId     String       @db.Uuid
  studentFeeId  String       @db.Uuid
  reminderType  ReminderType @default(DUE_SOON)
  message       String
  sentDate      DateTime     @default(now())
  scheduledDate DateTime
  status        String       @default("SENT") // SENT, FAILED, PENDING
  channel       String       @default("EMAIL") // EMAIL, SMS, APP

  student Student @relation(fields: [studentId], references: [userId])

  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
}

// ============================================
// ENUMS
// ============================================

enum FeeCategory {
  TUITION
  ADMISSION
  EXAMINATION
  LIBRARY
  LABORATORY
  SPORTS
  TRANSPORT
  HOSTEL
  MISCELLANEOUS
  DEVELOPMENT
  CAUTION_MONEY
}

enum FeeMode {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  ONE_TIME
}

enum FeeStatus {
  PAID
  UNPAID
  PARTIAL
  OVERDUE
  WAIVED
}

enum InstallmentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  WAIVED
}

enum DiscountType {
  PERCENTAGE
  FIXED
  SCHOLARSHIP
  SIBLING
  STAFF_WARD
  MERIT
}

enum PaymentMode {
  ONLINE
  OFFLINE
}

enum PaymentMethod {
  CASH
  CHEQUE
  CARD
  UPI
  NET_BANKING
  WALLET
  DEMAND_DRAFT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

enum ReminderType {
  DUE_SOON
  OVERDUE
  PAYMENT_CONFIRMATION
  INSTALLMENT_DUE
}
