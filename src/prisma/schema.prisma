// Redesign of your schema.prisma to optimize relations and performance
// All fields and entities are preserved, structure is improved for efficient querying

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  MASTERADMIN
  DIRECTOR
  ADMIN
  TEACHING_STAFF
  STUDENT
  PARENT
  NON_TEACHING_STAFF
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  LEAVE
}

enum FeeStatus {
  PAID
  PENDING
  OVERDUE
}

model School {
  id               String    @id @default(cuid())
  name             String
  address          String
  email            String    @unique
  phone            String
  logoUrl          String?
  subscriptionType String
  language         String
  currentDomain    String?
  customDomain     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  Admin            Admin[]
  Staff            Staff[]
  Teacher          Teacher[]
  Student          Student[]
  Class            Class[]

  @@index([email])
  @@index([currentDomain])
  @@index([createdAt])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student?
  teacher Teacher?
  parent  Parent?
  staff   Staff?
  admin   Admin?

  @@index([role])
  @@index([createdAt])
}

model Admin {
  id       String @id @default(cuid())
  userId   String @unique
  schoolId String
  user     User   @relation(fields: [userId], references: [id])
  school   School @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
}

model Parent {
  id       String    @id @default(cuid())
  userId   String    @unique
  user     User      @relation(fields: [userId], references: [id])
  students Student[]
}

model Staff {
  id          String             @id @default(cuid())
  userId      String             @unique
  schoolId    String
  name        String
  designation String
  department  String
  gender      Gender
  contact     String
  address     String
  user        User               @relation(fields: [userId], references: [id])
  school      School             @relation(fields: [schoolId], references: [id])
  documents   EmployeeDocument[]

  @@index([schoolId])
  @@index([department])
}

model Teacher {
  id          String             @id @default(cuid())
  userId      String             @unique
  employeeId  String             @unique
  schoolId    String
  department  String
  designation String
  gender      Gender
  user        User               @relation(fields: [userId], references: [id])
  school      School             @relation(fields: [schoolId], references: [id])
  subjects    Subject[]
  classes     Class[]
  documents   EmployeeDocument[]

  @@index([schoolId])
  @@index([employeeId])
}

model Student {
  id                 String   @id @default(cuid())
  userId             String   @unique
  admissionNo        String   @unique
  studentName        String
  studentpfp         String?
  classId            String
  session            String
  adhaarNo           String?
  fatherName         String
  motherName         String
  fatherMobileNumber String?
  motherMobileNumber String?
  guardianName       String?
  guardianRelation   String?
  guardianMobileNo   String?
  dob                DateTime
  gender             Gender
  parentId           String?
  address            String
  bloodGroup         String?
  schoolId           String
  createdAt          DateTime @default(now())

  user                 User                  @relation(fields: [userId], references: [id])
  class                Class                 @relation(fields: [classId], references: [id])
  parent               Parent?               @relation(fields: [parentId], references: [id])
  school               School                @relation(fields: [schoolId], references: [id])
  attendance           Attendance[]
  grades               Grade[]
  feePayments          FeePayment[]
  documents            StudentDocument[]
  transportAssignments TransportAssignment[]
  libraryBooks         LibraryBook[]         @relation("IssuedBooks")

  @@index([schoolId])
  @@index([admissionNo])
  @@index([createdAt])
}

model StudentDocument {
  id         String   @id @default(cuid())
  studentId  String
  title      String
  fileUrl    String
  fileType   String
  uploadedAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([uploadedAt])
}

model EmployeeDocument {
  id         String   @id @default(cuid())
  title      String
  fileUrl    String
  fileType   String
  uploadedAt DateTime @default(now())
  teacherId  String?
  staffId    String?

  teacher Teacher? @relation(fields: [teacherId], references: [id])
  staff   Staff?   @relation(fields: [staffId], references: [id])

  @@index([uploadedAt])
}

model Class {
  id        String  @id @default(cuid())
  name      String
  section   String
  teacherId String?
  schoolId  String

  students  Student[]
  timetable Timetable[]
  exams     Exam[]
  teacher   Teacher?    @relation(fields: [teacherId], references: [id])
  school    School      @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
}

model Subject {
  id        String @id @default(cuid())
  name      String
  code      String
  teacherId String

  teacher   Teacher     @relation(fields: [teacherId], references: [id])
  timetable Timetable[]

  @@index([teacherId])
}

model Timetable {
  id        String   @id @default(cuid())
  classId   String
  subjectId String
  day       String
  startTime DateTime
  endTime   DateTime

  class   Class   @relation(fields: [classId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])

  @@index([classId])
  @@index([day])
}

model Attendance {
  id        String           @id @default(cuid())
  studentId String
  date      DateTime
  status    AttendanceStatus

  student Student @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([date])
}

model Exam {
  id      String   @id @default(cuid())
  name    String
  classId String
  date    DateTime

  class  Class   @relation(fields: [classId], references: [id])
  grades Grade[]

  @@index([classId])
  @@index([date])
}

model Grade {
  id        String @id @default(cuid())
  studentId String
  examId    String
  subject   String
  marks     Float

  student Student @relation(fields: [studentId], references: [id])
  exam    Exam    @relation(fields: [examId], references: [id])

  @@index([studentId])
  @@index([examId])
}

model FeePayment {
  id        String    @id @default(cuid())
  studentId String
  amount    Float
  status    FeeStatus
  dueDate   DateTime
  paidDate  DateTime?

  student Student @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([status])
  @@index([dueDate])
}

model LibraryBook {
  id          String  @id @default(cuid())
  title       String
  author      String
  isbn        String
  category    String
  isAvailable Boolean @default(true)
  issuedToId  String?

  issuedTo   Student?  @relation("IssuedBooks", fields: [issuedToId], references: [id])
  issuedDate DateTime?
  dueDate    DateTime?

  @@index([category])
  @@index([issuedToId])
}

model TransportRoute {
  id        String @id @default(cuid())
  routeName String
  driver    String
  busNumber String

  students TransportAssignment[]
}

model TransportAssignment {
  id        String @id @default(cuid())
  studentId String
  routeId   String
  stopName  String

  student Student        @relation(fields: [studentId], references: [id])
  route   TransportRoute @relation(fields: [routeId], references: [id])

  @@index([routeId])
  @@index([studentId])
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String
  date        DateTime
  createdBy   String

  @@index([date])
}

model Notification {
  id      String   @id @default(cuid())
  title   String
  message String
  date    DateTime
  target  Role

  @@index([target])
  @@index([date])
}
